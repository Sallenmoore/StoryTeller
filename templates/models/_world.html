{% import "shared/_form.html" as form_components %}
{% import "shared/_display.html" as display_components %}
{% import "shared/_icons.html" as icon_components %}
{% import "shared/_history.html" as history_components %}
{% import "shared/_details.html" as details_components %}
{% import "shared/_timeline.html" as timeline_components %}
{% import "shared/_journal.html" as journal_components %}
{% import "shared/_stories.html" as stories_components %}
{% import "shared/_campaigns.html" as campaigns_components %}
{% import "shared/_associations.html" as associations_components %}
{% import "shared/_map.html" as map_components %}
{% import "shared/_jobs.html" as jobs_components %}
{% import "manage/_world.html" as manage_world_components %}
{% import "manage/_story.html" as manage_story_components %}
{% import "manage/_campaign.html" as manage_campaign_components %}
{% import "manage/_gmscreen.html" as manage_screen_components %}
{% import "shared/_title.html" as title_components %}

{% macro index(user, obj) -%}
{{history(user, obj)}}
{%- endmacro %}

{% macro menu(user, obj) -%}
<ul class="menu__list">
    <li>
        <a href="" class="menu-anchor"
           hx-get="/api/{{obj.path}}/details" hx-target="#page-content"
           hx-indicator="#request-indicator" hx-swap="innerHTML show:#page-content:top"
           hx-push-url="/{{obj.path}}/details">
            <div class="row">
                <div id='menu-details-anchor' class="column is-3 is-mobile-shrink">
                    {{icon_components.details(size="1rem")}}
                </div>
                <script>
                    tippy('#menu-details-anchor', {
                        content: 'Details',
                        placement: 'right',
                        allowHTML: true,
                        arrow: false,
                        animation: 'perspective-extreme',

                    });
                </script>
                <div
                     class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                    <span>Details</span>
                </div>
            </div>
        </a>
    </li>
    <li>
        <a href="" class="menu-anchor"
           hx-get="/api/{{obj.path}}/history"
           hx-target="#page-content"
           hx-indicator="#request-indicator" hx-swap="innerHTML show:#page-content:top"
           hx-push-url="/{{obj.path}}/history">
            <div class="row">
                <div id='menu-history-anchor' class="column is-3 is-mobile-shrink">
                    {{icon_components.history(size="1rem")}}
                </div>
                <script>
                    tippy('#menu-history-anchor', {
                        content: 'History',
                        placement: 'right',
                        allowHTML: true,
                        arrow: false,
                        animation: 'perspective-extreme',

                    });
                </script>
                <div class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                    <span>History</span>
                </div>
            </div>
        </a>
    </li>
    <li>
        <a href="" class="menu-anchor"
           hx-get="/api/{{obj.path}}/timeline"
           hx-target="#page-content"
           hx-indicator="#request-indicator" hx-swap="innerHTML show:#page-content:top"
           hx-push-url="/{{obj.path}}/timeline">
            <div class="row">
                <div id='menu-timeline-anchor' class="column is-3 is-mobile-shrink">
                    {{icon_components.timeline(size="1rem")}}
                </div>
                <script>
                    tippy('#menu-timeline-anchor', {
                        content: 'Timeline',
                        placement: 'right',
                        allowHTML: true,
                        arrow: false,
                        animation: 'perspective-extreme',

                    });
                </script>
                <div
                     class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                    <span>Timeline</span>
                </div>
            </div>
        </a>
    </li>
    <li>
        <a href="" class="menu-anchor"
           hx-get="/api/{{obj.path}}/campaigns"
           hx-target="#page-content"
           hx-indicator="#request-indicator"
           hx-swap="innerHTML show:#page-content:top"
           hx-push-url="/{{obj.path}}/campaigns">
            <div class="row">
                <div id='menu-campaigns-anchor' class="column is-3 is-mobile-shrink">
                    {{icon_components.campaigns(size="1rem")}}
                </div>
                <script>
                    tippy('#menu-campaigns-anchor', {
                        content: 'Campaigns',
                        placement: 'right',
                        allowHTML: true,
                        arrow: false,
                        animation: 'perspective-extreme',

                    });
                </script>
                <div class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                    <span>Campaigns</span>
                </div>
            </div>
        </a>
    </li>
    {% if user.world_user(obj) %}
    <li>
        <a href="" class="menu-anchor"
           hx-get="/api/{{obj.path}}/stories"
           hx-target="#page-content"
           hx-indicator="#request-indicator"
           hx-swap="innerHTML show:#page-content:top"
           hx-push-url="/{{obj.path}}/stories">
            <div class="row">
                <div id='menu-stories-anchor' class="column is-3 is-mobile-shrink">
                    {{icon_components.story(size="1rem")}}
                </div>
                <script>
                    tippy('#menu-stories-anchor', {
                        content: 'Stories',
                        placement: 'right',
                        allowHTML: true,
                        arrow: false,
                        animation: 'perspective-extreme',

                    });
                </script>
                <div
                     class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                    <span>Stories</span>
                </div>
            </div>
        </a>
    </li>
    <li>
        <a href="" class="menu-anchor"
           hx-get="/api/{{obj.path}}/journal" hx-target="#page-content"
           hx-indicator="#request-indicator" hx-swap="innerHTML show:#page-content:top"
           hx-push-url="/{{obj.path}}/journal">
            <div class="row">
                <div id='menu-journal-anchor' class="column is-3 is-mobile-shrink">
                    {{icon_components.journal(size="1rem")}}
                </div>
                <script>
                    tippy('#menu-journal-anchor', {
                        content: 'Journal',
                        placement: 'right',
                        allowHTML: true,
                        arrow: false,
                        animation: 'perspective-extreme',

                    });
                </script>
                <div
                     class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                    <span>Journal</span>
                </div>
            </div>
        </a>
    </li>
    {% endif %}
</ul>
<p class="menu__divider"></p>
<ul class="menu__list">
    <li>
        <a href="" class="menu-anchor" hx-get="/api/{{obj.path}}/map"
           hx-target="#page-content" hx-indicator="#request-indicator"
           hx-swap="innerHTML show:#page-content:top" hx-push-url="/{{obj.path}}/map">
            <div class="row">
                <div id='menu-map-anchor' class="column is-3 is-mobile-shrink">
                    {{icon_components.map(size="1rem")}}
                </div>
                <script>
                    tippy('#menu-map-anchor', {
                        content: 'Map',
                        placement: 'right',
                        allowHTML: true,
                        arrow: false,
                        animation: 'perspective-extreme',

                    });
                </script>
                <div
                     class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                    <span>Map</span>
                </div>
            </div>
        </a>
    </li>
    <li>
        <a href="" class="menu-anchor" hx-get="/api/{{obj.path}}/players" hx-target="#page-content"
           hx-indicator="#request-indicator" hx-swap="innerHTML"
           hx-push-url=" /{{obj.path}}/players">
            <div class="row">
                <div id="menu-players-anchor" class="column is-3 is-mobile-shrink">
                    {{icon_components.players(size="1rem")}}
                </div>
                <script>
                    tippy('#menu-players-anchor', {
                        content: 'Players',
                        placement: 'right',
                        allowHTML: true,
                        arrow: false,
                        animation: 'perspective-extreme',
                    });
                </script>
                <div class="column is-9 is-mobile-9 slide-it-in is-hidden menu-anchor-text">
                    <span>Players</span>
                </div>
            </div>
        </a>
    </li>
    <li>
        <a href="" class="menu-anchor"
           hx-get="/api/{{obj.path}}/jobs" hx-target="#page-content"
           hx-indicator="#request-indicator" hx-swap="innerHTML show:#page-content:top"
           hx-push-url="/{{obj.path}}/jobs">
            <div class="row">
                <div id='menu-jobs-anchor' class="column is-3 is-mobile-shrink">
                    {{icon_components.jobs(size="1rem")}}
                </div>
                <script>
                    tippy('#menu-jobs-anchor', {
                        content: 'Jobs',
                        placement: 'right',
                        arrow: false,
                        animation: 'perspective-extreme',
                    });
                </script>
                <div
                     class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                    <span>Job Board</span>
                </div>
            </div>
        </a>
    </li>
    <li>
        <a href="" class="menu-anchor"
           hx-get="/api/{{obj.path}}/lore" hx-target="#page-content"
           hx-indicator="#request-indicator" hx-swap="innerHTML show:#page-content:top"
           hx-push-url="/{{obj.path}}/lore">
            <div class="row">
                <div id='menu-lore-anchor' class="column is-3 is-mobile-shrink">
                    {{icon_components.lore(size="1rem")}}
                </div>
                <script>
                    tippy('#menu-lore-anchor', {
                        content: 'Lore',
                        placement: 'right',
                        arrow: false,
                        animation: 'perspective-extreme',
                    });
                </script>
                <div
                     class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                    <span>Lore Builder</span>
                </div>
            </div>
        </a>
    </li>
    {% if user.world_user(obj) %}
    <li>
        <a href="" class="menu-anchor" hx-post="/api/{{obj.path}}/managescreens"
           hx-target="#page-content"
           hx-indicator="#request-indicator" hx-swap="innerHTML"
           hx-push-url="/{{obj.path}}/managescreens">
            <div class="row">
                <div id='menu-manage-screens-anchor' class="column is-3 is-mobile-shrink">
                    {{icon_components.gmscreenmanage(size="1rem")}}
                </div>
                <script>
                    tippy('#menu-manage-screens-anchor', {
                        content: 'Manage Screens',
                        placement: 'right',
                        allowHTML: true,
                        arrow: false,
                        animation: 'perspective-extreme',

                    });
                </script>
                <div class="column is-9 is-mobile-9 slide-it-in is-hidden menu-anchor-text">
                    <span>GM Screen Manager</span>
                </div>
            </div>
        </a>
    </li>
    {% endif %}
</ul>
{%- endmacro %}


{% macro history(user, obj) -%}
{{title_components.object_title(user, obj)}}
{{history_components.history(user, obj)}}
{%- endmacro %}


{% macro details(user, obj) -%}
{{title_components.object_title(user, obj)}}
{{details_components.details(user, obj)}}
{%- endmacro %}


{% macro gmnotes(user, obj) -%}
<div id="gmnotes" lass="panel has-bg-dark generated-text-darkbg">
    <h3 class='has-text-center'>GM Notes</h3>
    <div class="row">
        <div class="column is-full">
            <div class="panel has-text-light">
                {{obj.description_summary | safe}}
            </div>
        </div>
        <div class="column is-full">
            <h5>Rumors</h5>
            <div class="panel has-text-light">
                <ul>
                    {% for sd in obj.rumors %}
                    <li>{{ sd | safe }}
                        <hr>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <h2 class='has-text-center' id='manage-stories'>Stories</h2>
    <ul class="has-no-list-style">
        {% for story in obj.stories %}
        <li>
            <h5>{{story.name}}</h5>{{story | safe}}
        </li>
        {% endfor %}
    </ul>
</div>
{%- endmacro %}


{% macro info(user, obj) -%}
{% if obj.current_date %}
<div class="row">
    <div class="column is-full">
        <h3 class="has-text-dark-grey has-text-center">
            Present Date:
            {{obj.current_date}}
        </h3>
    </div>
</div>
{% endif %}
<hr>
<h2 class='has-text-center' id='manage-factions'>Faction Control</h2>
<div class="row">
    {% for region in obj.regions %}
    <div class="column is-2">
        <div class="panel has-bg-screen is-full">
            {{display_components.object_display(region, type=False) | safe }}
            <h6 class="has-text-white has-text-center">
                {{(region.owner and region.owner.name) or "Unknown"}}
            </h6>
        </div>
    </div>
    {% endfor %}
</div>
{%- endmacro %}


{% macro timeline(user, obj)%}
{{title_components.object_title(user, obj)}}
{{timeline_components.timeline(user, obj)}}
{%- endmacro %}


{% macro journal(user, obj)%}
{{title_components.object_title(user, obj)}}
{{journal_components.journal(user, obj)}}
{%- endmacro %}


{% macro stories(user, obj)%}
{{title_components.object_title(user, obj)}}
<div id='stories-list'>
    {{stories_components.stories(user, obj)}}
</div>
{%- endmacro %}


{% macro campaigns(user, obj)%}
{{title_components.object_title(user, obj)}}
{% if user.world_user(obj)%}
<div class="row">
    <div class="column is-shrink is-end">
        <button class="button is-primary is-small" hx-post="/api/world/campaign/new"
                hx-target="#campaigns-list"
                hx-selector="#campaigns-list"
                hx-swap="outerHTML">
            {{icon_components.plus(size="1rem")}}
            New Campaign
        </button>
    </div>
</div>
{% endif %}
<div id='campaigns-list'>
    {{campaigns_components.campaigns(user, obj)}}
</div>
{%- endmacro %}

{% macro associations(user, obj, associations)%}
{{title_components.object_title(user, obj)}}
{{associations_components.associations(user, obj, associations)}}
{%- endmacro %}

{% macro map(user, obj)%}
{{title_components.object_title(user, obj)}}
{{map_components.map(user, obj)}}
{%- endmacro %}

{% macro jobs(user, obj)%}
{{title_components.object_title(user, obj)}}
{{jobs_components.jobs(user, obj)}}
{%- endmacro %}


{% macro players(user, obj) -%}
{{title_components.object_title(user, obj)}}
<title>{{obj.name}} - Players Panel</title>
<h2 class="has-text-dark">Players</h2>
{% for player in obj.players %}
<a href="/character/{{player.pk}}" style='text-decoration: none;'>
    <div class="panel has-bg-muted">
        <div class="row cards-container has-center">
            <div class="column  is-vertically-centered is-shrink">

                <div class="image is-medium is-thumbnail is-margin-center">
                    <img src="{{player.image.url(size='100')}}" loading="lazy" alt="{{player.name}}"
                         style="width:100%; height:100%;" />
                </div>
            </div>
            <div class="column">
                <h4 class="has-text-dark" style='text-decoration:underline;'>
                    {% if player.name %}
                    {{player.name}}
                    {% else %}
                    {{player.title}}
                    {% endif %}
                </h4>
                <div class="generated-text-lightbg">
                    {{player.backstory_summary | safe}}
                </div>
            </div>
        </div>
    </div>
</a>
<hr>
{% endfor %}
{%- endmacro %}


{% macro manage(user, obj) -%}
{{title_components.object_title(user, obj)}}
{{ manage_world_components.manage(user, obj) }}
{%- endmacro %}

{% macro managescreens(user, obj) -%}
{{title_components.object_title(user, obj)}}
{{ manage_screen_components.manage(user, obj) }}
{%- endmacro %}

{% macro lore(user, obj) -%}
{{title_components.object_title(user, obj)}}
<div class="panel has-bg-muted">
    <h2 class="has-text-dark has-text-centered">Lore Builder</h2>
    <p class="has-text-dark">
        Use this tool to build out the lore of your world. Create entries for important
        events, places, people, and more. Link entries together to create a web of lore that
        players can explore.
    </p>
    <hr>
    <form hx-post="/api/world/lore/new"
          hx-target="#lore-entries"
          hx-selector="#lore-entries"
          hx-swap="outerHTML">
        <div class="row">
            <div class="column">
                <select name="story" class="input is-fullwidth">
                    <option value="" selected>=== Select Storyline ===</option>
                    {% for entry in obj.stories %}
                    <option value="{{entry.pk}}">{{entry.title}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="column">
                <input type="number" name="day" class="input is-fullwidth" min="1" max="31">
                <div class='select'>
                    <select name="month" class="input is-fullwidth">
                        <option value="" selected>=== Select Month ===</option>
                        {% for month in obj.calendar.months %}
                        <option value="{{month}}">{{month}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="is-slider">
                    <input name="year" type="range" min="{{obj.start_date.year}}"
                           max="{{obj.end_date.year}}">
                </div>
            </div>
            <div class="column">

            </div>
            <div class="column">
                <button class="button is-primary is-small">
                    {{icon_components.plus(size="1rem")}}
                    New Lore Entry
                </button>
            </div>
        </div>
    </form>
    <hr>
    <div id='lore-entries'>
        {% for entry in obj.lore_entries %}
        <div class="panel has-bg-screen is-full">
            <h3 class="has-text-dark">{{entry.title}}</h3>
            <div class="generated-text-lightbg">
                {{entry.content_summary | safe}}
            </div>
            <div class="row">
                <div class="column is-shrink is-end">
                    <button class="button is-danger is-small"
                            hx-delete="/api/world/lore/{{entry.pk}}/delete"
                            hx-target="#lore-entries"
                            hx-selector="#lore-entries"
                            hx-swap="outerHTML">
                        {{icon_components.trash(size="1rem")}}
                        Delete
                    </button>
                </div>
            </div>
        </div>
        <hr>
        {% endfor %}
    </div>
</div>
{%- endmacro %}

{% macro associations(user, episode) -%}
<div id="episode-associations" class="row">
    <div class="column fade-it-in">
        <h5 class='has-text-primary'>Add New...</h5>
        <div class="row has-space-around">
            {% for model in episode.world.all_models_str() %}
            <div class="column is-shrink">
                <button class='button is-small'
                        hx-post='/api/episode/{{episode.pk}}/associations/add/{{model | lower}}'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-vals='{"episodepk":"{{episode.pk}}"}'
                        hx-swap='outerHTML'>
                    {{episode.world.get_title(model)}}
                </button>
            </div>
            {% endfor %}
        </div>
        <h5 class='has-text-primary'>...or Add Existing</h5>
        <div class="row has-space-around">
            <div class="column is-shrink">
                <button class='button is-primary is-small'
                        hx-post='/api/episode/{{episode.pk}}/associations/add/campaignassociations'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-swap='outerHTML'>
                    All Story Associations
                </button>
            </div>
            <div class="column is-half">
                <div class="has-dropdown" style="width: 100%;">
                    <input class="has-bg-light" autocomplete="off" type="search" name="query"
                           style="border-bottom: solid #000;"
                           hx-post="/api/episode/{{episode.pk}}/associations/add/search"
                           hx-target="#episode-new-associations-list"
                           hx-trigger="input changed delay:500ms consume"
                           hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
                    <ul class="dropdown has-bg-light" id="episode-new-associations-list">
                    </ul>
                </div>
                <div id="lore-party" class="panel">
                </div>
            </div>
        </div>
        <hr>
        <div class="panel has-bg-screen">
            <div class="row">
                {% for a in children %}
                <div class="column is-2 is-mobile-6 episode-association-entry fade-it-in"
                     style='position:relative;'>
                    {{display_components.object_display(a, type=False, dim=250)}}
                    <a style='position:absolute; top:0px; right:5px;'
                       hx-post="/api/episode/{{episode.pk}}/association/{{a.path}}/delete"
                       hx-target="closest .episode-association-entry" hx-swap="delete"
                       hx-confirm="Are you sure you want to remove this association from the episode?">
                        <iconify-icon class="has-bg-muted" icon="mdi:remove"
                                      width="1rem"></iconify-icon>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{%- endmacro %}

{% macro lore_party_form(user, obj, party=[]) -%}
<div class="row">
    {% for o in party %}
    <div class="column">
        {{display_components.object_display(o, type=False, dim=100)}}
        <input type="hidden" name="party[]" value="{{o.pk}}">
    </div>
    {% endfor %}
</div>
{%- endmacro%}

{% macro lore_party_dropdown(user, obj, objs=[]) -%}
{% for o in objs %}
<li class="dropdown__link has-bg-muted">
    <a hx-post="/api/{{obj.path}}/party/add/{{o.path}}"
       hx-target='#lore-party'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')"
       hx-vals='{js:{party: ??? }'>
        <div class="row">
            <div class="column is-shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="column">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}