{% import "shared/_display.html" as display_components %}
{% import "manage/_episode.html" as manage_episode_components %}
{% import "shared/_icons.html" as icon_components %}
{% import "shared/_details.html" as details_components %}
{% import "shared/_associations.html" as associations_components%}
{% import "shared/_title.html" as title_components %}
{% import "shared/_form.html" as form_components %}

{% macro index(user, obj) -%}
{{details(user, obj)}}
{%- endmacro %}

<!-- unique menu items for campaigns -->
{% macro menu(user, obj) -%}
<li>
    <a href=""
       hx-get="/api/{{obj.path}}/details" hx-target="#page-content"
       hx-indicator="#request-indicator" hx-swap="innerHTML show:#page-content:top"
       hx-push-url="/{{obj.path}}/details">
        <div class="grid-x">
            <div class="cell shrink">
                {{icon_components.details(size="1rem")}}
            </div>
            <div class="cell auto">
                <span>Details</span>
            </div>
        </div>
    </a>
</li>
{% if obj.previous_episode %}
<li>
    <a href="/{{obj.previous_episode.path}}">
        <div class="grid-x">
            <div class="cell shrink">
                {{icon_components.previous(size="1rem")}}
            </div>
            <div class="cell auto">
                <span>Previous Episode</span>
            </div>
        </div>
    </a>
</li>
{% endif %}
{% if obj.next_episode %}
<li>
    <a href="/{{obj.next_episode.path}}">
        <div class="grid-x">
            <div class="cell shrink">
                {{icon_components.next(size="1rem")}}
            </div>
            <div class="cell auto">
                <span>Next Episode</span>
            </div>
        </div>
    </a>
</li>
{% endif %}
<li>
    <a href="/{{obj.path}}/graphic">
        <div class="grid-x">
            <div class="cell shrink">
                {{icon_components.drama(size="1rem")}}
            </div>
            <div class="cell auto">
                <span>Graphic</span>
            </div>
        </div>
    </a>
</li>
{% if user.world_user(obj) %}
<li>
    <a href=""
       hx-get="/api/{{obj.path}}/gmnotes" hx-target="#page-content"
       hx-indicator="#request-indicator" hx-swap="innerHTML show:#page-content:top"
       hx-push-url="/{{obj.path}}/gmnotes">
        <div class="grid-x">
            <div class="cell shrink">
                {{icon_components.gamemaster(size="1rem")}}
            </div>
            <div class="cell auto">
                <span>GM Notes</span>
            </div>
        </div>
    </a>
</li>
{% endif %}
{%- endmacro %}

{% macro details(user, obj) -%}
<title>{{obj.name or obj.title}} - Details</title>
<div class="callout">
    <div id="episode-info" class="grid-x align-spaced">
        <div class="cell medium-4">
            {% if obj.image %}
            <div class="image">
                <img src="{{obj.image.url(size='large')}}" alt="{{obj.name}}" />
            </div>
            {% endif %}
        </div>
        <div class="cell">
            <div class="grid-x align-spaced">
                <div class="cell medium-4 text-center">
                    <h3 class='text-center'>Start</h3>
                    {{obj.start_date}}
                </div>
                <div class="cell medium-4 text-center">
                    <h3 class='text-center'>End</h3>
                    {{obj.end_date}}
                </div>
            </div>
        </div>
        <div class="cell">
            <div id="report-container" class="callout">
                <h2 class='text-center'>Report</h2>
                <div>
                    {{obj.report | safe}}
                </div>
            </div>
        </div>
        <div class="cell">
            <div class="grid-x grid-margin-x align-center-middle">
                {% for event in obj.events %}
                <div class="cell medium-4">
                    <a href="/{{event.path}}">
                        <div class="callout ">
                            <h4 class='text-center'>{{event.name}}</h4>
                            {% if event.date %}
                            <div class='text-center'>
                                <strong>{{event.date}}</strong>
                            </div>
                            {% endif %}
                            {% if event.image %}
                            <img src='{{event.image.url()}}' alt='{{event.name}}'
                                 style='width:100%; height: auto; padding-bottom: 1rem;' />
                            {% endif %}
                            <div class='align-justify'>
                                {{event.summary | safe}}
                            </div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{%- endmacro %}

{% macro gmnotes(user, obj) -%}
<title>{{obj.name or obj.title}} - GM Notes</title>
{% if user.world_user(obj) %}
<div class="callout">
    <div id="episode-info" class="grid-x align-spaced grid-margin-x">
        <div class="cell">
            {% if obj.previous_episode and obj.previous_episode.summary %}
            <div class="callout">
                <h4>Previous Episode Summary</h4>
                {{obj.previous_episode.summary | safe }}
            </div>
            {% endif %}
        </div>
        <div class="cell shrink">
            <div class="callout ">
                <h3 class='text-center'>Loot</h3>
                {{obj.loot | safe}}
            </div>
        </div>
        <div class="cell shrink">
            <div class="callout ">
                <h3 class='text-center'>Current Active Hooks</h3>
                {{obj.hooks | safe}}
            </div>
        </div>
        <div class="cell shrink">
            <div class="callout">
                <div id='episode-connected-stories' class="grid-x grid-margin-x">
                    <div class="cell align-center-middle">
                        <h3 class='text-center'>Connected Stories</h3>
                        <div class="grid-x align-spaced grid-margin-x">
                            {%for s in obj.stories%}
                            <div class="cell medium-3">
                                {{ display_components.object_display(s, type=False) }}
                            </div>
                            {%endfor%}
                        </div>
                        <hr>
                    </div>
                    <div class="cell shrink align-center-middle">
                        <h6>Add Story</h6>
                    </div>
                    <div class="cell auto align-center-middle">
                        <div class="select">
                            <select class="has-bg-white" name='storypk'
                                    hx-post='/api/{{obj.path}}/story/add'
                                    hx-target='#episode-connected-stories'
                                    hx-select='#episode-connected-stories'
                                    hx-swap='outerHTML'
                                    hx-trigger="change">
                                <option value="">---</option>
                                {%for story in obj.world.stories %}
                                {% if story not in obj.stories%}
                                <option value="{{story.pk}}">
                                    {{story.name}}
                                </option>
                                {% endif %}
                                {%endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="cell bg-screen padding-vertical-2">
            <h3 class='text-center'>Potential Encounters</h3>
            <div class="grid-x  align-spaced grid-margin-x">
                {% for e in obj.encounters %}
                <div class="cell medium-3">
                    {% if e.parent %}
                    <a href="/{{e.parent.path}}"><span class="label">{{e.parent.name}}</span></a>
                    {% endif %}
                    {{ display_components.object_display(e, type=False) }}
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="cell bg-light padding-vertical-2">
            <div id='session-recorder-container'>
                {{session_recorder(user, obj)}}
            </div>
            <hr>
        </div>
        <div class="cell bg-light padding-vertical-2">
            <h2 class='text-center'>Planning Notes</h2>
            <div id="gm_planning_form" class="margin-top-2">
                <form
                      hx-post="/api/episode/{{obj.pk}}/update"
                      hx-swap='none'
                      hx-trigger='input delay:1s, change'>
                    {{form_components.richtexteditor(user, obj, 'description')}}
                </form>
            </div>
        </div>
    </div>
    {{associations(user, obj, obj.associations)}}
    <hr>
</div>
{% endif %}
{%- endmacro %}

{% macro session_recorder(user, episode) -%}
<div class="card grid-container padding-x-2 padding-y-3">
    <div class="card-section">
        <h5 class="text-center font-weight-bold margin-bottom-2 secondary">GM Voice Input</h5>

        <!-- Timer & Status Display -->
        <div class="grid-x align-center margin-bottom-2">
            <div class="cell shrink text-center">
                <span id="recording-status" class="label secondary rounded">Ready</span>
            </div>
            <div class="cell shrink text-center">
                <span id="recording-timer"
                      class="h3 primary text-bold margin-left-1">00:00</span>
            </div>
        </div>

        <!-- Volume Meter -->
        <div class="grid-x align-center margin-bottom-2">
            <div class="cell medium-8 small-10">
                <div id="volume-meter" class="progress primary margin-bottom-0"
                     role="progressbar"
                     tabindex="0" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div id="volume-bar" class="progress-meter" style="width: 0%">
                        <p id="meter-text"
                           class="progress-meter-text text-center text-secondary">
                            Speak Now</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Buttons (Horizontal, in an Input-Group like structure for compactness) -->
        <div class="grid-x grid-margin-x align-center">

            <!-- Record Button -->
            <div class="cell shrink">
                <button id="record-btn" class="button primary margin-bottom-0"
                        data-state="ready"
                        onclick="startRecording()">
                    <iconify-icon icon="lucide:mic" class="margin-right-1"></iconify-icon> Start
                    Recording
                </button>
            </div>

            <!-- Stop Button (Now triggers auto-send if > 15s) -->
            <div class="cell shrink">
                <button id="stop-btn" class="button alert margin-bottom-0" disabled
                        onclick="manualStop()">
                    <iconify-icon icon="lucide:square" class="margin-right-1"></iconify-icon>
                    Stop &
                    Send
                </button>
            </div>

            <!-- Clear Button -->
            <div class="cell shrink">
                <button id="clear-btn" class="button warning margin-bottom-0"
                        hx-post="/api/{{ episode.path }}/transcription/clear"
                        hx-target="#output-area" hx-select="#output-area" hx-swap="outerHTML"
                        hx-confirm='Are you sure you want to clear the current transcription?'>
                    Clear Transcription
                </button>
            </div>

        </div>
    </div>
    <!-- Output/Feedback Area Wrapper -->
    <div id="recorder-output-wrapper" class='callout'>
        <!-- 1. Dedicated Target (for the main component view) -->
        <div id="output-area" class="text-justified secondary margin-top-2"
             hx-get="/api/{{ episode.path }}/gmnotes" hx-trigger="every 5s"
             hx-select="#output-area" hx-indicator="">
            <h6>Transcription</h6>
            {% if episode.transcription %}
            {{ episode.transcription | safe }}
            {% endif %}
        </div>
    </div>

    <script>
        (function () {
            // --- Configuration ---
            var MAX_RECORDING_SECONDS = 5 * 60; // Auto-send limit: 5 minutes = 300  seconds
            var MIN_RECORDING_SECONDS = 5;      // Manual send threshold: 5 seconds
            var TARGET_PK = '{{ episode.pk }}'; // NOTE: Corrected to {{ episode.pk }} in JS

            // --- State Variables (using var for isolation within the IIFE) ---
            var recordBtn = document.getElementById('record-btn');
            var stopBtn = document.getElementById('stop-btn');
            var timerDisplay = document.getElementById('recording-timer');
            var statusDisplay = document.getElementById('recording-status');
            var outputTarget = document.getElementById(TARGET_PK) || document.getElementById('output-area');
            var volumeBar = document.getElementById('volume-bar');
            var meterText = document.getElementById('meter-text');
            var volumeMeterContainer = document.getElementById('volume-meter');
            var outputAreaDiv = document.getElementById('output-area');

            var mediaRecorder;
            var audioChunks = [];
            var intervalId;
            var startTime;
            var mediaStream;
            var audioBlob; // This is the variable that was previously accessed too early
            var isSessionRunning = false;
            var currentDuration = 0;

            // Web Audio API components for volume analysis
            var audioContext;
            var analyser;
            var dataArray;
            var volumeRequestId;


            // --- Utility Functions ---

            function formatTime(seconds) {
                var min = Math.floor(seconds / 60);
                var sec = seconds % 60;
                return "" + String(min).padStart(2, '0') + ":" + String(sec).padStart(2, '0');
            }

            function updateTimer() {
                currentDuration = Math.floor((Date.now() - startTime) / 1000);
                timerDisplay.textContent = formatTime(currentDuration);

                if (currentDuration >= MAX_RECORDING_SECONDS) {
                    stopAndSendSegment(false);
                }
            }

            function startTimer() {
                startTime = Date.now();
                currentDuration = 0;
                timerDisplay.textContent = '00:00';
                intervalId = setInterval(updateTimer, 1000);
            }

            function stopTimer() {
                clearInterval(intervalId);
            }

            function updateControls(isRecording, isRecorded) {
                // ... (control update logic is unchanged)
                recordBtn.disabled = isRecording || isRecorded;
                stopBtn.disabled = !isRecording;
                recordBtn.classList.toggle('disabled', isRecording || isRecorded);
                stopBtn.classList.toggle('disabled', !isRecording);
                statusDisplay.classList.remove('secondary', 'warning', 'success', 'alert', 'primary');
                if (isRecording) {
                    statusDisplay.textContent = 'RECORDING';
                    statusDisplay.classList.add('warning');
                    meterText.textContent = 'Listening...';
                } else if (isRecorded) {
                    statusDisplay.textContent = 'PROCESSING...';
                    statusDisplay.classList.add('success');
                    meterText.textContent = 'Sending Segment';
                } else {
                    statusDisplay.textContent = 'READY';
                    statusDisplay.classList.add('secondary');
                    meterText.textContent = 'Speak Now';
                    volumeBar.style.width = '0%';
                }
            }

            // --- Volume Analysis Functions (omitted for brevity) ---
            function startVolumeAnalyser() {
                if (!mediaStream) return;

                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                var mediaStreamSource = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.fftSize);

                mediaStreamSource.connect(analyser);

                processVolume();
            }

            function stopVolumeAnalyser() {
                if (volumeRequestId) {
                    cancelAnimationFrame(volumeRequestId);
                }
                if (analyser && analyser.context) {
                    analyser.disconnect();
                }
                volumeBar.style.width = '0%';
                volumeMeterContainer.classList.remove('success', 'warning', 'alert');
            }

            function processVolume() {
                volumeRequestId = requestAnimationFrame(processVolume);

                analyser.getByteTimeDomainData(dataArray);

                var sumOfSquares = 0;
                for (var i = 0; i < dataArray.length; i++) {
                    var amplitude = dataArray[i];
                    var normalized = (amplitude / 128.0) - 1;
                    sumOfSquares += normalized * normalized;
                }

                var rms = Math.sqrt(sumOfSquares / dataArray.length);

                var volumePercentage = Math.min(100, rms * 200);

                volumeBar.style.width = volumePercentage + '%';
                volumeMeterContainer.setAttribute('aria-valuenow', Math.floor(volumePercentage));

                volumeMeterContainer.classList.remove('success', 'warning', 'alert', 'secondary');
                if (volumePercentage > 50) {
                    volumeMeterContainer.classList.add('success');
                } else if (volumePercentage > 10) {
                    volumeMeterContainer.classList.add('warning');
                } else {
                    volumeMeterContainer.classList.add('secondary');
                }
                meterText.textContent = volumePercentage > 5 ? 'Recording...' : 'Speak Up!';
            }

            // --- Synchronization Helper ---
            function waitForAudioBlob() {
                return new Promise(function (resolve) {
                    // Check if audioBlob is already set (unlikely, but safe)
                    if (audioBlob) {
                        resolve();
                        return;
                    }
                    // Temporarily replace the onstop handler to resolve the promise
                    mediaRecorder.onstop = function () {
                        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        // Now that blob is ready, continue to the original onstop logic (if any)
                        resolve();
                    };
                });
            }

            // --- Session Management Functions ---

            async function stopAndSendSegment(isManualStop) {

                // 1. Stop the MediaRecorder, which will trigger the promise resolution
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }

                // 2. WAIT for the audioBlob to be created by mediaRecorder.onstop
                await waitForAudioBlob();

                // 3. Stop all remaining resources
                stopTimer();
                stopVolumeAnalyser();
                if (mediaStream) {
                    mediaStream.getTracks().forEach(function (track) { return track.stop(); });
                    mediaStream = null;
                }

                // 4. Update UI state
                updateControls(false, true);

                if (isManualStop) {
                    isSessionRunning = false;
                }

                // 5. Send the audio now that we GUARANTEE audioBlob is defined
                await sendAudio(isManualStop);

                // 6. Restart if necessary
                if (!isManualStop && isSessionRunning) {
                    setTimeout(startRecording, 500);
                }
            }

            function manualStop() {
                if (!isSessionRunning) return;

                // Discard the audio if it's too short
                if (currentDuration < MIN_RECORDING_SECONDS) {
                    // Discard logic is correct and does not need synchronization
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop(); // Stops, but the blob is discarded later
                    }
                    if (mediaStream) {
                        mediaStream.getTracks().forEach(function (track) { return track.stop(); });
                        mediaStream = null;
                    }
                    stopTimer();
                    stopVolumeAnalyser();

                    isSessionRunning = false;
                    updateControls(false, false);
                    outputTarget.insertAdjacentHTML('afterbegin', '<div class="callout alert margin-bottom-1 padding-1">Recording Discarded: Segment must be at least ' + MIN_RECORDING_SECONDS + ' seconds.</div>');
                    return;
                }

                // If long enough, stop and send (now synchronized)
                stopAndSendSegment(true);
            }

            async function startRecording() {
                if (mediaRecorder && mediaRecorder.state === 'recording') return;

                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(mediaStream);
                    audioChunks = [];
                    audioBlob = null; // Reset blob at start

                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }

                    // Set up data handling - simplified now that onstop handles blob creation
                    mediaRecorder.ondataavailable = function (event) {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.start();
                    startTimer();
                    startVolumeAnalyser();
                    isSessionRunning = true;
                    updateControls(true, false);

                } catch (err) {
                    // ... (error handling logic is unchanged)
                    console.error('Microphone error:', err);
                    statusDisplay.textContent = 'Permission Denied';
                    statusDisplay.classList.add('alert');
                    updateControls(false, false);
                    outputTarget.innerHTML = "<p>Microphone Access Required. Check browser settings (Requires HTTPS/localhost).</p>";
                }
            }

            async function sendAudio(isFinalSegment) {
                if (!audioBlob) {
                    outputTarget.innerHTML = '<p>Internal Error: Audio blob is missing.</p>';
                    return;
                }

                statusDisplay.textContent = 'SENDING...';
                statusDisplay.classList.remove('success', 'warning');
                statusDisplay.classList.add('primary');

                var episodePk = '{{episode.pk}}';
                var targetUrl = "/api/episode/" + episodePk + "/transcribe";

                var segmentType = isFinalSegment ? 'Manual Stop' : 'Auto Segment';
                outputTarget.insertAdjacentHTML('afterbegin', "<p>Sending " + segmentType + " (Length: " + timerDisplay.textContent + ") to AI transcription service at <code>" + targetUrl + "</code>...</p>");

                var formData = new FormData();
                formData.append('audio_file', audioBlob, "gm_input_" + Date.now() + ".webm");
                formData.append('is_final_segment', isFinalSegment ? 'true' : 'false');

                try {
                    var response = await fetch(targetUrl, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        var newContent = "\n                    <div class=\"callout success margin-bottom-1 padding-1\">\n                        <h6>Segment Sent Successfully (" + segmentType + ")</h6></div>\n                ";
                        outputTarget.insertAdjacentHTML('afterbegin', newContent);
                        statusDisplay.textContent = isFinalSegment ? 'SESSION ENDED' : 'SENT & RESTARTING...';
                    } else {
                        outputTarget.insertAdjacentHTML('afterbegin', '<p class="alert">Transcription Error (' + response.status + ')</p>');
                        statusDisplay.textContent = 'TRANSCRIPTION FAILED';
                        statusDisplay.classList.add('alert');
                    }
                } catch (error) {
                    console.error('Fetch Error:', error);
                    outputTarget.insertAdjacentHTML('afterbegin', "\n                <div class=\"callout alert margin-bottom-1 padding-1\">\n                    <h4>Network Error</h4>\n                    <p>Failed to connect to the server.</p>\n                </div>\n            ");
                    statusDisplay.textContent = 'NETWORK ERROR';
                    statusDisplay.classList.add('alert');
                } finally {
                    audioBlob = null;
                    if (isFinalSegment) {
                        updateControls(false, false);
                    }
                }
            }

            updateControls(false, false);

            // Assign event handlers using the functions defined inside the IIFE
            recordBtn.onclick = startRecording;
            stopBtn.onclick = manualStop;

        })();
    </script>
</div>
{%- endmacro %}

{% macro graphic(user, obj) -%}
<title>{{obj.name or obj.title}} - Details</title>
<div class="callout">
    <div id="episode-graphic" class="grid-x align-spaced">
        {% if user.world_user(obj) %}
        <div class="cell shrink ">
            <button class="button"
                    hx-post="/api/{{obj.path}}/graphic/generate"
                    hx-indicator="#request-indicator"
                    hx-push-url="/{{obj.path}}/graphic">
                Generate New Graphic
            </button>
        </div>
        {% endif %}
        <div class=" cell medium-10">
            <div class="callout ">
                {% if obj.graphic %}
                <div class="image">
                    <img src="{{obj.graphic.url()}}" alt="{{obj.name}}" />
                </div>
                {% else %}
                <p>No graphic has been generated for this episode.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{%- endmacro %}

{% macro timeline(user, obj)%}

{{timeline_components.timeline(user, obj)}}
{%- endmacro %}

{% macro associations(user, obj, associations)%}
{{associations_components.associations(user, obj, associations)}}
{%- endmacro %}

{% macro manage(user, obj) -%}
{{ manage_episode_components.manage(user, obj) }}
{%- endmacro %}