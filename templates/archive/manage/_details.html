{% import "components/_form.html" as form_components %}
{% import "components/_elements.html" as element %}

{% macro details(user, obj, info) -%}
<div class="row">
    <div class="column is-center">
        <h2 class='has-text-dark'>Details Editor</h2>
    </div>
    <div class="column is-shrink is-float-right">
        <a class='has-text-dark' href="/{{obj.path}}/details">
            <iconify-icon icon="material-symbols:close" width="3rem" height="3rem">
            </iconify-icon>
        </a>
    </div>
</div>
<hr>
<div class="row has-space-around">
    <div class="column is-shrink is-vertically-centered">
        <button class="button is-primary"
                hx-post="/task/generate/history/{{obj.path}}">
            Update History
        </button>
    </div>
    {% if user.is_admin %}
    <div class="column is-shrink is-vertically-centered">
        <button class="button is-primary" hx-post="/task/generate/{{obj.path}}"
                hx-target="closest .column"
                hx-confirm='Generated details can generate from scratch, but works best if you add any required details to the {{obj.title}} first such as name, brief history, and details'>
            <iconify-icon icon="eos-icons:ai"></iconify-icon>
            Generate Details
        </button>
    </div>
    {% endif %}
    {% if obj.model_name() in ['Creature', 'Item'] %}
    <div class="column">
        <h5 class='has-text-dark'>Search D&D5e API</h5>
        <div class="row">
            <div class="column is-full">
                <input class="has-bg-light" autocomplete=off type="search" name="query"
                       placeholder="Search D&D5e API"
                       style="border-bottom: solid #000;" hx-target="#dnd5e-search"
                       hx-post="/api/search/dnd5eapi" hx-trigger="input delay:750ms, search">
            </div>
            <div class="column is-vertically-centered">
                <div class="panel has-bg-muted" id="dnd5e-search">
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% if obj.model_name() in ['Character'] and obj.is_player %}
<div class="column is-shrink is-vertically-centered">
    <div style='position:relative;'>
        <button class="button is-small is-primary" hx-post="/api/manage/character/dndbeyond"
                hx-target="#page-content" {% if not obj.dnd_beyond_id %} disabled {% endif
                %}
                hx-indicator="#request-indicator">
            Updates from D&DBeyond
        </button>
        {% if not obj.dnd_beyond_id %}
        <small class="has-text-center is-very-small-heading has-text-secondary has-bg-muted"
               style='position:absolute;top:0; left: 0;'>Must be a 'player' and have
            DnDBeyond ID set</small>
        {% endif %}
    </div>
</div>
{% endif %}
</div>
<hr>
<form hx-post="/api/manage/update" hx-swap="none" hx-trigger="input delay:1s, change">
    <div class="row">
        <div class="column">
            <h5 class='has-text-center has-text-dark'>Name</h5>
            <input id='model-name' class="has-bg-light has-text-center" type="text" name="name"
                   value="{{obj.name}}">
        </div>
        <div class="column">
            <h5 class='has-text-center has-text-dark'>One Phrase Description</h5>
            <input class="has-bg-light has-text-center" type="text" name="traits"
                   value="{{obj.traits}}" maxlength="64">
        </div>
    </div>
    {% if obj.model_name() != "World"%}
    <hr>
    <div id="manage-obj-dates" class="row raise-it">
        <div class="column has-no-padding-left">
            <div class="panel is-small has-bg-light">
                <div class="row has-bg-light">
                    <div class="column is-2 is-vertically-centered">
                        <h4 class="has-text-dark">{{obj._possible_events[0]}}</h4>
                    </div>
                    <div class="column is-3 is-vertically-centered">
                        <label class="has-text-dark-grey" for="start_date.day">Day</label>
                        <input class="inputlabel" type="number" name="start_date.day"
                               value="{{obj.start_date.day}}">
                    </div>
                    <div class="column is-vertically-centered">
                        <label class="has-text-dark-grey"
                               for="start_date.month">Month</label>
                        <select class="has-bg-muted" name="start_date.month">
                            <option value="">---</option>
                            {% for month in obj.calendar.months %}
                            <option value="{{loop.index0}}" {% if
                                    obj.start_date['month']==loop.index0 %} selected
                                    {%endif%}>
                                {{month}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="column is-3 is-vertically-centered">
                        <label class="has-text-dark-grey" for="start_date.year">Year</label>
                        <input class="inputlabel" type="number" name="start_date.year"
                               value="{{obj.start_date.year}}">
                    </div>
                </div>
            </div>
        </div>
        <div class="column has-no-padding-right">
            <div class="panel is-small has-bg-light">
                <div class="row">
                    <div class="column is-2 is-vertically-centered">
                        <h4 class="has-text-dark">{{obj._possible_events[-1]}}</h4>
                    </div>
                    <div class="column is-2 is-vertically-centered">
                        <label class="has-text-dark-grey" for="end_date.day">Day</label>
                        <input class="inputlabel" type="number" name="end_date.day"
                               value="{{obj.end_date.day}}">
                    </div>
                    <div class="column is-vertically-centered">
                        <label class="has-text-dark-grey" for="end_date.month">Month</label>
                        <select class="has-bg-muted" name="end_date.month">
                            <option value="">---</option>
                            {% for month in obj.calendar.months %}
                            <option value="{{loop.index0}}" {% if
                                    obj.end_date['month']==loop.index0 %} selected
                                    {%endif%}>
                                {{month}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="column is-3 is-vertically-centered">
                        <label class="has-text-dark-grey" for="end_date.year">Year</label>
                        <input class="inputlabel" type="number" name="end_date.year"
                               value="{{obj.end_date.year}}">
                    </div>
                </div>
            </div>
        </div>
        <hr>
    </div>
    {% endif %}
</form>
<form hx-post="/api/manage/update"
      hx-swap="none" hx-trigger="input delay:1s, change">
    <div class="panel is-small has-bg-muted">
        <h4 class='has-text-center has-text-dark'>Backstory</h4>
        {{form_components.texteditor(user, obj, 'backstory')}}
    </div>
</form>
<hr>
{% if info %}
{{info(user, obj) | safe}}
{%endif%}
<hr>
{{image(user, obj)}}
<hr class="has-bg-primary">
<div class="row">
    <div class="column is-shrink is-end">
        <button class="button"
                hx-post="/api/manage/delete/{{obj.path}}"
                hx-confirm="Are you sure you want to delete this {{obj.title}}?"
                onclick="location.href = '/world/{{obj.get_world().pk}}'">
            <iconify-icon icon="material-symbols-light:delete-outline"></iconify-icon>
        </button>
    </div>
</div>
{%- endmacro %}

{% macro image(user, obj) -%}
<h3 class='has-text-center has-text-dark' id='manage-image'>Image Editor</h3>
<div class="panel has-bg-light-grey is-small">
    <div class="row" id="image-manage-container">
        <div class="column is-8" id="model-owner-image">
            <div class="image is-margin-center">
                {% if obj.image %}
                <img src="{{obj.image.url()}}" alt="{{obj.name}}" />
                {% endif %}
            </div>
        </div>
        <div class="column is-4">
            <div class="row">
                <div class="column">
                    <h5 class='has-text-center has-text-dark'>Image Description (editable)
                    </h5>
                    <div class="panel has-bg-light">
                        <p id="model-desc" class="has-text-dark" contentEditable="true"
                           hx-post="/api/manage/update" hx-trigger="input delay:1s"
                           hx-vals="js:{description:strip_html(htmx.find('#model-desc').innerHTML)}"
                           hx-swap="none">
                            {{obj.desc | striptags}}
                        </p>
                    </div>
                </div>
            </div>
            <div class="row">
                {% if user.admin %}
                <div class="column is-vertically-centered">
                    <button class="button is-full is-small"
                            hx-post="/task/generate/image/{{obj.path}}" hx-target="closest .column"
                            hx-indicator="#request-indicator" hx-swap="innerHTML"
                            hx-confirm="Are you sure you want to generate and overwrite the current image?">
                        <iconify-icon icon="tabler:photo-ai"></iconify-icon>
                        AI Generated Image
                    </button>
                </div>
                {% endif %}
            </div>
            <div class="row">
                <div class="column">
                    <button class="button is-full is-small" hx-post="/api/search/gallery/image"
                            hx-target="#model-owner-image" hx-swap="innerHTML">
                        <iconify-icon icon="game-icons:card-random"></iconify-icon>
                        Select From Gallery
                    </button>
                </div>
            </div>
            <hr>
            <form hx-post="/api/manage/update" hx-target='#model-owner-image'
                  hx-confirm="Are you sure you want to upload and overwrite the current image?"
                  hx-vals='{"module":"manage/_details.html", "macro":"details"}'>
                <div class="row">
                    <div class="column is-full">
                        <div class="inputlabel">
                            <input class="has-bg-muted has-text-secondary" type="url"
                                   name="image_url" placeholder="enter url....">
                        </div>
                    </div>
                    <div class="column is-full">
                        <button class="button is-full is-small" type="submit">
                            <iconify-icon icon="lucide:link"></iconify-icon> Upload from URL
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{%- endmacro%}