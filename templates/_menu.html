{% import "shared/_icons.html" as icons_element %}

{% macro dsp_auth(user) -%}
    {% if user and user.state != "guest"%}
        <div>{{user.name | title}}</div>
        <a class="button" href="/auth/logout">Logout</a>
        <button class='button' hx-post="/api/gmscreen/display" hx-target="#screen-container"
                onclick='htmx.find("#screen-container").style="transform: translateY(0%);";'>
            {{icons_element.keyboard(size="1.5rem")}}
            GM Screen
        </button>

        {% if user.admin %}
        <a class="button" href="/admin/"> {{icons_element.keyboard(size="1.5rem")}}
            Admin
        </a>
        {% endif %}

    {% else %}
        <a href="/auth/login">Login</a>
    {% endif %}
{%- endmacro %}

{% macro topnav(user) -%}
<div id="top-nav" class="grid-x grid-padding-x">
    <!-- logo -->
    <div class="cell small-6 medium-3">
        <a id="logo" class="align-middle" href="/">{{icons_element.dungeon(size="2.5rem")}}Storyteller</a>
        <small class="show-for-medium">ver. 0.2.1</small>
    </div>

    <!-- login -->
    <div class="cell small-6 medium-3 medium-order-3">
        <button class="button float-right" type="button" data-toggle="auth-panel">{{icons_element.character(size="2rem")}}</button>
        <div class="dropdown-pane" id="auth-panel" data-dropdown data-auto-focus="true">
            {{dsp_auth(user)}}
        </div>
    </div>

    <!-- search -->
    <div class="cell small-12 medium-6 align-self-middle" hx-indicator="#request-indicator">
        <div class="input-group">
            <input type="text" autocomplete="off" class="input-group-field"
                placeholder="search"
                   type="search" name="query" hx-post="/api/nav/search" hx-target="#nav-search"
                   hx-trigger="input changed delay:500ms, search"
                   hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
            <div class="input-group-button"><button class="button">{{icons_element.search('1.25rem')}}</button></div>
        </div>
        <ul id="nav-search"></ul>
    </div>
</div>

<nav class="row">
    <div class="column is-shrink is-vertically-centered has-text-center">
        <a href="/">
            <h2>
                {{icons_element.dungeon(size="2.5rem")}}
                Storyteller
            </h2>
        </a>
    </div>
    <div class="column is-shrink is-vertically-centered">
        <small>ver. 0.2.1</small>
    </div>
    <div class="column is-4 is-center is-vertically-centered" hx-indicator="#request-indicator">
        <div class="is-input-group has-bg-secondary">
            <span>
                {{icons_element.search(size="1.25rem")}}
            </span>
            <div class="has-dropdown" style="width:100%;">
                <input type="text" autocomplete="off" class="has-bg-secondary has-text-white"
                       type="search" name="query" hx-post="/api/nav/search" hx-target="#nav-search"
                       hx-trigger="input changed delay:500ms, search"
                       hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
                <ul class="dropdown has-bg-light" id="nav-search">
                </ul>
            </div>
        </div>
    </div>
    {% if user and user.state != "guest"%}
    <div class="column is-shrink is-tablet-up is-vertically-centered is-end">
        <button class='button' hx-post="/api/gmscreen/display" hx-target="#screen-container"
                onclick='htmx.find("#screen-container").style="transform: translateY(0%);";'>
            {{icons_element.keyboard(size="1.5rem")}}
            GM Screen
        </button>
    </div>
    {% endif %}
    <div class="column is-shrink is-tablet-up is-vertically-centered">
        <a href="/">
            <h4>
                {% if user and user.state != "guest"%}
                {{user.name | title}}
                {% endif %}
            </h4>
        </a>
    </div>
    <div class="column is-shrink is-vertically-centered">
        {% if not user or user.state == "guest" %}
        <a href="/auth/login" class="button is-rounded is-small">Login</a>
        {% else %}
        <a href="/auth/logout" class="button is-rounded is-small">Logout</a>
        {% endif %}
    </div>
    {% if user and user.admin %}
    <div class="column is-shrink is-tablet-up is-vertically-centered">
        <a class="button is-small is-rounded" href="/admin/">
            ADMIN
        </a>
    </div>
    {% endif %}
</nav>
{%- endmacro %}

{% macro nav_dropdown(user, obj, objs=[]) -%}
{% for o in objs %}
<li class="menu">
    <a href='/{{o.model_name() | lower}}/{{o.pk}}' target='_blank'>
        <div class="row">
            <div class="column">
                {% if o.image %}
                <img src=" {{o.image.url(size=50)}}" alt="{{o.name}}" />
                {% endif %}
            </div>
            <div class="column">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}

{% macro sidemenu(user, obj) -%}
<div id="sidenav">
    <nav id="model-menu-container">
        <h4><a href="/{{obj.get_world().path}}">{{icons_element.world(size="1rem")}} {{obj.get_world().name}}</a></h4>

        <hr>
        <span>
            {{icons_element.search(size="1.25rem")}}
        </span>
        <div class="has-dropdown" style="width:100%;">
            <input type="text" autocomplete="off" class="has-bg-secondary has-text-white"
                   type="search" name="query" hx-post="/api/nav/search" hx-target="#nav-search"
                   hx-trigger="input changed delay:500ms, search"
                   hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
            <ul class="dropdown has-bg-light" id="nav-search">
            </ul>
        </div>

        <ul class="vertical menu">
            <li><a href="/{{obj.path}}/details">{{icons_element.details(size="1rem")}} Details</a></li>
            <li><a href="/{{obj.path}}/history">{{icons_element.history(size="1rem")}} History</a></li>
            <li><a href="/{{obj.path}}/timeline">{{icons_element.timeline(size="1rem")}} Timeline</a></li>
            
            <h6>User Specific Stuff? basically associations</h6>
            {% if user.world_user(obj) %}
            <li><a href="/{{obj.path}}/campaigns">{{icons_element.campaigns(size="1rem")}} Campaigns</a></li>
            <li><a href="/{{obj.path}}/stories">{{icons_element.story(size="1rem")}} Stories</a></li>
            <li><a href="/{{obj.path}}/journal">{{icons_element.journal(size="1rem")}} Journal</a></li>
            {% endif %}

            <h6>Object Dep Options</h6>
            {% if obj.model_name() not in ['Character', 'Creature', 'Item', 'Encounter'] %}
            <li><a href="/{{obj.path}}/jobs">{{icons_element.jobs(size="1rem")}} Job Board</a></li>
            {% endif %}
            {% if obj.model_name() in ["World", "Region", "City", "Location", "District", "Vehicle", "Shop"] %}
            <li><a href="/{{obj.path}}/map">{{icons_element.map(size="1rem")}} Map</a></li>
            {% endif %}
        </ul>
        
        <hr>
        <p>HTMX?</p>
        <span hx-get="/api/nav/sidemenu/{{obj.path}}"
              hx-trigger="load"
              hx-swap="outerHTML">
        </span>
    </nav>
</div>
{%- endmacro %}