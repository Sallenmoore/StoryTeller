{% import "shared/_icons.html" as icon_components %}

{% macro topnav(user) -%}
<nav class="row">
    <div class="column is-shrink is-vertically-centered has-text-center">
        <a href="/">
            <h2>
                {{icon_components.dungeon(size="2.5rem")}}
                Storyteller
            </h2>
        </a>
    </div>
    <div class="column is-shrink is-vertically-centered">
        <small>ver. 0.2.1</small>
    </div>
    <div class="column is-4 is-center is-vertically-centered" hx-indicator="#request-indicator">
        <div class="is-input-group has-bg-secondary">
            <span>
                {{icon_components.search(size="1.25rem")}}
            </span>
            <div class="has-dropdown" style="width:100%;">
                <input type="text" autocomplete="off" class="has-bg-secondary has-text-white"
                       type="search" name="query" hx-post="/api/nav/search" hx-target="#nav-search"
                       hx-trigger="input changed delay:500ms, search"
                       hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
                <ul class="dropdown has-bg-light" id="nav-search">
                </ul>
            </div>
        </div>
    </div>
    {% if user and user.state != "guest"%}
    <div class="column is-shrink is-tablet-up is-vertically-centered is-end">
        <button class='button' hx-post="/api/gmscreen/display" hx-target="#screen-container"
                onclick='htmx.find("#screen-container").style="transform: translateY(0%);";'>
            {{icon_components.keyboard(size="1.5rem")}}
            GM Screen
        </button>
    </div>
    {% endif %}
    <div class="column is-shrink is-tablet-up is-vertically-centered">
        <a href="/">
            <h4>
                {% if user and user.state != "guest"%}
                {{user.name | title}}
                {% endif %}
            </h4>
        </a>
    </div>
    <div class="column is-shrink is-vertically-centered">
        {% if not user or user.state == "guest" %}
        <a href="/auth/login" class="button is-rounded is-small">Login</a>
        {% else %}
        <a href="/auth/logout" class="button is-rounded is-small">Logout</a>
        {% endif %}
    </div>
    {% if user and user.admin %}
    <div class="column is-shrink is-tablet-up is-vertically-centered">
        <a class="button is-small is-rounded" href="/admin/">
            ADMIN
        </a>
    </div>
    {% endif %}
</nav>
{%- endmacro %}

{% macro nav_dropdown(user, obj, objs=[]) -%}
{% for o in objs %}
<li class="dropdown__link">
    <a href='/{{o.model_name() | lower}}/{{o.pk}}' target='_blank'>
        <div class=" row">
            <div class="column is-shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src=" {{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="column">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}

{% macro sidemenu_active(user, obj) -%}
<div id="sidenav"
     class="is-tablet-up has-bg-secondary has-no-padding-bottom has-no-padding-right slide-it-in"
     style='position:relative; z-index:1001; padding-top:1rem;border-radius: 0 10px 10px 0;border-right: solid;border-top: solid;border-bottom: solid;'>
    <div class="row ">
        <div class="column has-no-padding-bottom is-vertically-centered">
            <div class="row slide-it-in">
                <div id="collapse-sidemenu"
                     class="column is-mobile-only is-mobile-3 is-end menu-anchor-text is-hidden">
                    {{icon_components.close()}}
                </div>
            </div>
        </div>
    </div>
    <nav class="menu is-active" id="model-menu-container">
        <ul class="menu__list">
            <li>
                <a href="/{{obj.world.path}}" class="menu-anchor">
                    <div class="row">
                        <div id="menu-world-anchor" class="column is-3 is-mobile-shrink">
                            {{icon_components.world(size="1rem")}}
                        </div>
                        <script>
                            tippy('#menu-world-anchor', {
                                content: '{{obj.world.name}}',
                                placement: 'right',
                                allowHTML: true,
                                arrow: false,
                                animation: 'perspective-extreme',

                            });
                        </script>
                        <div
                             class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                            <h4>{{obj.world.name}}</h4>
                        </div>
                    </div>
                </a>
            </li>
        </ul>
        <p class="menu__divider"></p>
        <span hx-get="/api/nav/sidemenu/{{obj.path}}"
              hx-trigger="load"
              hx-swap="outerHTML">
        </span>
        <p class="menu__divider"></p>
        <ul class="menu__list">
            <li>
                <a href="" class="menu-anchor"
                   hx-get="/api/{{obj.path}}/associations"
                   hx-target="#page-content"
                   hx-indicator="#request-indicator"
                   hx-swap="innerHTML show:#page-content:top"
                   hx-push-url="/{{obj.path}}/associations">
                    <div class="row">
                        <div id='menu-associations-anchor' class="column is-3 is-mobile-shrink">
                            {{icon_components.associations(size="1rem")}}
                        </div>
                        <script>
                            tippy('#menu-associations-anchor', {
                                content: 'Associations',
                                placement: 'right',
                                allowHTML: true,
                                arrow: false,
                                animation: 'perspective-extreme',

                            });
                        </script>
                        <div
                             class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                            <span>Associations</span>
                        </div>
                    </div>
                </a>
            </li>
        </ul>
        <ul class="menu__list" id='child-object-submenu'>
            {% for model in obj.world.all_models_str() %}
            <li>
                <div class="row" style='position:relative;'>
                    <div class="column has-no-padding">
                        <a href="/{{obj.path}}/associations/{{model | lower}}" class="menu-anchor"
                           hx-get="/api/{{obj.path}}/associations/{{model | lower}}"
                           hx-target="#page-content"
                           hx-indicator="#request-indicator"
                           hx-swap="innerHTML show:#content:top"
                           hx-push-url="/{{obj.path}}/associations/{{model | lower}}">
                            <div class="row">
                                <div id='menu-{{model | lower}}-anchor'
                                     class="column is-3 is-mobile-shrink">
                                    {{obj.world.get_icon(model)}}
                                </div>
                                <script>
                                    tippy('#menu-{{model | lower}}-anchor', {
                                        content: '{{obj.world.get_title(model)}}',
                                        placement: 'right',
                                        allowHTML: true,
                                        arrow: false,
                                        animation: 'perspective-extreme',

                                    });
                                </script>
                                <div
                                     class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                                    <span>{{obj.world.get_title(model)}}</span>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </nav>
    <script>
        var timeout = null;
        var sideMenu = document.getElementById('sidenav');
        var isOpen = false;
        if ((window.innerWidth <= 850)) {
            htmx.find('#mobile-menu-burger').addEventListener("click", (event) => {
                var sidenav = htmx.find("#sidenav");
                sidenav.style.position = "absolute";
                sidenav.classList.remove("is-tablet-up");
                sidenav.scrollIntoView(alignToTop = true, scrollIntoViewOptions = { behavior: 'smooth' });
                htmx.find("#mobile-menu-burger").classList.add("is-hidden");
                Array.from(sidenav.querySelectorAll('.menu-anchor-text')).forEach(el => el.classList.remove('is-hidden'));
            });
            sideMenu.addEventListener("click", (event) => {
                event.stopImmediatePropagation();
                var sidenav = htmx.find("#sidenav");
                sidenav.style.position = "static";
                sidenav.classList.add("is-tablet-up");
                htmx.find("#mobile-menu-burger").classList.remove("is-hidden");
            });
        }
    </script>
</div>
{%- endmacro %}