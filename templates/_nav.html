{% import "shared/_icons.html" as icon_components %}

{% macro dsp_auth(user) -%}
    {% if user and user.state != "guest"%}
        <div>{{user.name | title}}</div>
        <a class="button" href="/auth/logout">Logout</a>
        <button class='button' hx-post="/api/gmscreen/display" hx-target="#screen-container"
                onclick='htmx.find("#screen-container").style="transform: translateY(0%);";'>
            {{icon_components.keyboard(size="1.5rem")}}
            GM Screen
        </button>

        {% if user.admin %}
        <a class="button" href="/admin/"> {{icon_components.keyboard(size="1.5rem")}}
            Admin
        </a>
        {% endif %}

    {% else %}
        <a href="/auth/login">Login</a>
    {% endif %}
{%- endmacro %}

{% macro topnav(user) -%}
<div id="top-nav" class="grid-x grid-padding-x">
    <!-- logo -->
    <div class="cell small-6 medium-3">
        <a id="logo" class="align-middle" href="/">{{icon_components.dungeon(size="2.5rem")}}Storyteller</a>
        <small class="show-for-medium">ver. 0.2.1</small>
    </div>

    <!-- login -->
    <div class="cell small-6 medium-3 medium-order-3">
        <button class="button float-right" type="button" data-toggle="auth-panel">{{icon_components.character(size="2rem")}}</button>
        <div class="dropdown-pane" id="auth-panel" data-dropdown data-auto-focus="true">
            {{dsp_auth(user)}}
        </div>
    </div>

    <!-- search -->
    <div class="cell small-12 medium-6 align-self-middle" hx-indicator="#request-indicator">
        <div class="input-group">
            <input type="text" autocomplete="off" class="input-group-field"
                placeholder="search"
                   type="search" name="query" hx-post="/api/nav/search" hx-target="#nav-search"
                   hx-trigger="input changed delay:500ms, search"
                   hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
            <div class="input-group-button"><button class="button">{{icon_components.search('1.25rem')}}</button></div>
        </div>
        <ul id="nav-search"></ul>
    </div>
</div>

{%- endmacro %}

{% macro object_menu(user, obj) -%}
<div class="grid-container">
    <div class="grid-x grid-padding-x">
    <div class="cell small-12">
        <ul class="dropdown menu" data-dropdown-menu>
            <li><a href="/{{obj.path}}">{{icon_components.details(size="1rem")}} Overview</a></li>
            <!--<li><a href="/{{obj.path}}/history">{{icon_components.history(size="1rem")}} History</a></li>-->
            <li><a href="/{{obj.path}}/timeline">{{icon_components.timeline(size="1rem")}} Timeline</a></li>
        
            <!--User Specific Stuff? basically associations - let's leave off for now -->
            {% if user.world_user(obj) %}
            <!--<li><a href="/{{obj.path}}/campaigns">{{icon_components.campaigns(size="1rem")}} Campaigns</a></li>
            <li><a href="/{{obj.path}}/stories">{{icon_components.story(size="1rem")}} Stories</a></li>
            <li><a href="/{{obj.path}}/journal">{{icon_components.journal(size="1rem")}} Journal</a></li>-->
            {% endif %}
        
            <!-- Object Dep Options -->
            {% if obj.model_name() in ["Region", "City", "District"] %}
            <li><a href="/{{obj.path}}/jobs">{{icon_components.jobs(size="1rem")}} Job Board</a></li>
            {% endif %}
            {% if obj.model_name() in ["World", "Region", "City", "Location", "District", "Vehicle", "Shop"] %}
            <li><a href="/{{obj.path}}/map">{{icon_components.map(size="1rem")}} Map</a></li>
            {% endif %}
        
            <!-- Object Menus 
            {#{obj.snippet(user, 'menu') | safe}#}-->

        </ul>
    </div>
</div>
{%- endmacro %}

{% macro sidemenu(user, world, obj=None) -%}
<div id="sidenav">
    {% if obj %}
    <nav id="model-menu-container">
        <h4><a href="/{{world.get_world().path}}">{{icon_components.world(size="1rem")}} {{world.get_world().name}}</a></h4>


        <hr>
        <span>
            {{icon_components.search(size="1.25rem")}}
        </span>
        <div class="has-dropdown" style="width:100%;">
            <input type="text" autocomplete="off" class="has-bg-secondary has-text-white"
                   type="search" name="query" hx-post="/api/nav/search" hx-target="#nav-search"
                   hx-trigger="input changed delay:500ms, search"
                   hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
            <ul class="dropdown has-bg-light" id="nav-search">
            </ul>
        </div>

        <ul class="vertical menu">
            <li><a href="/{{obj.path}}/details">{{icon_components.details(size="1rem")}} Details</a></li>
            <li><a href="/{{obj.path}}/history">{{icon_components.history(size="1rem")}} History</a></li>
            <li><a href="/{{obj.path}}/timeline">{{icon_components.timeline(size="1rem")}} Timeline</a></li>
            
            <h6>User Specific Stuff? basically associations</h6>
            {% if user.world_user(obj) %}
            <li><a href="/{{obj.path}}/campaigns">{{icon_components.campaigns(size="1rem")}} Campaigns</a></li>
            <li><a href="/{{obj.path}}/stories">{{icon_components.story(size="1rem")}} Stories</a></li>
            <li><a href="/{{obj.path}}/journal">{{icon_components.journal(size="1rem")}} Journal</a></li>
            {% endif %}

            <h6>Object Dep Options</h6>
            {% if obj.model_name() not in ['Character', 'Creature', 'Item', 'Encounter'] %}
            <li><a href="/{{obj.path}}/jobs">{{icon_components.jobs(size="1rem")}} Job Board</a></li>
            {% endif %}
            {% if obj.model_name() in ["World", "Region", "City", "Location", "District", "Vehicle", "Shop"] %}
            <li><a href="/{{obj.path}}/map">{{icon_components.map(size="1rem")}} Map</a></li>
            {% endif %}
        </ul>
        
        <hr>
        <p>HTMX?</p>
        <span hx-get="/api/nav/sidemenu/{{obj.path}}"
              hx-trigger="load"
              hx-swap="outerHTML">
        </span>
    </nav>

    {% endif %}
</div>
{%- endmacro %}

{% macro topnavold(user) -%}
<nav class="row">
    <div class="column is-shrink is-vertically-centered has-text-center">
        <a href="/">
            <h2>
                {{icon_components.dungeon(size="2.5rem")}}
                Storyteller
            </h2>
        </a>
    </div>
    <div class="column is-shrink is-vertically-centered">
        <small>ver. 0.2.1</small>
    </div>
    <div class="column is-4 is-center is-vertically-centered" hx-indicator="#request-indicator">
        <div class="is-input-group has-bg-secondary">
            <span>
                {{icon_components.search(size="1.25rem")}}
            </span>
            <div class="has-dropdown" style="width:100%;">
                <input type="text" autocomplete="off" class="has-bg-secondary has-text-white"
                       type="search" name="query" hx-post="/api/nav/search" hx-target="#nav-search"
                       hx-trigger="input changed delay:500ms, search"
                       hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
                <ul class="dropdown has-bg-light" id="nav-search">
                </ul>
            </div>
        </div>
    </div>
    {% if user and user.state != "guest"%}
    <div class="column is-shrink is-tablet-up is-vertically-centered is-end">
        <button class='button' hx-post="/api/gmscreen/display" hx-target="#screen-container"
                onclick='htmx.find("#screen-container").style="transform: translateY(0%);";'>
            {{icon_components.keyboard(size="1.5rem")}}
            GM Screen
        </button>
    </div>
    {% endif %}
    <div class="column is-shrink is-tablet-up is-vertically-centered">
        <a href="/">
            <h4>
                {% if user and user.state != "guest"%}
                {{user.name | title}}
                {% endif %}
            </h4>
        </a>
    </div>
    <div class="column is-shrink is-vertically-centered">
        {% if not user or user.state == "guest" %}
        <a href="/auth/login" class="button is-rounded is-small">Login</a>
        {% else %}
        <a href="/auth/logout" class="button is-rounded is-small">Logout</a>
        {% endif %}
    </div>
    {% if user and user.admin %}
    <div class="column is-shrink is-tablet-up is-vertically-centered">
        <a class="button is-small is-rounded" href="/admin/">
            ADMIN
        </a>
    </div>
    {% endif %}
</nav>
{%- endmacro %}

{% macro nav_dropdown(user, obj, objs=[]) -%}
{% for o in objs %}
<li class="menu">
    <a href='/{{o.model_name() | lower}}/{{o.pk}}' target='_blank'>
        <div class="grid-x align-middle">
            <div class="cell small-3">
                {% if o.image %}
                <img src=" {{o.image.url(size=50)}}" alt="{{o.name}}" width="50" />
                {% endif %}
            </div>
            <div class="cell auto">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}

{% macro sidemenu_active(user, obj) -%}
<div id="sidenav"
     class="is-tablet-up has-bg-secondary has-no-padding-bottom has-no-padding-right slide-it-in"
     style='position:relative; z-index:1001; padding-top:1rem;border-radius: 0 10px 10px 0;border-right: solid;border-top: solid;border-bottom: solid;'>
    <div class="row ">
        <div class="column has-no-padding-bottom is-vertically-centered">
            <div class="row slide-it-in">
                <div id="collapse-sidemenu"
                     class="column is-mobile-only is-mobile-3 is-end menu-anchor-text is-hidden">
                    {{icon_components.close()}}
                </div>
            </div>
        </div>
    </div>
    <nav class="menu is-active" id="model-menu-container">
        <ul class="menu__list">
            <li>
                <a href="/{{obj.world.path}}" class="menu-anchor">
                    <div class="row">
                        <div id="menu-world-anchor" class="column is-3 is-mobile-shrink">
                            {{icon_components.world(size="1rem")}}
                        </div>
                        <script>
                            tippy('#menu-world-anchor', {
                                content: '{{obj.world.name}}',
                                placement: 'right',
                                allowHTML: true,
                                arrow: false,
                                animation: 'perspective-extreme',

                            });
                        </script>
                        <div
                             class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                            <h4>{{obj.world.name}}</h4>
                        </div>
                    </div>
                </a>
            </li>
        </ul>
        <p class="menu__divider"></p>
        <span hx-get="/api/nav/sidemenu/{{obj.path}}"
              hx-trigger="load"
              hx-swap="outerHTML">
        </span>
        <p class="menu__divider"></p>
        <ul class="menu__list">
            <li>
                <a href="" class="menu-anchor"
                   hx-get="/api/{{obj.path}}/associations"
                   hx-target="#page-content"
                   hx-indicator="#request-indicator"
                   hx-swap="innerHTML show:#page-content:top"
                   hx-push-url="/{{obj.path}}/associations">
                    <div class="row">
                        <div id='menu-associations-anchor' class="column is-3 is-mobile-shrink">
                            {{icon_components.associations(size="1rem")}}
                        </div>
                        <script>
                            tippy('#menu-associations-anchor', {
                                content: 'Associations',
                                placement: 'right',
                                allowHTML: true,
                                arrow: false,
                                animation: 'perspective-extreme',

                            });
                        </script>
                        <div
                             class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                            <span>Associations</span>
                        </div>
                    </div>
                </a>
            </li>
        </ul>
        <ul class="menu__list" id='child-object-submenu'>
            {% for model in obj.world.all_models_str() %}
            <li>
                <div class="row" style='position:relative;'>
                    <div class="column has-no-padding">
                        <a href="/{{obj.path}}/associations/{{model | lower}}" class="menu-anchor"
                           hx-get="/api/{{obj.path}}/associations/{{model | lower}}"
                           hx-target="#page-content"
                           hx-indicator="#request-indicator"
                           hx-swap="innerHTML show:#content:top"
                           hx-push-url="/{{obj.path}}/associations/{{model | lower}}">
                            <div class="row">
                                <div id='menu-{{model | lower}}-anchor'
                                     class="column is-3 is-mobile-shrink">
                                    {{obj.world.get_icon(model)}}
                                </div>
                                <script>
                                    tippy('#menu-{{model | lower}}-anchor', {
                                        content: '{{obj.world.get_title(model)}}',
                                        placement: 'right',
                                        allowHTML: true,
                                        arrow: false,
                                        animation: 'perspective-extreme',

                                    });
                                </script>
                                <div
                                     class="column is-9 is-mobile-9 is-hidden slide-it-in menu-anchor-text">
                                    <span>{{obj.world.get_title(model)}}</span>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </nav>
    <script>
        var timeout = null;
        var sideMenu = document.getElementById('sidenav');
        var isOpen = false;
        if ((window.innerWidth <= 850)) {
            htmx.find('#mobile-menu-burger').addEventListener("click", (event) => {
                var sidenav = htmx.find("#sidenav");
                sidenav.style.position = "absolute";
                sidenav.classList.remove("is-tablet-up");
                sidenav.scrollIntoView(alignToTop = true, scrollIntoViewOptions = { behavior: 'smooth' });
                htmx.find("#mobile-menu-burger").classList.add("is-hidden");
                Array.from(sidenav.querySelectorAll('.menu-anchor-text')).forEach(el => el.classList.remove('is-hidden'));
            });
            sideMenu.addEventListener("click", (event) => {
                event.stopImmediatePropagation();
                var sidenav = htmx.find("#sidenav");
                sidenav.style.position = "static";
                sidenav.classList.add("is-tablet-up");
                htmx.find("#mobile-menu-burger").classList.remove("is-hidden");
            });
        }
    </script>
</div>
{%- endmacro %}