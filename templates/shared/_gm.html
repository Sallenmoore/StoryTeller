{% import "shared/_form.html" as form_components %}
{% import "shared/_display.html" as display_components %}
{% import "shared/_icons.html" as icon_components %}
{% import "shared/_tasks.html" as task_components %}

{% macro gm(user, world, party=None) -%}
<title>{{world.name | title}} - Auto GM</title>
<div id='auto-gm-container' class="row">
    {% if party and party.last_scene and party.last_scene.prompt %}
    <div class="column is-full" style='position:relative;'>
        <button class='button is-small' style='position:absolute; top:0; right:0;'
                onclick='this.nextElementSibling.classList.toggle("is-hidden");'>
            View Prompt
        </button>
        <div class="panel has-bg-muted has-text-dark is-hidden">
            <pre
                 style='overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;'>{{party.last_scene.prompt | safe }}
            </pre>
        </div>
    </div>
    {% endif %}
    {% if not party %}
    <div id="party-selection-form-container" class="column is-full">
        <form hx-post='/api/autogm/{{party.path}}'
              hx-target='#page-content'
              hx-trigger='change'
              onsubmit='history.pushState({}, "", `/faction/${this.querySelector("#partypk").value}/gm`);'>
            <div class="row has-centered">
                <div class="column is-shrink is-vertically-centered">
                    <div class="is-select">
                        <select class='has-text-center' name='partypk' id='partypk'>
                            <option>==Select Party==</option>
                            {% for p in world.parties %}
                            <option value="{{p.pk}}" {% if p.pk==party.pk %} selected {% endif %}>
                                {{ p.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </form>
    </div>
    {% elif not party.next_scene %}
    <div id="autogm-start-session-container" class="column is-full">
        {{ autogm_start_session(user, world, party) }}
    </div>
    {% elif party.next_scene.gm_mode == 'gm' %}
    <div id="autogm-gm-session-container" class="column is-full">
        {{ autogm_gm_session(user, world, party) }}
    </div>
    {% else %}
    <div id="autogm-pc-session-container" class="column is-full">
        {{ autogm_pc_session(user, world, party) }}
    </div>
    {% endif %}
</div>
<script>
    var music = new Audio();
    music.volume = 0.25;
    var gm = new Audio();
    gm.volume = 1;

    function gmvoiced(voicefile, musicfile) {
        console.log(gm.paused);
        if (!gm.paused) {
            gm.pause();
            music.pause();
        } else {
            music.src = musicfile;
            music.loop = true;
            music.volume = 0.1;
            music.currentTime = 0;
            music.play();
            gm.src = voicefile;
            gm.volume = 1;
            gm.currentTime = 0;
            gm.play();
        }
    }

    function set_roll_modifier(elem) {
        var modifier = elem.querySelector('p').textContent.split('(')[1].split(')')[0];
        modifier = parseInt(modifier);
        if (modifier >= 0) {
            htmx.find("#pc_roll_modifier").value = `+${modifier}`;
        } else {
            htmx.find("#pc_roll_modifier").value = `-${Math.abs(modifier)}`;
        }
    }
</script>
{%- endmacro %}

{% macro autogm_start_session(user, world, party) -%}
<div id='party-members-list' class="row has-space-around">
    {% for member in party.characters %}
    <div class="column is-3">
        <div class="panel">
            {{display_components.object_display(member, type=False)}}
        </div>
    </div>
    {% endfor %}
</div>
<form hx-post="/api/autogm/{{party.path}}"
      hx-target='#page-content'
      hx-push-url='/{{party.path}}/gm'>
    <input type='hidden' name='partypk' value='{{party.pk}}'>
    <div class="row has-centered">
        <div class="column is-shrink is-vertically-centered">
            <div class="panel has-bg-muted">
                <div class="is-select">
                    <select name='gmmode' style='font-size: 1.5rem;'>
                        <option value='pc'>as Party</option>
                        <option value='gm'>as GM</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="column is-shrink is-vertically-centered">
            <button type='submit' class="button">
                Start Session
            </button>
        </div>
    </div>
</form>
{%- endmacro %}

{% macro autogm_pc_session(user, world, party) -%}
<h2 class="has-text-primary">Player Session</h2>
{# needed to contain floated image #}
{% if party.last_scene %}
{{ scene_description(user, world, party) }}
{{ scene_dice_results(user, world, party) }}
{% endif %}
<hr>
{{ scene_players_display(user, world, party) }}
<hr>
{{ scene_quest_log(user, world, party) }}
<hr>
<div class="row">
    <div class="column">
        {{scene_associations(user, world, party)}}
    </div>
    <div id="autogm-gm-form" class="column">
        <div class="row has-space-around">
            <div class="column is-full is-vertically-centered">
                <form hx-post="/api/autogm/{{party.pk}}/update"
                      hx-trigger='input delay:1s, from:#continue-session-button' hx-swap='none'>
                    <div class="panel has-text-center has-bg-muted">
                        <div class="row has-space-around">
                            <div class="column is-shrink is-vertically-centered">
                                <h4 class='has-text-primary has-text-center'>Date</h4>
                                <input class="has-text-center" type="string" name="date" id="date"
                                       value='{{party.next_scene.date or party.world.current_date}}'>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="column is-full">
                {% if party.last_scene.roll_required %}
                <div class="panel has-text-center has-bg-muted is-full">
                    <h4 class="has-text-screen has-text-center">Roll Required</h4>
                    <form id="pc-roll-form" hx-post="/api/autogm/{{party.pk}}/update"
                          hx-trigger='submit, from:#continue-session-button'
                          hx-target='#pc-roll-form' hx-select='#pc-roll-form' hx-swap='outerHTML'>
                        <div class='row has-centered'>
                            <div class="column is-1">
                                <div class="panel has-bg-muted has-text-center">
                                    <input type="number" value="1" name="pc_roll_num_dice">
                                </div>
                            </div>
                            <div class="column is-shrink">
                                <p class='has-text-primary'
                                   style='font-size: 1.5rem; font-weight: bold;'>D</p>
                            </div>
                            <div class="column is-1">
                                <div class="is-select">
                                    <select name="pc_roll_type_dice">
                                        <option value='4'>4</option>
                                        <option value='6'>6</option>
                                        <option value='8'>8</option>
                                        <option value='10'>10</option>
                                        <option value='12'>12</option>
                                        <option value='20' selected>20</option>
                                        <option value='100'>100</option>
                                    </select>
                                </div>
                            </div>
                            <div class="column is-2">
                                <div
                                     class="panel has-bg-muted has-text-center is-vertically-centered">
                                    <input type="text"
                                           value="+0"
                                           name="pc_roll_modifier" id="pc_roll_modifier">
                                </div>
                            </div>
                            <div class="column is-shrink is-vertically-centered">
                                <button class=" button" type='submit'>Roll</button>
                            </div>
                            <div class="column is-shrink is-vertically-centered is-end">
                                <h3 class="has-text-center">Roll Results</h3>
                                <div
                                     class="panel has-bg-white has-text-center is-vertically-centered">
                                    <h1 class='has-text-dark'>{{party.next_scene.roll_result or ""}}
                                    </h1>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
            <div class="column is-full">
                {{autogm_submit_session(user, world, party)}}
            </div>
        </div>
    </div>
</div>
{%- endmacro %}


{% macro autogm_gm_session(user, world, party) -%}
<h2 class="has-text-primary">GM Session</h2>

<div class="panel has-bg-white generated-text-lightbg">
    {# needed to contain floated image #}
    {% if party.last_scene %}
    <div class="row has-space-around">
        {% if party.last_scene.image %}
        <div class="column is-4">
            <div class="image is-tile is-margin-center">
                <img src="{{party.last_scene.image.url()}}"
                     loading="lazy"
                     alt="{{party.name}}" />
            </div>
        </div>
        {% endif %}
        {% if party.last_scene.roll_result %}
        <div class="column">
            <div class="panel generated-text-darkbg has-bg-screen">
                {{party.last_scene.description | safe}}
            </div>
            <hr>
            <div class="panel has-bg-muted">
                <h4>{{party.last_scene.roll_player.name}} rolled
                    {{party.last_scene.roll_formula}} for a
                    {{party.last_scene.roll_attribute | title}}
                    {{party.last_scene.roll_type | title}} with a result of:
                    {{party.last_scene.roll_result}}
                </h4>
            </div>
            <section class='section'>
                {{party.last_scene.roll_description}}
            </section>
        </div>
        {% endif %}
    </div>
    {% endif %}
    <div class="row">
        <div class="column is-full">
            <hr>
            {{scene_players_display(user, world, party)}}
        </div>
    </div>
</div>
<div class="row">
    <div class="column">
        {{scene_associations(user, world, party)}}
    </div>
    <div id="autogm-gm-form" class="column">
        <div class="row has-space-around">
            <div class="column is-full is-vertically-centered">
                <form hx-post="/api/autogm/{{party.pk}}/update"
                      hx-trigger='input delay:1s, from:#continue-session-button' hx-swap='none'>
                    <div class="row">
                        <div class="column is-full is-vertically-centered">
                            <h3 class='has-text-center has-text-primary'>Scenario</h3>
                            {{form_components.texteditor(user, party.next_scene, "description", content=party.next_scene.description or "")}}
                        </div>
                    </div>
                    <div class="panel has-text-center has-bg-muted">
                        <div class="row has-space-around">
                            <div class="column is-shrink is-vertically-centered">
                                <label class='has-text-primary'>Scene Type</label>
                                <div class="select" style="width: 100%;">
                                    <select name="scene_type" id="scene_type">
                                        {% for st in ["social", "combat", "exploration",
                                        "stealth"]
                                        %}
                                        <option value="{{st}}">
                                            {{st | title}}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="column is-shrink is-vertically-centered">
                                <label class='has-text-primary' for="date">Date</label>
                                <input type="string" name="date" id="date"
                                       value='{{party.next_scene.date or party.world.current_date}}'>
                            </div>
                            <div class="column is-shrink is-vertically-centered">
                                <h4 class="has-text-screen has-text-center">Roll Required</h4>
                                <div class='row has-centered'>
                                    <div class="column is-shrink">
                                        <div class="is-select">
                                            <select name="pc_roll_player">
                                                <option value=''>== Select Player ==</option>
                                                {% for pc in party.players %}
                                                <option value='{{pc.pk}}'>{{pc.name}}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="column is-shrink has-text-dark">
                                        needs to make a
                                    </div>
                                    <div class="column is-shrink">
                                        <div class="panel has-bg-muted has-text-center">
                                            <div class="is-select">
                                                <select name="pc_roll_attribute">
                                                    {% for attr in ['strength', 'dexterity',
                                                    'constitution',
                                                    'intelligence', 'wisdom', 'charisma'] %}
                                                    <option value='{{attr}}'>{{attr | title}}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="column is-shrink">
                                        <div class="is-select">
                                            <select class="has-text-center"
                                                    name="pc_roll_type">
                                                <option value='Ability Check'>Ability Check
                                                </option>
                                                <option value='Saving Throw'>Saving Throw
                                                </option>
                                                {% if party.next_scene.type == "combat" %}
                                                <option value='Attack'>Attack</option>
                                                <option value='Damage'>Damage</option>
                                                {% endif %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="column is-full">
                {{autogm_submit_session(user, world, party)}}
            </div>
        </div>
    </div>
</div>
{%- endmacro %}

{% macro scene_intermission(user, world, party, task_complete=False) -%}
<div id="scene-intermission-container" class='row has-space-around'>
    {% if task_complete %}
    <div class='column is-full'>
        <button class="button is-full" hx-post="/api/autogm/{{party.path}}"
                hx-target="#page-content">
            Next Scene
        </button>
    </div>
    {% endif %}
    {% if party.quests %}
    <div class="column is-full">
        {{scene_quest_log(user, world, party)}}
    </div>
    {% endif %}
    <div class="column is-full">
        <div class="panel has-bg-light">
            <div class="row">
                <div class="column is-full">
                    <div class="row has-centered">
                        {% for ags in party.autogm_summary %}
                        {% if ags.image %}
                        <div class="column is-shrink">
                            <div class="image is-large">
                                <img src="{{ags.image.url()}}"
                                     loading="lazy"
                                     alt="{{party.name}}" />
                            </div>
                        </div>
                        {% endif%}
                        {% endfor %}
                    </div>
                </div>
                {%if party.last_scene and party.last_scene.summary %}
                <div class="column is-full">
                    <div class='generated-text-lightbg'>
                        {{party.last_scene.summary | safe}}
                    </div>
                </div>
                {% endif %}

            </div>
        </div>
    </div>
    <div class="column is-full">
        <div class="tabs has-border">
            <ul class="tabs__list">
                {% for player in party.players %}
                <li onclick='htmx.find("#player-{{player.pk}}-card-container").scrollIntoView({ behavior: "smooth"});'
                    style='border-radius: 5px 5px 0 0;'>
                    <h5>{{player.name}}</h5>
                </li>
                {% endfor %}
            </ul>
        </div>
        <div id="player-card-panels" class="row has-space-around">
            {% for player in party.players %}
            <div id="player-{{player.pk}}-card-container"
                 class="column is-full {% if false %} is-hidden {% endif%}">
                {{display_components.card(player)}}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{%- endmacro %}

{% macro autogm_submit_session(user, world, party) -%}
<div class="row has-space-around">
    <div class="column is-shrink is-vertically-centered">
        <button id='continue-session-button' class="button"
                hx-post="/task/generate/autogm/{{party.pk}}"
                hx-target='#auto-gm-container'
                hx-push-url='/{{party.path}}/gm'>
            {% if party.autogm_summary %}
            Continue Session
            {% else %}
            Start Session
            {% endif %}
        </button>
    </div>
    {% if party.autogm_summary %}
    <div class="column is-shrink is-vertically-centered">
        <button id='regenerate-session-button' class="button has-bg-light-grey"
                hx-post="/task/generate/autogm/gm/{{party.pk}}/regenerate"
                hx-target='#auto-gm-container'
                hx-push-url='/{{party.path}}/gm'>
            Regenerate Session
            </buttonid>
    </div>
    <div class="column is-shrink is-vertically-centered">
        <button class="button is-small has-bg-muted has-text-screen"
                hx-post="/api/autogm/{{party.pk}}/canonize"
                hx-target='#auto-gm-container'
                hx-select='#auto-gm-container'
                hx-swap='outerHTML'
                hx-confirm='This will canonize events from the current session. Are you sure you want to do this?'
                hx-push-url='/{{party.path}}/gm'>
            Canonize Session
        </button>
    </div>
    {% endif %}
    <div class="column is-shrink is-vertically-centered">
        <button class="button is-small has-bg-muted has-text-screen"
                hx-post="/api/autogm/{{party.pk}}/clear"
                hx-target='#auto-gm-container'
                hx-select='#auto-gm-container'
                hx-swap='outerHTML'
                hx-confirm='This will clear the current session. Are you sure you want to do this?'
                hx-push-url='/{{party.path}}/gm'>
            {% if party.autogm_summary %}
            Clear Session
            {% else %}
            Restart Session
            {% endif %}
        </button>
    </div>
</div>
{%- endmacro %}

{% macro scene_players_display(user, world, party) -%}
<div class="panel hs-bg-muted">
    <h2 class='has-text-center has-text-white'>Party Members</h2>
    <div class="row has-space-around">
        {% for player in party.players %}
        <div class="column">
            <h3 class='has-text-center has-text-muted'>{{player.name}}</h3>
            <div class="row has-space-between">
                <div class="column is-shrink is-vertically-centered" style='position:relative;'>

                    {{display_components.object_display(player, name=False, type=False)}}

                    {% if party.gm_mode == 'gm' and party.last_scene and
                    party.last_scene.get_player_message(player)%}
                    <button class="button is-small has-bg-muted has-text-screen"
                            style='position: absolute; top: 0; right: 0;'
                            onclick='gmvoiced("/audio/{{party.last_scene.get_player_message(player).pk}}", "{{party.last_scene.music}}");'>
                        <iconify-icon icon="mdi:speaking" width="1rem"></iconify-icon>
                    </button>
                    {% endif %}
                </div>
                <div class="column">
                    <div class="panel has-bg-screen has-no-padding-bottom">
                        <div class="row has-space-around">
                            <div class="column is-shrink is-mobile-4"
                                 onclick='set_roll_modifier(this);'>
                                <h6 class='has-text-white'>STR</h6>
                                <p style="font-size: 0.75rem;" class='has-text-white'>
                                    {{player.strength}}
                                    ({{(player.strength|int-10)//2}})
                                </p>
                            </div>
                            <div class="column is-shrink">
                                <iconify-icon icon="pepicons-print:line-y"
                                              height='3rem'></iconify-icon>
                            </div>
                            <div class="column is-shrink is-mobile-4 has-text-center"
                                 onclick='set_roll_modifier(this);'>
                                <h6 class='has-text-white'>DEX</h6>
                                <p style="font-size: 0.75rem;" class='has-text-white'>
                                    {{player.dexterity}}
                                    ({{(player.dexterity|int-10)//2}})
                                </p>
                            </div>
                            <div class="column is-shrink">
                                <iconify-icon icon="pepicons-print:line-y"
                                              height='3rem'></iconify-icon>
                            </div>
                            <div class="column is-shrink is-mobile-4 has-text-center"
                                 onclick='set_roll_modifier(this);'>
                                <h6 class='has-text-white'>INT</h6>
                                <p style="font-size: 0.75rem;" class='has-text-white'>
                                    {{player.intelligence}}
                                    ({{(player.intelligence|int-10)//2}})
                                </p>
                            </div>
                        </div>
                        <div class="row has-space-around">
                            {# <div class="column is-shrink">
                                <iconify-icon icon="pepicons-print:line-y"
                                              height='3rem'></iconify-icon>
                            </div> #}
                            <div class="column is-shrink is-mobile-4 has-text-center"
                                 onclick='set_roll_modifier(this);'>
                                <h6 class='has-text-white'>WIS</h6>
                                <p style="font-size: 0.75rem;" class='has-text-white'>
                                    {{player.wisdom}}
                                    ({{(player.wisdom|int-10)//2}})
                                </p>
                            </div>
                            <div class="column is-shrink is-mobile-shrink">
                                <iconify-icon icon="pepicons-print:line-y"
                                              height='3rem'></iconify-icon>
                            </div>
                            <div class="column is-shrink is-mobile-4 has-text-center"
                                 onclick='set_roll_modifier(this);'>
                                <h6 class='has-text-white'>CHA</h6>
                                <p style="font-size: 0.75rem;" class='has-text-white'>
                                    {{player.charisma}}
                                    ({{(player.charisma|int-10)//2}})
                                </p>
                            </div>
                            <div class="column is-shrink is-mobile-shrink">
                                <iconify-icon icon="pepicons-print:line-y"
                                              height='3rem'></iconify-icon>
                            </div>
                            <div class="column is-shrink is-mobile-4 has-text-center"
                                 onclick='set_roll_modifier(this);'>
                                <h6 class='has-text-white'>CON</h6>
                                <p style="font-size: 0.75rem;" class='has-text-white'>
                                    {{player.constitution}}
                                    ({{(player.constitution|int-10)//2}})
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% if party.next_scene.gm_mode == 'gm' and party.last_scene and
            party.last_scene.get_player_message(player) %}
            <div class="row">
                {# <div class="column is-shrink">
                    <div class="panel has-bg-muted">
                        <span style='font-weight: bolder;'>Tone:</span>
                        <span
                              style='font-size: 0.75rem;'>{{party.last_scene.get_player_message(player).emotion}}
                        </span>
                    </div>
                </div> #}
                <div class="column">
                    <div class="panel has-bg-muted">
                        <span style='font-weight: bolder ;'>Intentions:</span>
                        <span
                              style='font-size: 0.75rem;'>{{party.last_scene.get_player_message(player).intent}}</span>
                    </div>
                </div>
                <div class="column is-full">
                    <div class="panel has-bg-light has-text-dark">
                        {{party.last_scene.get_player_message(player).message | safe}}
                    </div>
                </div>
            </div>
            {% elif party.last_scene and party.next_scene.gm_mode == 'pc' %}
            <form hx-post='/api/autogm/{{party.pk}}/update' hx-swap='none'
                  hx-trigger='input delay:1s, from:#continue-session-button'>
                <input type='hidden' name='message.playerpk' value='{{player.pk}}'>
                <div class="row">
                    <div class="column is-full">
                        <div class="panel has-bg-light has-text-dark">
                            <label class='has-text-dark'>{{player.name}}'s Response</label>
                            {{ form_components.texteditor(user, player, "player_message", content="", name="message.player_message") }}
                        </div>
                    </div>
                    <div class="column">
                        <div class="panel has-bg-light">
                            <label class='has-text-dark'>Intentions</label>
                            <input type="text" name="message.intentions" />
                        </div>
                    </div>
                    <div class="column is-shrink">
                        <div class="panel has-bg-light">
                            <label class='has-text-dark'>Emotion</label>
                            <div class="is-select">
                                <select name="message.emotion">
                                    <option value='happy'>Happy</option>
                                    <option value='playful'>Playful</option>
                                    <option value='confident'>Confident</option>
                                    <option value='curious'>Curious</option>
                                    <option value='steady' selected>Steady</option>
                                    <option value='impatient'>Impatient</option>
                                    <option value='wary'>Wary</option>
                                    <option value='sad'>Sad</option>
                                    <option value='afraid'>Afraid</option>
                                    <option value='desperate'>Desperate</option>
                                    <option value='angry'>Angry</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            {% endif%}
        </div>
        {% endfor %}
    </div>
</div>
{%- endmacro %}

{% macro scene_description(user, world, party)%}
<div class="panel has-bg-white generated-text-lightbg" style='position:relative;'>
    <div class="row">
        <div class="column is-full">
            {% if party.last_scene.image %}
            <div class="is-float-right"
                 style="position:relative; padding-left: 2rem; padding-bottom: 2rem;">
                <div class="image is-extra-large is-tile is-margin-center">
                    <img src="{{party.last_scene.image.url()}}"
                         loading="lazy"
                         alt="{{party.name}}" />
                </div>
            </div>
            {% endif %}
            {% if party.last_scene.audio %}
            <button class="button is-small has-bg-screen"
                    style='position: absolute; top: 0; right: 0;'
                    onclick='gmvoiced("/audio/gm/{{party.last_scene.pk}}", "{{party.last_scene.music}}");'>
                <iconify-icon icon="mdi:speaking" width="2.5rem"></iconify-icon>
            </button>
            {% endif %}
            {{party.last_scene.description | safe}}
        </div>
    </div>
</div>
{%- endmacro %}

{% macro scene_description_edit(user, world, party) -%}
<div class="panel">
    <h3 class='has-text-center'> Scene Description </h3>
    <form hx-post='/api/autogm/{{party.pk}}/update'
          hx-trigger='input delay:1s, from:#continue-session-button'
          hx-swap='none'>
        {{ form_components.texteditor(user, party.next_scene, "description", content=party.next_scene.description) }}
    </form>
</div>
{%- endmacro %}

{% macro scene_associations(user, world, party)%}
<div id='autogm-associations-list-container' class="row has-space-around">
    <div class="column is-half">
        <h4 class='has-text-center has-text-primary'>Search Associations</h4>
        <div class="has-dropdown" style="width: 100%;">
            <input class="has-bg-light" autocomplete="off" type="search"
                   name="query"
                   style="border-bottom: solid #000;"
                   hx-post="/api/autogm/{{party.pk}}/associations/search"
                   hx-target="#autogm-new-associations-list"
                   hx-trigger="input changed delay:500ms consume"
                   hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
            <ul class="dropdown has-bg-light" id="autogm-new-associations-list">
            </ul>
        </div>
    </div>
    <div class="column is-half">
        <h4 class='has-text-center has-text-primary'>Create a new...</h4>
        <div class="row has-centered">
            {% for child in party.all_models() %}
            <div class="column is-shrink">
                <button class="button is-primary is-small"
                        hx-post="/api/autogm/{{party.pk}}/associations/add/{{child.__name__ | lower}}"
                        hx-target="#page-content"
                        hx-indicator='#request-indicator'>
                    {{party.get_title(child)}}
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="column is-full">
        <div class="panel has-bg-screen">
            <div id='autogm-associations-list' class="row has-space-around">
                {% for a in party.next_scene.get_additional_associations() %}
                <div class="column is-3 has-centered autogm-association-entry">
                    {{display_components.object_display(a, size="small")}}
                    <div class="row has-space-around">
                        <div class="column is-shrink"
                             style='font-size: 0.75rem;'>
                            <a class="has-text-primary"
                               hx-post="/api/autogm/{{party.pk}}/scene/add/{{a.path}}"
                               hx-target='#autogm-associations-list-container'
                               hx-select='#autogm-associations-list-container'
                               hx-swap='outerHTML'>
                                {{icon_components.add(size='1.25rem')}}
                            </a>
                            Add to Scene
                        </div>
                        <div class="column is-shrink">
                            <a hx-post="/api/autogm/{{party.pk}}/association/remove/{{a.path}}"
                               hx-target='closest .autogm-association-entry'
                               hx-swap='delete'>
                                {{icon_components.remove(size='1rem')}}
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="column is-full">
        {{autogm_scene_objects(user, world, party)}}
    </div>
</div>
{%- endmacro %}

{% macro autogm_association_search(user, party, results) %}
{% for o in results %}
<li class="dropdown__link has-bg-muted">
    <a hx-post="/api/autogm/{{party.pk}}/associations/add/{{o.path}}"
       hx-target='#autogm-associations-list'
       hx-select='#autogm-associations-list' hx-swap='outerHTML'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
        <div class="row">
            <div class="column is-shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="column">
                {{ o.name }}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro %}

{% macro autogm_scene_objects(user, world, party) -%}
<div id="autogm_scene_objects" class="row has-space-around">
    {% if party.next_scene.get_npcs() %}
    <div class="column is-shrink">
        <div class="panel has-bg-screen">
            <h4 class="has-text-center">NPCs</h4>
            <div class="row">
                {% for npc in party.next_scene.npcs%}
                <div id="npc-{{npc.pk}}" class='column is-shrink' style='position:relative;'>
                    {% if npc.image %}
                    {{display_components.object_display(npc)}}
                    <a style="position:absolute;bottom:0;right:0;"
                       hx-post="/api/autogm/{{party.pk}}/scene/remove/{{npc.path}}"
                       hx-target='closest .column'
                       hx-swap='delete'>
                        {{icon_components.remove(size='1rem')}}
                    </a>
                    {% else %}
                    <div hx-post="/api/autogm/{{party.path}}"
                         hx-target='#npc-{{npc.pk}}'
                         hx-select='#npc-{{npc.pk}}'
                         hx-trigger='load delay:3s'
                         hx-swap='outerHTML'>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% if party.next_scene.combatants %}
    <div class="column is-shrink">
        <div class="panel has-bg-screen">
            <h4 class="has-text-center">Combatants</h4>
            <div class="row has-space-around">
                {% for cbt in party.next_scene.combatants%}
                <div id="cbt-{{cbt.pk}}" class='column is-shrink'>
                    {% if cbt.image %}
                    {{display_components.object_display(cbt)}}
                    <a style="position:absolute;bottom:0;right:0;"
                       hx-post="/api/autogm/{{party.pk}}/scene/remove/{{cbt.path}}"
                       hx-target='closest .column'
                       hx-swap='delete'>
                        {{icon_components.remove(size='1rem')}}
                    </a>
                    {% else %}
                    <div hx-post="/api/autogm/{{party.path}}"
                         hx-target='#cbt-{{cbt.pk}}'
                         hx-select='#cbt-{{cbt.pk}}'
                         hx-trigger='load delay:3s'
                         hx-swap='outerHTML'>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% if party.next_scene.places %}
    <div class="column is-shrink">
        <div class="panel has-bg-screen">
            <h4 class="has-text-center">Places</h4>
            <div class="row has-space-around">
                {% for plc in party.next_scene.places%}
                <div id="plc-{{plc.pk}}" class='column is-shrink'>
                    {% if plc.image %}
                    {{display_components.object_display(plc)}}
                    <a style="position:absolute;bottom:0;right:0;"
                       hx-post="/api/autogm/{{party.pk}}/scene/remove/{{plc.path}}"
                       hx-target='closest .column'
                       hx-swap='delete'>
                        {{icon_components.remove(size='1rem')}}
                    </a>
                    {% else %}
                    <div hx-post="/api/autogm/{{party.path}}"
                         hx-target='#plc-{{plc.pk}}'
                         hx-select='#plc-{{plc.pk}}'
                         hx-trigger='load delay:3s'
                         hx-swap='outerHTML'>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% if party.next_scene.loot %}
    <div class="column is-shrink">
        <div class="panel is-full has-bg-screen">
            <h4 class="has-text-center">Loot</h4>
            <div class="row has-space-around">
                {% for loot in party.next_scene.loot %}
                <div id="loot-{{loot.pk}}" class='column is-shrink'>
                    {% if loot.image %}
                    {{display_components.object_display(loot)}}
                    <a style="position:absolute;bottom:0;right:0;"
                       hx-post="/api/autogm/{{party.pk}}/scene/remove/{{loot.path}}"
                       hx-target='closest .column'
                       hx-swap='delete'>
                        {{icon_components.remove(size='1rem')}}
                    </a>
                    {% else %}
                    <div hx-post="/api/autogm/{{party.path}}"
                         hx-target='#loot-{{loot.pk}}'
                         hx-select='#loot-{{loot.pk}}'
                         hx-trigger='load delay:3s'
                         hx-swap='outerHTML'>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{%- endmacro %}

{% macro scene_dice_results(user, world, party)%}
{% if party.last_scene and party.last_scene.roll_required%}
<div class="row">
    <div class="column is-full">
        <div class="panel has-bg-muted">
            <div class="row has-space-around">
                <div class="column is-3 is-vertically-centered">
                    <h3 class='has-text-dark-grey'>
                        {{party.last_scene.roll_attribute | title}}
                        {{party.last_scene.roll_type | title}}
                    </h3>
                </div>
                <div class="column">
                    <div
                         class='panel has-text-light has-text-justify generated-text-lightbg'>
                        {{party.last_scene.roll_description}}
                    </div>
                </div>
                {% if party.next_scene.gm_mode == 'gm' %}
                <div class="column is-3">
                    <h3 class='has-text-primary has-text-center'>Roll Results</h3>
                    <div class='panel has-bg-muted has-text-screen has-text-center'
                         style='font-size:2rem;'>
                        <h2 class='has-text-primary'>
                            {{party.last_scene.roll_result}}
                        </h2>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{%- endmacro %}

{% macro scene_quest_log(user, world, party) -%}
<div id="scene_quest_log"
     class="panel has-bg-muted has-text-primary has-no-padding-left has-no-padding-right ">

    <h3 class='has-text-center has-text-primary'> Quest Log </h3>

    <div class="panel has-bg-white has-text-primary" style='border-top-left-radius: 0;
border-top-right-radius:0;'>

        {% for quest in party.next_scene.quest_log %}
        <div class="row has-space-between"
             onclick='this.querySelector("#quest-{{quest.pk}}").classList.toggle("is-hidden");'>
            <div class="column is-shrink">
                {% if party.next_scene.current_quest == quest%}
                <span class='tag is-muted'>
                    Current Quest
                </span>
                {% else %}
                <button class='button is-small has-bg-screen'
                        hx-post='/api/autogm/party/{{party.pk}}/quest/current/{{quest.pk}}'
                        hx-target='#scene_quest_log'
                        hx-select='#scene_quest_log' hx-swap='outerHTML'>
                    Set as Current Quest
                </button>
                {% endif %}
            </div>
            <div class="column is-shrink has-text-center is-vertically-centered">
                <h3 class="has-text-primary has-text-center">
                    {{quest.name}}
                </h3>
                <span class="tag">{{quest.status | title}}</span>
            </div>
            <div class="column is-shrink is-vertically-centered">
                <button class='button is-small has-bg-dark-grey'
                        hx-post='/api/autogm/party/{{party.pk}}/quest/delete/{{quest.pk}}'
                        hx-target='closest .row' hx-swap='delete'>
                    Remove Quest
                </button>
            </div>
            <div id="quest-{{quest.pk}}" class="column is-full is-vertically-centered is-hidden">
                <div class="row">
                    <div class="column has-text-primary">
                        <h5 class="has-text-primary has-text-center">Objective</h5>
                        <div class="panel has-bg-muted">
                            {{quest.description | safe}}
                        </div>
                    </div>
                    <div class="column">
                        <h5 class="has-text-primary has-text-center">Importance</h5>
                        <div class="panel has-bg-muted">{{quest.importance | safe}}</div>
                    </div>
                    <div class="column is-full">
                        <h5 class="has-text-primary has-text-center">Next Actions</h5>
                        <div class='panel'>
                            <p class="has-text-white">{{quest.next_steps | safe}}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        {% endfor %}
    </div>
</div>
{%- endmacro %}