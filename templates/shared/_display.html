{% import "shared/_abilities.html" as abilities_components %}
{% import "shared/_icons.html" as icon_components %}


{% macro dsp_associations(user, obj, items, title) -%}
<h3>{{title}}</h3>
<div class="grid-x  grid-padding-x">
    {% for item in items %}
        {{dsp_object_thumbnail(item, type=False, dim=250)}}
    {% endfor %}
</div>
{%- endmacro %}

{% macro dsp_all_associations(user, obj) -%}
    {% set related = { 
        "characters": "Characters",
        "encounters": "Encounters",
        "items": "Items",
        "locations": "Locations",
        "districts": "Districts",
        "cities": "Cities",
        "regions": "Regions",
        "shops": "Shops",
        "creatures": "Creatures",
        "vehicles": "Vehicles",
        "factions": "Factions",
    } %}

    {% for attr, title in related.items() %}
        {% if obj[attr] %}
            {{ dsp_associations(user, obj, obj[attr], title) }}
        {% endif %}
    {% endfor %}
{%- endmacro %}

{% macro dsp_object_title(user, obj) -%}
<div class="grid-x grid-padding-x">
    <div class="cell small-12 medium-10 medium-offset-1 text-center">
        <a href=' /{{obj.path}}'>
            <h1 id="object-title">{{obj.name or obj.title}}</h1>
        </a>
    </div>
    {% if user.world_user(obj) %}
    <div class="cell small-12 medium-1 float-right">
        <a href="/manage/{{obj.path}}">{{icon_components.gear()}}</a>
    </div>
    {% endif %}
</div>
{% endmacro %}

{% macro dsp_object_thumbnail(obj, dim="250", name=True, date=False, type=True, pk=False, modal=False) -%}
    
    <div class="cell small-4 large-3">
        <a href="/{{obj.path}}" target="_blank">
            {% if obj.image %}
            <img src="{{obj.image.url(size=dim)}}" loading="lazy" alt="{{obj.name}}" />
            {% endif %}
            {% if name %}
            <div class="object-name">
                {{obj.name}} {% if obj.canon %}<sup>(c)</sup>{% endif %}
            </div>
            {% endif %}
        </a>
    </div>
{%- endmacro %}

{% macro object_display(obj, dim="250", name=True, date=False, type=True, pk=False, modal=False) -%}
{% if not modal %}
<a href="/{{obj.path}}" target='_blank' style='position: relative;'>
    {% endif %}
    <div class="image is-tile is-margin-center" style="width:100%;"
         {% if modal %}
         onclick=' document.querySelector("#modal-{{obj.pk}}").classList.add("is-active");'
         {% endif %}>
        {% if obj.image %}
        <img src="{{obj.image.url(size=dim)}}" loading="lazy" alt="{{obj.name}}" />
        {% endif %}
    </div>
    {% if name %}
    <h6 class='has-text-center' style='font-size: clamp(0.15rem, 0.75rem, 1.25rem);'>
        {{obj.name}} <sup>({% if obj.canon %}c{%else%}nc{% endif %})</sup>
    </h6>
    {% endif %}
    {% if date %}
    <small class='has-text-center'>
        {{obj.start_date}}-{{obj.end_date if obj.end_date else ''}}
    </small>
    {% endif %}
    <div class="row has-space-around">
        {% if type %}
        <div class="column">
            <p class='has-text-center' style='font-size: clamp(0.15rem, 0.75rem, 1rem);'>
                {{obj.title}}
            </p>
        </div>
        {% endif %}
        {% if pk %}
        <div class="column is-shrink">
            <h6 class='has-text-center' style='font-size: .5rem;'>
                pk: {{obj.pk}}
            </h6>
        </div>
        {% endif %}
    </div>
    {% if not modal %}
</a>
{% else %}
<div id="modal-{{obj.pk}}" class='modal' {% if modal %} {% endif %}>
    <div class="modal__background"
         onclick='document.querySelector("#modal-{{obj.pk}}").classList.remove("is-active");'></div>
    <div class="modal__content">
        <h3 class='has-text-center has-text-dark'
            onclick='document.querySelector("#modal-{{obj.pk}}").classList.remove("is-active");'>
            {{obj.name}}
        </h3>
        <div class='row has-bg-white initiative-card'>
            <div class="column is-2">
                {% if obj.image %}
                <div class='image'
                     onclick='document.querySelector("#modal-{{obj.pk}}").classList.remove("is-active");'>
                    <img src="{{obj.image.url()}}" alt="{{obj.name}}" />
                </div>
                {% endif %}
                {% if obj.model_name() in ['Creature', 'Character']%}
                <div class="panel has-bg-screen">
                    <div class="row has-space-around has-text-center has-text-dark"
                         style='cursor: pointer;'>
                        <div class="column is-4 is-mobile-3"
                             onclick='setbonus(this);'>
                            <h4 class="has-text-dark">STR</h4>
                            <p>{{obj.strength}} ({{(obj.strength|int-10)//2}})
                            </p>
                        </div>
                        <div class="column is-4 is-mobile-3"
                             onclick='setbonus(this);'>
                            <h4 class="has-text-dark">DEX</h4>
                            <p>{{obj.dexterity}}
                                ({{(obj.dexterity|int-10)//2}})</p>
                        </div>
                        <div class="column is-4 is-mobile-3"
                             onclick='setbonus(this);'>
                            <h4 class="has-text-dark">INT</h4>
                            <p>{{obj.intelligence}}
                                ({{(obj.intelligence|int-10)//2}})</p>
                        </div>
                        <div class="column is-4 is-mobile-3"
                             onclick='setbonus(this);'>
                            <h4 class="has-text-dark">WIS</h4>
                            <p>{{obj.wisdom}} ({{(obj.wisdom|int-10)//2}})</p>
                        </div>
                        <div class="column is-4 is-mobile-3"
                             onclick='setbonus(this);'>
                            <h4 class="has-text-dark">CHA</h4>
                            <p>{{obj.charisma}} ({{(obj.charisma|int-10)//2}})
                            </p>
                        </div>
                        <div class="column is-4 is-mobile-3"
                             onclick='setbonus(this);'>
                            <h4 class="has-text-dark">CON</h4>
                            <p>{{obj.constitution}}
                                ({{(obj.constitution|int-10)//2}})</p>
                        </div>
                    </div>
                </div>
                <div class="row has-space-around">
                    <div class="column is-shrink">
                        <h4 class='has-text-dark has-text-center'>HP</h4>
                        <div class="column is-shrink">
                            <h5 class='has-text-dark'>/{{obj.hitpoints}}</h5>
                        </div>
                    </div>
                    <div class="column is-shrink">
                        <h4 class='has-text-dark has-text-center'>AC</h4>
                        <h5 class='has-text-dark has-text-center'>{{obj.ac}}
                        </h5>
                    </div>

                </div>
                {% endif %}
            </div>
            <div class="column">
                <div class="row has-bg-white">
                    <div class="column">
                        {{obj.backstory_summary | safe}}
                    </div>
                    {% if obj.abilities or obj.features %}
                    <div id="card-abilities-details-panel"
                         class="column card-details-panel generated-text-lightbg">
                        {{abilities_components.abilities(user, obj)}}
                    </div>
                    {% endif %}
                    {% if obj.items %}
                    <div id="card-items-details-panel"
                         class="column is-2 card-details-panel">
                        <div class="panel has-bg-dark-grey">
                            <div class="row">
                                {% for item in obj.items %}
                                <div class="column is-4">
                                    {{object_display(item, type=False, name=False)}}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endmacro %}


{% macro card(user, obj) -%}
<div class="section has-bg-white">
    <div class="row">
        <div class="column is-6">
            <div class="row">
                <div class="column is-6">
                    <h2 class='has-text-center has-text-primary'
                        style='font-size: clamp(0.5rem, 1rem, 1.25rem);'>
                        {{obj.name}}
                    </h2>
                    <div class="image is-tile is-margin-center" style="width:100%;">
                        {% if obj.image %}
                        <img src="{{obj.image.url()}}" loading="lazy" alt="{{obj.name}}" />
                        {% endif %}
                    </div>
                    <div class="row">
                        <div class="column">
                            <h6 class='has-text-center  has-text-primary'
                                style='font-size: clamp(0.25rem, 0.75rem, 1rem);'>
                                {{obj.title}}
                            </h6>
                        </div>
                        {% if pk %}
                        <div class="column is-shrink">
                            <h6 class='has-text-center' style='font-size: .5rem;'>
                                pk: {{obj.pk}}
                            </h6>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="column is-6">
                    {% if obj.model_name() in ['Creature', 'Character']%}
                    <div class="row has-space-around">
                        <div class="column is-shrink">
                            <h4 class='has-text-dark has-text-center'>HP</h4>
                            <div class="column is-shrink">
                                <h5 class='has-text-dark'>/{{obj.hitpoints}}</h5>
                            </div>
                        </div>
                        <div class="column is-shrink">
                            <h4 class='has-text-dark has-text-center'>AC</h4>
                            <h5 class='has-text-dark has-text-center'>{{obj.ac}}
                            </h5>
                        </div>
                    </div>
                    <div class="panel has-bg-screen">
                        <div class="row has-space-around has-text-center has-text-dark"
                             style='cursor: pointer;'>
                            <div class="column is-4 is-mobile-3">
                                <h4 class="has-text-dark">STR</h4>
                                <p>{{obj.strength}} ({{(obj.strength|int-10)//2}})
                                </p>
                            </div>
                            <div class="column is-4 is-mobile-3">
                                <h4 class="has-text-dark">DEX</h4>
                                <p>{{obj.dexterity}}
                                    ({{(obj.dexterity|int-10)//2}})</p>
                            </div>
                            <div class="column is-4 is-mobile-3">
                                <h4 class="has-text-dark">INT</h4>
                                <p>{{obj.intelligence}}
                                    ({{(obj.intelligence|int-10)//2}})</p>
                            </div>
                            <div class="column is-4 is-mobile-3">
                                <h4 class="has-text-dark">WIS</h4>
                                <p>{{obj.wisdom}} ({{(obj.wisdom|int-10)//2}})</p>
                            </div>
                            <div class="column is-4 is-mobile-3">
                                <h4 class="has-text-dark">CHA</h4>
                                <p>{{obj.charisma}} ({{(obj.charisma|int-10)//2}})
                                </p>
                            </div>
                            <div class="column is-4 is-mobile-3">
                                <h4 class="has-text-dark">CON</h4>
                                <p>{{obj.constitution}}
                                    ({{(obj.constitution|int-10)//2}})</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% if obj.skills %}
                <div class="column is-full">
                    <div class="panel has-bg-light-grey">
                        <div class="row has-space-between">
                            {% for skill, val in obj.skills.items() %}
                            <div class="column is-shrink is-mobile-4">
                                <h5 class='has-text-center'>{{skill}}</h5>
                                <p class='has-text-center'>{{val}}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if obj.items %}
                <div class="column is-full">
                    <hr>
                    <div class="panel">
                        Inventory
                        <div class="row">
                            {% for item in obj.items %}
                            <div class="column is-2">
                                {{object_display(item, type=False)}}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="column is-full">
                <div class="panel has-bg-light-grey has-text-dark">
                    <h2 class='has-text-dark'>Backstory</h2>
                    {{obj.history | safe}}
                </div>
            </div>
        </div>
        <div class="column is-6">
            <h3 class='has-text-dark'>Features</h3>
            {% if obj.abilities or obj.features %}
            <div class="panel has-bg-muted"
                 style='border-top-right-radius: 0; border-top-left-radius:0;'>
                <div class="row">
                    {%for ability in obj.abilities or obj.features %}
                    <div class="column is-full">
                        <div class="row">
                            <h4 class='has-text-dark has-text-center'>
                                {{ability.name}}
                            </h4>
                            {% if ability.description %}
                            <div class="column is-full">
                                <div class="panel has-bg-muted has-text-primary">
                                    <h5 class='has-text-primary'
                                        style='text-decoration: underline; has-text-center'>
                                        Description</h5>
                                    {{ability.description | safe}}
                                </div>
                            </div>
                            {% endif %}
                            {% if ability.dice_roll %}
                            <div class="column">
                                <div class="panel has-bg-transparent">
                                    <h5 class='has-text-primary'
                                        style='text-decoration: underline;'>Roll
                                        Mechanics</h5>
                                    <span class='has-text-primary'>{{ability.dice_roll}}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if ability.effects %}
                            <div class="column">
                                <div class="panel has-bg-transparent">
                                    <h5 class='has-text-primary'
                                        style='text-decoration: underline;'>Effects
                                    </h5>
                                    <span class='has-text-primary'>{{ability.effects}}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if ability.duration %}
                            <div class="column">
                                <div class="panel has-bg-transparent">
                                    <h5 class='has-text-primary'
                                        style='text-decoration: underline;'>Duration</h5>
                                    <span class='has-text-primary'>{{ability.duration}}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}