{% import "shared/_abilities.html" as abilities_components %}

{% macro object_display(obj, dim="250", name=True, date=False, type=True, canon=False, pk=False) -%}
<a href="/{{obj.path}}" style='position: relative;'>
    {% if obj.image %}
    <img class="thumbnail" style="width:100%;" src="{{obj.image.url(size=dim)}}" loading="lazy"
         alt="{{obj.name}}" />
    {% elif obj.world.image %}
    <img class="thumbnail" style="width:100%;" src="{{obj.world.image.url(size=dim)}}"
         loading="lazy" alt="{{obj.name}}" />
    {% endif %}
    {% if name %}
    <h6 class='text-center' style='font-size: clamp(0.25rem, 0.75rem, 1.25rem);'>
        {{obj.name}}
        {% if obj.canon|default(false) %} <sup>(c)</sup> {% endif %}
    </h6>
    {% endif %}
    {% if date %}
    <p class='text-center' style='font-size: clamp(0.05rem, 0.75rem, 1rem);'>
        {{obj.start_date}}{%if obj.end_date and obj.end_date != obj.start_date %} -
        {{obj.end_date}}{%endif%}
    </p>
    {% endif %}
    <div class="grid-x align-spaced">
        {% if type %}
        <div class="cell auto">
            <p class='text-center' style='font-size: clamp(0.05rem, 0.75rem, 1rem);'>
                {{obj.title}}
            </p>
        </div>
        {% endif %}
        {% if pk %}
        <div class="cell shrink">
            <h6 class='text-center' style='font-size: .5rem;'>
                pk: {{obj.pk}}
            </h6>
        </div>
        {% endif %}
    </div>
</a>
{% endmacro %}

{% macro object_modal(obj, dim="250", name=True) -%}
<div class="image is-tile is-margin-center" style="width:100%;"
     onclick=' document.querySelector("#modal-{{obj.pk}}").classList.add("is-active");'>
    {% if obj.image %}
    <img src="{{obj.image.url(size=dim)}}" loading="lazy" alt="{{obj.name}}" />
    {% endif %}
</div>
{% if name %}
<h6 class='text-center' style='font-size: clamp(0.15rem, 0.75rem, 1.25rem);'>
    {{obj.name}} <sup>({% if obj.canon %}c{%else%}nc{% endif %})</sup>
</h6>
{% endif %}
<div id="modal-{{obj.pk}}" class='modal' {% if modal %} {% endif %}>
    <div class="modal__background"
         onclick='document.querySelector("#modal-{{obj.pk}}").classList.remove("is-active");'></div>
    <div class="modal__content">
        <h3 class='text-center has-text-dark'
            onclick='document.querySelector("#modal-{{obj.pk}}").classList.remove("is-active");'>
            {{obj.name}}
        </h3>
        <div class='row has-bg-white initiative-card'>
            <div class="cell is-2">
                {% if obj.image %}
                <div class='image'
                     onclick='document.querySelector("#modal-{{obj.pk}}").classList.remove("is-active");'>
                    <img src="{{obj.image.url()}}" alt="{{obj.name}}" />
                </div>
                {% endif %}
                {% if obj.model_name() in ['Creature', 'Character']%}
                <div class="panel has-bg-screen">
                    <div class="grid-x align-spaced text-center has-text-dark"
                         style='cursor: pointer;'>
                        <div class="cell medium-4 is-mobile-3"
                             onclick='setbonus(this);'>
                            <h4 class="has-text-dark">STR</h4>
                            <p>{{obj.strength}} ({{(obj.strength|int-10)//2}})
                            </p>
                        </div>
                        <div class="cell medium-4 is-mobile-3"
                             onclick='setbonus(this);'>
                            <h4 class="has-text-dark">DEX</h4>
                            <p>{{obj.dexterity}}
                                ({{(obj.dexterity|int-10)//2}})</p>
                        </div>
                        <div class="cell medium-4 is-mobile-3"
                             onclick='setbonus(this);'>
                            <h4 class="has-text-dark">INT</h4>
                            <p>{{obj.intelligence}}
                                ({{(obj.intelligence|int-10)//2}})</p>
                        </div>
                        <div class="cell medium-4 is-mobile-3"
                             onclick='setbonus(this);'>
                            <h4 class="has-text-dark">WIS</h4>
                            <p>{{obj.wisdom}} ({{(obj.wisdom|int-10)//2}})</p>
                        </div>
                        <div class="cell medium-4 is-mobile-3"
                             onclick='setbonus(this);'>
                            <h4 class="has-text-dark">CHA</h4>
                            <p>{{obj.charisma}} ({{(obj.charisma|int-10)//2}})
                            </p>
                        </div>
                        <div class="cell medium-4 is-mobile-3"
                             onclick='setbonus(this);'>
                            <h4 class="has-text-dark">CON</h4>
                            <p>{{obj.constitution}}
                                ({{(obj.constitution|int-10)//2}})</p>
                        </div>
                    </div>
                </div>
                <div class="grid-x align-spaced">
                    <div class="cell shrink">
                        <h4 class='has-text-dark text-center'>HP</h4>
                        <div class="cell shrink">
                            <h5 class='has-text-dark'>/{{obj.hitpoints}}</h5>
                        </div>
                    </div>
                    <div class="cell shrink">
                        <h4 class='has-text-dark text-center'>AC</h4>
                        <h5 class='has-text-dark text-center'>{{obj.ac}}
                        </h5>
                    </div>

                </div>
                {% endif %}
            </div>
            <div class="cell">
                <div class="grid-x has-bg-white">
                    <div class="cell">
                        {{obj.backstory_summary | safe}}
                    </div>
                    {% if obj.abilities or obj.features %}
                    <div id="card-abilities-details-panel"
                         class="cell card-details-panel generated-text-lightbg">
                        {{abilities_components.abilities(user, obj)}}
                    </div>
                    {% endif %}
                    {% if obj.items %}
                    <div id="card-items-details-panel"
                         class="cell is-2 card-details-panel">
                        <div class="panel has-bg-dark-grey">
                            <div class="grid-x">
                                {% for item in obj.items %}
                                <div class="cell medium-4">
                                    {{object_display(item, type=False, name=False)}}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}


{% macro card(user, obj) -%}
<div class="section has-bg-white">
    <div class="grid-x">
        <div class="cell medium-6">
            <div class="grid-x">
                <div class="cell medium-6">
                    <h2 class='text-center has-text-primary'
                        style='font-size: clamp(0.5rem, 1rem, 1.25rem);'>
                        {{obj.name}}
                    </h2>
                    <div class="image is-tile is-margin-center" style="width:100%;">
                        {% if obj.image %}
                        <img src="{{obj.image.url()}}" loading="lazy" alt="{{obj.name}}" />
                        {% endif %}
                    </div>
                    <div class="grid-x">
                        <div class="cell">
                            <h6 class='text-center  has-text-primary'
                                style='font-size: clamp(0.25rem, 0.75rem, 1rem);'>
                                {{obj.title}}
                            </h6>
                        </div>
                        {% if pk %}
                        <div class="cell shrink">
                            <h6 class='text-center' style='font-size: .5rem;'>
                                pk: {{obj.pk}}
                            </h6>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="cell medium-6">
                    {% if obj.model_name() in ['Creature', 'Character']%}
                    <div class="grid-x align-spaced">
                        <div class="cell shrink">
                            <h4 class='has-text-dark text-center'>HP</h4>
                            <div class="cell shrink">
                                <h5 class='has-text-dark'>/{{obj.hitpoints}}</h5>
                            </div>
                        </div>
                        <div class="cell shrink">
                            <h4 class='has-text-dark text-center'>AC</h4>
                            <h5 class='has-text-dark text-center'>{{obj.ac}}
                            </h5>
                        </div>
                    </div>
                    <div class="panel has-bg-screen">
                        <div class="grid-x align-spaced text-center has-text-dark"
                             style='cursor: pointer;'>
                            <div class="cell medium-4 is-mobile-3">
                                <h4 class="has-text-dark">STR</h4>
                                <p>{{obj.strength}} ({{(obj.strength|int-10)//2}})
                                </p>
                            </div>
                            <div class="cell medium-4 is-mobile-3">
                                <h4 class="has-text-dark">DEX</h4>
                                <p>{{obj.dexterity}}
                                    ({{(obj.dexterity|int-10)//2}})</p>
                            </div>
                            <div class="cell medium-4 is-mobile-3">
                                <h4 class="has-text-dark">INT</h4>
                                <p>{{obj.intelligence}}
                                    ({{(obj.intelligence|int-10)//2}})</p>
                            </div>
                            <div class="cell medium-4 is-mobile-3">
                                <h4 class="has-text-dark">WIS</h4>
                                <p>{{obj.wisdom}} ({{(obj.wisdom|int-10)//2}})</p>
                            </div>
                            <div class="cell medium-4 is-mobile-3">
                                <h4 class="has-text-dark">CHA</h4>
                                <p>{{obj.charisma}} ({{(obj.charisma|int-10)//2}})
                                </p>
                            </div>
                            <div class="cell medium-4 is-mobile-3">
                                <h4 class="has-text-dark">CON</h4>
                                <p>{{obj.constitution}}
                                    ({{(obj.constitution|int-10)//2}})</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% if obj.skills %}
                <div class="cell is-full">
                    <div class="panel has-bg-light-grey">
                        <div class="grid-x align-justify">
                            {% for skill, val in obj.skills.items() %}
                            <div class="cell shrink is-mobile-4">
                                <h5 class='text-center'>{{skill}}</h5>
                                <p class='text-center'>{{val}}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if obj.items %}
                <div class="cell is-full">
                    <hr>
                    <div class="panel">
                        Inventory
                        <div class="grid-x">
                            {% for item in obj.items %}
                            <div class="cell is-2">
                                {{object_display(item, type=False)}}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="cell is-full">
                <div class="panel has-bg-light-grey has-text-dark">
                    <h2 class='has-text-dark'>Backstory</h2>
                    {{obj.history | safe}}
                </div>
            </div>
        </div>
        <div class="cell medium-6">
            <h3 class='has-text-dark'>Features</h3>
            {% if obj.abilities or obj.features %}
            <div class="panel "
                 style='border-top-right-radius: 0; border-top-left-radius:0;'>
                <div class="grid-x">
                    {%for ability in obj.abilities or obj.features %}
                    <div class="cell is-full">
                        <div class="grid-x">
                            <h4 class='has-text-dark text-center'>
                                {{ability.name}}
                            </h4>
                            {% if ability.description %}
                            <div class="cell is-full">
                                <div class="panel  has-text-primary">
                                    <h5 class='has-text-primary'
                                        style='text-decoration: underline; text-center'>
                                        Description</h5>
                                    {{ability.description | safe}}
                                </div>
                            </div>
                            {% endif %}
                            {% if ability.dice_roll %}
                            <div class="cell">
                                <div class="panel has-bg-transparent">
                                    <h5 class='has-text-primary'
                                        style='text-decoration: underline;'>Roll
                                        Mechanics</h5>
                                    <span class='has-text-primary'>{{ability.dice_roll}}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if ability.effects %}
                            <div class="cell">
                                <div class="panel has-bg-transparent">
                                    <h5 class='has-text-primary'
                                        style='text-decoration: underline;'>Effects
                                    </h5>
                                    <span class='has-text-primary'>{{ability.effects}}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if ability.duration %}
                            <div class="cell">
                                <div class="panel has-bg-transparent">
                                    <h5 class='has-text-primary'
                                        style='text-decoration: underline;'>Duration</h5>
                                    <span class='has-text-primary'>{{ability.duration}}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}