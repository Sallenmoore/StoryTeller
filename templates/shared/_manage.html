{% import "shared/_icons.html" as icon_components %}
{% import "shared/_form.html" as form_components %}

{%- macro manage_date(obj, endpoint) -%}
manage_date
{%- endmacro %}

{%- macro manage(user, obj) -%}
<div class="row">
    <div class="column is-center">
        <h2 class='has-text-dark'>Details Editor</h2>
    </div>
    <div class="column is-shrink is-float-right">
        <a class='has-text-dark' href="/{{obj.path}}/details">
            {{icon_components.close(size="3rem")}}
        </a>
    </div>
</div>
<div class="row has-space-around">
    <div class="column is-shrink is-vertically-centered">
        <button class="button has-bg-dark-grey has-text-white"
                hx-post="/task/generate/{{obj.path}}"
                hx-target="closest .column"
                hx-confirm='Details can be generated from scratch, but works best if you add any required details to the {{obj.title}} first, such as name, brief history, or other  details'>
            {{icon_components.ai(size="1rem")}}
            Generate Details
        </button>
    </div>
    <div class="column is-shrink is-vertically-centered">
        <button class="button is-primary" hx-post="/task/generate/history/{{obj.path}}"
                hx-target="closest .column">
            {{icon_components.update(size="1rem")}}
            Update History
        </button>
    </div>
    <div class="column is-shrink is-vertically-centered">
        <button class="button has-bg-dark has-text-primary"
                hx-post="/api/manage/delete/{{obj.path}}"
                hx-target="#page-content"
                hx-confirm='Are you sure? This cannot be undone'>
            {{icon_components.delete(size="1rem")}}
            Delete
        </button>
    </div>
</div>
<hr>
<form hx-post="/api/manage/update" hx-swap="none" hx-trigger="input delay:1s, change">
    <div class="row">
        <div class="column">
            <h5 class='has-text-center has-text-dark'>Name</h5>
            <input id='model-name' class="has-bg-light has-text-center" type="text" name="name"
                   value="{{obj.name}}"
                   onload='document.title = this.value;document.getElementById("object-title").innerHTML = this.value;'
                   oninput='document.title = this.value;document.getElementById("object-title").innerHTML = this.value;'>
        </div>
        <div class="column">
            <h5 class='has-text-center has-text-dark'>Theme</h5>
            <input class="has-bg-light has-text-center" type="text" name="traits"
                   value="{{obj.traits}}" maxlength="64">
        </div>
    </div>
    <div class="row">
        <div id="model-goal" class="column">
            <h4 class='has-text-light has-text-center'>Status</h4>
            {{form_components.texteditor(user, obj, "status")}}
        </div>
    </div>
</form>
{%- endmacro %}

{%macro backstory(user, obj) -%}
<form hx-post="/api/manage/update"
      hx-swap="none" hx-trigger="input delay:1s, change">
    <h4 class='has-text-center has-text-dark'>Backstory</h4>
    {{form_components.texteditor(user, obj, 'backstory')}}
</form>
<hr>
{% endmacro %}

{%macro dates(user, obj) -%}
<form hx-post="/api/manage/update"
      hx-swap="none" hx-trigger="input delay:1s, change">
    <div id="manage-obj-dates" class="row has-centered" style='position:relative;'>
        <div class="column is-shrink is-vertically-centered">
            <h5 class='has-text-center has-text-dark'>Start</h5>
        </div>
        <div class="column is-1 has-no-padding has-no-margin is-vertically-centered">
            <input class="has-text-center" type="number"
                   name="start_date.day"
                   placeholder='day'
                   value="{{obj.start_date.day}}">
        </div>
        <div class="column is-shrink  has-no-padding has-no-margin is-vertically-centered">
            <div class="is-select" style='position:relative;top: -2px;'>
                <select name="start_date.month">
                    {% for m in obj.world.calendar.months %}
                    <option class="has-text-center" value='{{m}}' {% if
                            loop.index0==obj.start_date.month %}
                            selected {% endif %}>
                        {{m}}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="column is-2 has-no-padding has-no-margin is-vertically-centered">
            <input class="has-text-center" type="number"
                   name="start_date.year"
                   placeholder='year'
                   value="{{obj.start_date.year}}">
        </div>
        <div class="column is-shrink  is-vertically-centered">
            {{icon_components.dash()}}
        </div>
        <div class="column is-1 has-no-padding has-no-margin is-vertically-centered">
            <input class="has-text-center" type="number"
                   name="end_date.day"
                   placeholder='day'
                   value="{{obj.end_date.day}}">
        </div>
        <div class="column is-shrink  has-no-padding has-no-margin is-vertically-centered">
            <div class="is-select" style='position:relative;top: -2px;'>
                <select name="end_date.month">
                    {% for m in obj.world.calendar.months %}
                    <option class="has-text-center" value='{{m}}' {% if
                            loop.index0==obj.end_date.month %}
                            selected {% endif %}>
                        {{m}}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="column is-2 has-no-padding has-no-margin is-vertically-centered">
            <input class="has-text-center" type="number"
                   name="end_date.year"
                   placeholder='year'
                   value="{{obj.end_date.year}}">
        </div>
        <div class="column is-shrink  is-vertically-centered">
            <h5 class='has-text-center has-text-dark'>End</h5>
        </div>
    </div>
</form>
{%- endmacro %}

{% macro image(user, obj) -%}
<h3 class='has-text-center has-text-dark' id='manage-image'>Image Editor</h3>
<div class="panel has-bg-light-grey is-small">
    <div class="row" id="image-manage-container">
        <div class="column is-8" id="model-owner-image">
            {% if obj.image %}
            <div class="image is-margin-center">
                <img src="{{obj.image.url()}}" alt="{{obj.name}}" />
            </div>
            {% else %}
            <h5 class='has-text-dark'>No Image</h5>
            {% endif %}
        </div>
        <div class="column is-4">
            <div class="row">
                <div class="column">
                    <h5 class='has-text-center has-text-dark'>Image Description (editable)
                    </h5>
                    <div class="panel has-bg-light">
                        <p id="model-desc" class="has-text-dark" contentEditable="true"
                           hx-post="/api/manage/update" hx-trigger="input delay:1s"
                           hx-vals="js:{description:strip_html(htmx.find('#model-desc').innerHTML)}"
                           hx-swap="none">
                            {{obj.desc | striptags}}
                        </p>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="column is-vertically-centered">
                    <button class="button is-full is-small"
                            hx-post="/task/generate/image/{{obj.path}}" hx-target="closest .column"
                            hx-indicator="#request-indicator"
                            hx-confirm="Are you sure you want to generate and overwrite the current image?">
                        {{icon_components.ai(size="1rem")}}
                        AI Generated Image
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="column">
                    <button class="button is-full is-small" hx-post="/api/manage/image/gallery"
                            hx-target="#model-owner-image" hx-swap="innerHTML">
                        {{icon_components.random(size="1rem")}}
                        Select From Gallery
                    </button>
                </div>
            </div>
            <form hx-post="/api/manage/update" hx-select='#image-manage-container'
                  hx-target="#image-manage-container" hx-swap="outerHTML"
                  hx-confirm="Are you sure you want to upload and overwrite the current map?">
                <div class="row">
                    <div class="column is-shrink">
                        <button class="button is-primary is-small" type="submit">
                            {{icon_components.link(size="1rem")}}
                            Upload from URL
                        </button>
                    </div>
                    <div class="column">
                        <div class="inputlabel">
                            <input class="has-bg-muted has-text-secondary" type="url" name="image"
                                   placeholder="enter url...">
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{%- endmacro%}

{%macro imagegallery(user, obj, images) -%}
<div class="panel has-bg-primary">
    <div class="row has-space-around">
        {% for image in images%}
        <div class="column is-shrink has-text-center has-centered">
            <div class="image is-medium is-thumbnail is-margin-center" style="cursor: pointer">
                <img src="{{image.url(size=100)}}" alt="{{image.tags | join(', ')}}"
                     hx-post="/api/manage/update"
                     hx-target="#image-manage-container" hx-select="#image-manage-container"
                     hx-swap="outerHTML"
                     hx-vals='{"image":"{{image.pk}}"}'
                     hx-indicator="#request-indicator" />
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{%- endmacro %}