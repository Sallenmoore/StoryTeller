{% import "shared/_icons.html" as icon_components %}
{% import "shared/_form.html" as form_components %}
{% import "shared/_display.html" as display %}

{%- macro manage(user, obj) -%}
<div class="row">
    <div class="column is-center">
        <h2 class='has-text-dark'>Details Editor</h2>
    </div>
    <div class="column is-shrink is-float-right">
        <a class='has-text-dark' href="/{{obj.path}}/details">
            {{icon_components.close(size="3rem")}}
        </a>
    </div>
</div>

<div id="{{obj.model_name()}}-manage" class="grid-x grid-padding-x">
    <div class="story cell small-12 medium-7">
        {{ ai_buttons(obj) }}
        
        <form hx-post="/api/manage/update" hx-swap="none" hx-trigger="input delay:1s, change">
            <label>Name
                <input id="model-name" type="text" name="name"
                    value="{{obj.name}}"
                    onload='document.title = this.value;document.getElementById("object-title").innerHTML = this.value;'
                    oninput='document.title = this.value;document.getElementById("object-title").innerHTML = this.value;'>
            </label>
        
            <label>Theme/Traits
                <textarea name="traits" style="height: 6rem;">{{obj.traits}}</textarea>
            </label>

        </form>

        {{backstory(user, obj)}}

        <h2>History</h2>
        {{obj.history | safe}}
    </div>
    <div class="related-panel cell small-12 medium-4 large-offset-1">
        {{ display.dsp_object_image(obj,'400') }}

        <table></table>
        
        <h2>Associations</h2>
        {{ display.dsp_all_associations(user, obj) }}
    </div>
</div>


    <!--
    <div class="column is-shrink is-vertically-centered">
        <button class="button has-bg-dark has-text-primary"
                hx-post="/api/manage/delete/{{obj.path}}"
                hx-target="#page-content"
                hx-confirm='Are you sure? This cannot be undone'>
            {{icon_components.delete(size="1rem")}}
            Delete
        </button>
    </div>-->


{%- endmacro %}

{%macro backstory(user, obj) -%}
        <h3>Backstory</h3>

        <form method="post" action="/api/manage/update">
        {{form_components.richtexteditor(user, obj, 'backstory')}}
    </form>

{% endmacro %}

<!-- consistent code to update a start or end date -->
{% macro manage_date (obj, pos) -%}
    {% set field = pos + '_date' %}
    <label>{{display.dsp_object_lifetime(obj,pos)}}
        <div class="grid-x">
            <div class="small-2">
                <input type="number" name="{{field}}.day" placeholder='day'
                value="{{obj[field].day}}">
            </div>
            <div class="small-7">
                <select name="{{field}}.month">
                    {% for m in obj.world.calendar.months %}
                    <option value='{{m}}' {% if loop.index0==obj[field].month %}
                            selected {% endif %}>{{m}}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="small-3">
                <input type="number" name="{{field}}.year" placeholder='year' class="year"
            value="{{obj[field].year}}">
            </div>
        </div>
    </label>
{% endmacro %}

{%macro dates(obj) -%}
    <form hx-post="/api/manage/update"
        hx-swap="none" hx-trigger="input delay:1s, change">
        <div class="grid-x">
            <div class="small-6">
            <label>{{display.dsp_object_lifetime(obj,"start")}}
                <div class="grid-x">
                    <div class="small-2">
                        <input type="number" name="start_date.day" placeholder='day'
                        value="{{obj.start_date.day}}">
                    </div>
                    <div class="small-7">
                        <select name="start_date.month">
                            {% for m in obj.world.calendar.months %}
                            <option value='{{m}}' {% if loop.index0==obj.start_date.month %}
                                    selected {% endif %}>{{m}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="small-3">
                        <input type="number" name="start_date.year" placeholder='year' class="year"
                    value="{{obj.start_date.year}}">
                    </div>
                </div>
            </label>
            </div>
            <div class="small-6">
            <label>{{display.dsp_object_lifetime(obj,"end")}}
                <div class="grid-x">
                    <div class="small-2">
                        <input type="number" name="end_date.day" placeholder='day'
                        value="{{obj.end_date.day}}">
                    </div>
                    <div class="small-7">
                        <select name="end_date.month">
                            {% for m in obj.world.calendar.months %}
                            <option value='{{m}}' {% if loop.index0==obj.end_date.month %}
                                    selected {% endif %}>{{m}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="small-3">
                        <input type="number" name="end_date.year" placeholder='year' class="year"
                       value="{{obj.end_date.year}}">
                    </div>
                </div>
            </label>
        </div>
    </div>
</form>
{%- endmacro %}

{% macro image(user, obj) -%}
<h3 class='has-text-center has-text-dark' id='manage-image'>Image Editor</h3>
<div class="panel has-bg-light-grey is-small">
    <div class="row" id="image-manage-container">
        <div class="column is-8" id="model-owner-image">
            {% if obj.image %}
            <div class="image is-margin-center">
                <img src="{{obj.image.url()}}" alt="{{obj.name}}" />
            </div>
            {% else %}
            <div class="is-vertically-centered has-text-center" hx-post="/api/manage/{{obj.path}}"
                 hx-trigger='load delay:5s' hx-target="#model-owner-image"
                 hx-select="#model-owner-image" hx-swap="outerHTML">
                <h5 class='has-text-dark'>No Image</h5>
            </div>
            {% endif %}
        </div>
        <div class="column is-4">
            <div class="row">
                <div class="column">
                    <h5 class='has-text-center has-text-dark'>Image Description (editable)
                    </h5>
                    <div class="panel has-bg-light">
                        <p id="model-desc" class="has-text-dark" contentEditable="true"
                           hx-post="/api/manage/update" hx-trigger="input delay:1s"
                           hx-vals="js:{description:strip_html(htmx.find('#model-desc').innerHTML)}"
                           hx-swap="none">
                            {{obj.desc | striptags}}
                        </p>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="column is-vertically-centered">
                    <button class="button is-full is-small"
                            hx-post="/task/generate/image/{{obj.path}}" hx-target="closest .column"
                            hx-indicator="#request-indicator"
                            hx-confirm="Are you sure you want to generate and overwrite the current image?">
                        {{icon_components.ai(size="1rem")}}
                        AI Generated Image
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="column">
                    <button class="button is-full is-small" hx-post="/api/manage/image/gallery"
                            hx-target="#model-owner-image" hx-swap="innerHTML">
                        {{icon_components.random(size="1rem")}}
                        Select From Gallery
                    </button>
                </div>
            </div>
            <form hx-post="/api/manage/update" hx-select='#image-manage-container'
                  hx-target="#image-manage-container" hx-swap="outerHTML"
                  hx-confirm="Are you sure you want to upload and overwrite the current map?">
                <div class="row">
                    <div class="column is-shrink">
                        <button class="button is-primary is-small" type="submit">
                            {{icon_components.link(size="1rem")}}
                            Upload from URL
                        </button>
                    </div>
                    <div class="column">
                        <div class="inputlabel">
                            <input class="has-bg-muted has-text-secondary" type="url" name="image"
                                   placeholder="enter url...">
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{%- endmacro%}

{%macro imagegallery(user, obj, images) -%}
<div class="panel has-bg-primary">
    <div class="row has-space-around">
        {% for image in images%}
        <div class="column is-shrink has-text-center has-centered">
            <div class="image is-medium is-thumbnail is-margin-center" style="cursor: pointer">
                <img src="{{image.url(size=100)}}" alt="{{image.tags | join(', ')}}"
                     hx-post="/api/manage/update"
                     hx-target="#image-manage-container" hx-select="#image-manage-container"
                     hx-swap="outerHTML"
                     hx-vals='{"image":"{{image.pk}}"}'
                     hx-indicator="#request-indicator" />
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{%- endmacro %}

{%macro ai_buttons(obj) -%}
<!-- display AI Generative buttons -->
<div id="ai-buttons" class="grid-x grid-padding-x">
    <div class="cell small-12 large-6">
        <button class="button"
                hx-post="/task/generate/{{obj.path}}"
                hx-confirm='Details can be generated from scratch, but works best if you add any required details to the {{obj.title}} first, such as name, brief history, or other  details'>
            {{icon_components.ai(size="1rem")}}
            Create Details (AI Generated)
        </button>
    </div>
    <div class="cell small-12 large-6">
        <button class="button"
                hx-post="/task/generate/history/{{obj.path}}">
            {{icon_components.update(size="1rem")}}
            Update History (AI Generated)
        </button>
    </div>
</div>
{%- endmacro %}