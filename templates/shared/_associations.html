{% import "shared/_display.html" as display_components %}
{% import "shared/_icons.html" as icon_components %}

{% macro associations(user, obj, associations) -%}
<title>{{obj.name}} - Associations</title>

<h2>Associations</h2>
{% if obj.model_name() != "World" and user.world_user(obj) %}
<div id="association-manager-container">
    <div class="grid-x grid-padding-x">
        <div class="cell small-12"><h3>Add Association</h3></div>
        <div class="cell small-12 medium-6">
            <div class="has-dropdown" style="width: 100%;">
                <input class="has-bg-light" autocomplete=off type="search" name="query"
                    placeholder="Search to Add Associations..."
                    style="border-bottom: solid #000;" hx-target="#association-search"
                    hx-post="/api/manage/association/add/search"
                    hx-trigger="input delay:750ms, search"
                    hx-vals='{"module":"shared/_associations.html", "macro":"association_dropdown"}'
                    hx-on:input="this.value.length < 1 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
                <ul class="dropdown autocomplete-list has-bg-light" id="association-search">
                </ul>
            </div>
        </div>
    
        <div class="cell small-12 medium-6">
            <button class="button is-primary is-small"
                    hx-post="/api/manage/associations/random"
                    hx-target="#page-content"
                    hx-indicator='#request-indicator'>
                Random Associations
            </button>
            <br>

            {% for child in obj.world.all_models() %}
                <button class="button is-primary is-small"
                        hx-post="/api/manage/add/{{child.__name__ | lower}}"
                        hx-target="#associations-container"
                        hx-select="#associations-container"
                        hx-swap='outerHTML'
                        hx-indicator='#request-indicator'>
                    New {{obj.world.get_title(child)}}
                </button>
            {% endfor %}
        </div>
    </div>
</div>
<hr>
{% endif %}


<div class="grid-x grid-padding-x">
    <div class="cell small-12"><h3>Existing Associations</h3></div>
    <div class="cell small-12 medium-6">
        <div class="row has-space-around">
            <div class="column is-4">
                <div class="panel has-bg-muted is-small" style='border-radius: 5px 5px 0 0 ;'>
                    <input type="search" name="filter" placeholder="Begin typing to filter..."
                        style="border-bottom: solid #000;"
                        hx-post="/api/{{obj.path}}/associations"
                        hx-trigger="input changed delay:250ms, search"
                        hx-target='#associations-container'
                        hx-select='#associations-container'
                        hx-swap='outerHTML'>
                </div>
            </div>
        </div>
    </div>
    <div class="cell small-12 medium-6">
    <div class="column is-4">
        <div class="panel is-small" style='border-radius: 0 0 5px 5px;'>
            <form hx-post="/api/{{obj.path}}/associations"
                  hx-target='#associations-container'
                  hx-select='#associations-container'
                  hx-swap='outerHTML'>
                <div class="row">
                    <div class="column is-shrink is-vertically-centered">
                        <h5 class="has-text-muted">Sort by</h5>
                    </div>
                    <div class="column">
                        <div class="is-select">
                            <select class="has-text-white" name="sorter">
                                <option value='name'>Name</option>
                                <option value='date'>Date</option>
                                <option value='type'>Type</option>
                                <option value='parent'>No Parent</option>
                            </select>
                        </div>
                    </div>
                    <div class="column is-shrink is-mobile-shrink">
                        <button type="submit" class="button is-small" name="order" value="asc">
                            {{icon_components.sortascending(size="1rem")}}
                            Ascending
                        </button>
                    </div>
                    <div class="column is-shrink is-mobile-shrink">
                        <button type="submit" class="button is-small" name="order" value="desc">
                            {{icon_components.sortdescending(size="1rem")}}
                            Descending
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
</div>
<hr>
<div id="associations-container" class="grid-container">
    <div id="related-objects" class="grid-x grid-padding-x">
        {% if obj.model_name() != "World"%}
        {% if obj.parent|default(false) %}
        {% for ancestor in obj.geneology | reverse %}
        <div class="column is-3 is-mobile-6 is-desktop-2 card-container has-bg-black">
            <div class="panel has-bg-black" style='height:100%;'>
                {{display_components.object_display(ancestor)}}
                <div class="row has-space-around">
                    <div class="column is-3 is-mobile-shrink has-text-center">
                        <button class="button is-small is-primary"
                                hx-post="/api/manage/unassociate/{{ancestor.path}}"
                                hx-target="#associations-container"
                                hx-select="#associations-container"
                                hx-indicator='#request-indicator'>
                            {{icon_components.unlink(size="1rem")}}
                            <span style="font-size:0.5rem">Unlink</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
        {% for a in obj.children %}
        <div
             class="cell small-6 medium-2
                {% if a == obj.parent|default(false) %} has-bg-black {% elif obj == a.parent|default(false) %} has-bg-white {% endif %}">
            <div class="card {% if a == obj.parent|default(false) %} has-bg-black {% elif obj == a.parent|default(false) %} has-bg-white {% else %} has-bg-screen {% endif %}"
                 style='height:100%;'>
                {{display_components.object_display(a)}}
                {% if 'World' not in [obj.model_name(), a.model_name()] %}
                <div class="row has-space-around">
                    <div class="column is-3 is-mobile-shrink has-text-center">
                        <button class="button is-small is-primary"
                                hx-post="/api/manage/unassociate/{{a.path}}"
                                hx-target="#associations-container"
                                hx-select="#associations-container"
                                hx-vals='{"module":"_pages.html", "macro":"associations"}'
                                hx-indicator='#request-indicator'>
                            {{icon_components.unlink(size="1rem")}}
                            <span style="font-size:0.5rem">Unlink</span>
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% endif%}
        {% for a in associations %}
        {% if a.parent|default(false) != obj and obj.parent|default(false) != a %}
        <div
             class="cell small-6 medium-2
                {% if a == obj.parent|default(false) %} has-bg-black {% elif obj == a.parent|default(false) %} has-bg-white {% endif %}">
            <div class="card {% if a == obj.parent|default(false) %} has-bg-black {% elif obj == a.parent|default(false) %} has-bg-white {% else %} has-bg-screen {% endif %}"
                 style='height:100%;'>
                {{display_components.object_display(a)}}
                {% if 'World' not in [obj.model_name(), a.model_name()] %}
                <div class="row has-space-around">
                    {% if obj.model_name() in a.parent_list|default([]) and obj !=
                    a.parent|default(false) %}
                    <div class="column is-3 is-mobile-shrink has-text-center">
                        <button class="button is-small is-primary"
                                hx-post="/api/manage/parent/{{a.path}}"
                                hx-target="#associations-container"
                                hx-select="#associations-container"
                                hx-vals='{"module":"_pages.html", "macro":"associations"}'
                                hx-indicator='#request-indicator'>
                            {{icon_components.down(size="1rem")}}
                            <span style="font-size:0.5rem">is child</span>
                        </button>
                    </div>
                    {% endif %}
                    {% if a.model_name() in obj.parent_list|default([]) and a !=
                    obj.parent|default(false) %}
                    <div class="column is-3 is-mobile-shrink has-text-center">
                        <button class="button is-small is-primary"
                                hx-post="/api/manage/child/{{a.path}}"
                                hx-target="#associations-container"
                                hx-select="#associations-container"
                                hx-vals='{"module":"_pages.html", "macro":"associations"}'
                                hx-indicator='#request-indicator'>
                            {{icon_components.heirarchy(size="1rem")}}
                            <span style="font-size:0.5rem">is parent</span>
                        </button>
                    </div>
                    {% endif %}
                    <div class="column is-3 is-mobile-shrink has-text-center">
                        <button class="button is-small is-primary"
                                hx-post="/api/manage/unassociate/{{a.path}}"
                                hx-target="#associations-container"
                                hx-select="#associations-container"
                                hx-vals='{"module":"_pages.html", "macro":"associations"}'
                                hx-indicator='#request-indicator'>
                            {{icon_components.unlink(size="1rem")}}
                            <span style="font-size:0.5rem">Unlink</span>
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
{%- endmacro %}

{% macro association_dropdown(user, obj, objs=[]) -%}
{% for o in objs %}
<li class="dropdown__link">
    <a hx-post='/api/manage/association/add/{{o.path}}'
       hx-target='#associations-container'
       hx-select='#associations-container'
       hx-swap='outerHTML'
       hx-indicator='#request-indicator'
       hx-push-url='/{{obj.path}}/associations'>
        <div class="row">
            <div class="column is-shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="column">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}