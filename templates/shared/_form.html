{% macro textarea(user, obj, name="", content="") -%}
<textarea id="{{name}}" name='{{name}}' class="auto-resize-text has-bg-white" rows="3"
          placeholder="Start typing...">{{ content }}</textarea>
<script>
    var textareas = document.querySelectorAll('.auto-resize-text');

    textareas.forEach(textarea => {
        // Adjust height on input
        function autoResize() {
            // Reset height to 'auto' first to correctly calculate scrollHeight
            // This allows the textarea to shrink if text is deleted
            textarea.style.height = 'auto';
            // Set the height to the scrollHeight, which is the minimum height
            // required to show all content without a scrollbar.
            textarea.style.height = textarea.scrollHeight + 'px';
        }
        textarea.addEventListener('input', autoResize);
        // Adjust height on initial load (in case there's pre-filled content)
        autoResize();
    });
</script>
{%- endmacro %}

{% macro texteditor(user, obj, attr, content=None, limit=0, name="") -%}
<div onmouseout="tinyMCE.triggerSave();" data-max='{{limit}}'>
    <textarea class="has-text-dark has-bg-white" id="edit-{{obj.pk}}-{{attr}}"
              name="{{name or attr}}">
        {% if not (content is none) %}
            {{content | string |  safe}}
        {% elif obj %}
            {{obj[attr] | string | safe}}
        {% endif %}
    </textarea>
    <!-- Mention Popup -->
    <div id="mention-popup" class="mention-popup is-hidden">
        <ul id="mention-list">
            <!-- Names will be dynamically inserted here -->
        </ul>
    </div>
    <script>
        tinyMCE.remove('#edit-{{obj.pk}}-{{attr}}');
        tinyMCE.init({
            selector: '#edit-{{obj.pk}}-{{attr}}',
            toolbar: 'undo redo searchreplace | styles | bold italic blockquote link | alignleft aligncenter alignright alignjustify | outdent indent numlist bullist | removeformat | fullscreen',
            toolbar_sticky: true,
            plugins: 'wordcount autoresize fullscreen lists link searchreplace',
            resize: 'true',
            min_height: 20,
            content_style: "body {font-family:Open-Sans,sans-serif;font-size:1.15rem;line-height: 1.25;}",
            menubar: false,
            promotion: false,
            license_key: 'gpl',
            setup: function (editor) {
                var max = parseInt(htmx.find("#edit-{{obj.pk}}-{{attr}}").parentElement.dataset.max);
                editor.on('change', function (e) {
                    var numChars = editor.plugins.wordcount.body.getCharacterCount();
                    if (max && numChars > max) {
                        alert("Maximum " + numChars + "/" + max + " characters allowed.");
                        return false;
                    } else {
                        tinymce.triggerSave();
                        htmx.trigger("#edit-{{obj.pk}}-{{attr}}", 'input');
                        htmx.trigger("#edit-{{obj.pk}}-{{attr}}", 'change');
                    }
                });
                /*editor.on('input', function (e) {
                    // Adjust the height of the textarea based on content
                    var content = editor.getContent();
                    var mentionPopup = document.getElementById('mention-popup');
                    var mentionList = document.getElementById('mention-list');

                    var fetchNames = async (searchTerm) => {
                        // Simulate network delay
                        fetch('/api/manage/details/mention/names?search=' + searchTerm)
                            .then(response => response.json())
                            .then(data => {
                                showPopup(data.names);
                            });
                    };
                    var hidePopup = () => {
                        mentionPopup.classList.add('is-hidden');
                        mentionList.innerHTML = '';
                    };
                    var showPopup = (names, caretPos) => {
                        mentionList.innerHTML = ''; // Clear previous list
                        if (names.length === 0) {
                            hidePopup();
                            return;
                        }

                        names.forEach((name, index) => {
                            var listItem = document.createElement('li');
                            listItem.textContent = name;
                            listItem.dataset.name = name; // Store the name for easy access
                            listItem.addEventListener('click', () => selectName(name));
                            mentionList.appendChild(listItem);
                        });

                        // Position the popup
                        const textareaRect = textarea.getBoundingClientRect();
                        // This is a simplified way to position. For precise positioning at caret,
                        // you'd need a library or more complex calculation based on font metrics.
                        // For now, we'll position it relative to the textarea.
                        mentionPopup.style.left = `${textarea.offsetLeft}px`;
                        mentionPopup.style.top = `${textarea.offsetTop + textarea.offsetHeight}px`;
                        mentionPopup.style.width = `${textarea.offsetWidth}px`; // Match textarea width

                        mentionPopup.classList.remove('is-hidden');
                    };
                });*/
            }
        });
    </script>
</div>
{%- endmacro %}

{% macro listeditor(user, obj, attr, limit=0) -%}
{# {% if new %}
<div class="row is-vertical">
    <div class="column is-shrink">
        <button type="button" class="button is-small"
                hx-post='/api/manage/details/add/listitem/{{attr}}' hx-target='#{{attr}}-item-list'
                hx-select='#{{attr}}-item-list'
                hx-swap='outerHTML' hx-trigger="click consume">
            <iconify-icon icon="simple-line-icons:plus"></iconify-icon>
            New {{attr | title}}
        </button>
    </div>
</div>
{% endif %} #}
<div class="row is-vertical" id='{{attr}}-item-list' data-max='{{limit}}'>
    {% for item in obj[attr] %}
    <div class="column">
        <div onmouseout="tinyMCE.triggerSave();">
            <textarea id="edit-{{obj.pk}}-{{attr}}-{{loop.index}}"
                      name="{{attr}}[]">{{item | string | safe}}</textarea>
        </div>
        <script>
            tinyMCE.remove('#edit-{{ obj.pk }}-{{ attr }}-{{ loop.index }}');
            tinyMCE.init({
                selector: '#edit-{{ obj.pk }}-{{ attr }}-{{ loop.index }}',
                toolbar: 'undo redo searchreplace | styles | bold italic blockquote link | alignleft aligncenter alignright alignjustify | outdent indent numlist bullist | removeformat | fullscreen',
                toolbar_sticky: true,
                plugins: 'wordcount autoresize fullscreen lists link searchreplace',
                //resize: 'true',
                min_height: 50,
                content_style: "body {font - family:Open-Sans,sans-serif;font-size:1.25rem;line-height: 1.5;}",
                menubar: false,
                promotion: false,
                license_key: 'gpl',
                setup: function (editor) {
                    var max = parseInt(htmx.find("#{{attr}}-item-list").dataset.max);
                    editor.on('change', function (e) {
                        console.log(max);
                        var numChars = editor.plugins.wordcount.body.getCharacterCount();
                        if (max && numChars > max) {
                            alert("Maximum " + numChars + "/" + max + " characters allowed.");
                            return false;
                        } else {
                            tinymce.triggerSave();
                            htmx.trigger("#edit-{{ obj.pk }}-{{ attr }}-{{ loop.index }}", 'input');
                            htmx.trigger("#edit-{{ obj.pk }}-{{ attr }}-{{ loop.index }}", 'change');
                        }
                    });
                }
            });
        </script>
    </div>
    {%endfor%}
</div>
{%- endmacro %}

{% macro richtexteditor(user, obj, attr, content=None, limit=0, name="") -%}

<script>
    createCK('edit-{{obj.pk}}-{{attr}}');
</script>
{%- endmacro %}