{% import "_nav.html" as nav %}
{% import "shared/_title.html" as title %}
{% import "manage/_gmscreen.html" as gmscreen %}
{% import "shared/_icons.html" as icon_components %}
{% import "shared/_display.html" as display %}

<!doctype html>
<html class="no-js" lang="en">

    <head>
        {% block head %}
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta charset="utf-8">
        <link rel="apple-touch-icon" sizes="180x180"
              href="{{url_for('static', filename='images/apple-touch-icon.png')}}">
        <link rel="icon" type="image/png" sizes="32x32"
              href="{{url_for('static', filename='images/favicon-32x32.png')}}">
        <link rel="icon" type="image/png" sizes="16x16"
              href="{{url_for('static', filename='images/favicon-16x16.png')}}">

        <!--------------------------- Vendor CSS libs ---------------------------->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
              integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Literata:ital,opsz,wght@0,7..72,200..900;1,7..72,200..900&display=swap"
              rel="stylesheet">

        <style>
            @import url('https://fonts.googleapis.com/css2?family=Open+Sans&display=swap');
            @import url('https://fonts.googleapis.com/css2?family=Changa:wght@200..800&family=Comic+Neue:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Coming+Soon&family=Jaro:opsz@6..72&family=Josefin+Slab:ital,wght@0,100..700;1,100..700&family=Noto+Serif+Display:ital,wght@0,100..900;1,100..900&family=Rosarivo:ital@0;1&family=Wellfleet&display=swap');
        </style>
        <!--------------------------- Custom CSS ---------------------------->
        <!-- Compiled and minified CSS
        <link rel="stylesheet" type="text/css"
              href="{{ url_for('static', filename='style/main.css') }}">-->

        <!--------------------------- Vendor JavaScript Libs ---------------------------->
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"
                integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
                crossorigin="anonymous"></script>
        <script
                src="https://cdn.jsdelivr.net/npm/@tinymce/tinymce-webcomponent@2/dist/tinymce-webcomponent.min.js"></script>
        <script src="{{ url_for('static', filename='js/tinymce/tinymce.min.js') }}"
                referrerpolicy="origin"></script>
        <script src="{{ url_for('static', filename='js/sortable.js') }}"></script>
        <script src="https://unpkg.com/htmx.org@1.9.11"
                integrity="sha384-0gxUXCCR8yv9FM2b+U3FDbsKthCI66oH5IA9fHppQq9DDMHuMauqq1ZHBpJxQ0J0"
                crossorigin="anonymous"></script>
        <script src="https://unpkg.com/htmx.org@1.9.11/dist/ext/json-enc.js"></script>
        <script src="https://code.iconify.design/iconify-icon/1.0.3/iconify-icon.min.js"></script>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
                integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
                crossorigin=""></script>
        <script src="https://unpkg.com/@popperjs/core@2"></script>
        <script src="https://unpkg.com/tippy.js@6"></script>

        <!-- Compressed CSS -->
        <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/foundation-sites@6.9.0/dist/css/foundation.min.css"
              crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/46.0.0/ckeditor5.css" />

        <!-- Compressed JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/foundation-sites@6.9.0/dist/js/foundation.min.js"
                crossorigin="anonymous"></script>

        <style>
            body {
                font-family: 'Rosarivo', serif;
                -webkit-font-smoothing: initial;
            }

            .h1,
            .h2,
            .h3,
            .h4,
            .h5,
            .h6,
            h1,
            h2,
            h3,
            h4,
            h5,
            h6 {
                font-family: 'Rosarivo';
            }

            .container {
                max-width: 75rem;
                margin-right: auto;
                margin-left: auto;
                background-color: #eee;
            }

            .main-panel {
                font-size: 1.2rem;
            }

            .side-panel {
                background-color: #ddd;
            }

            h2 {
                font-size: clamp(1.5rem, 2.25vw, 2.0rem);
            }

            h3 {
                font-size: clamp(1.2rem, 2vw, 1.5rem);
            }

            h4 {
                font-size: clamp(1.1rem, 1.9vw, 1.3rem);
            }

            h5 {
                font-size: clamp(1.05rem, 1.8vw, 1.2rem);
            }

            h6 {
                font-size: clamp(1.0rem, 1.75vw, 1.1rem);
            }

            h2,
            h3,
            h4,
            h5,
            h6 {
                border-bottom: 1px solid #bbb;
                text-align: center;
            }

            h2 {
                margin: 2rem 0 1rem;
                padding-top: 1rem;
                border-top: .3rem solid;
            }

            .accordion-title {
                font-size: inherit;
            }

            table.ability {
                font-size: 90%;
            }

            .object-name {
                font-family: 'Open Sans', sans-serif;
                font-size: 0.75rem;
                font-weight: 600;
                text-align: center;
            }

            input[type="number"] {
                width: 3em;
                text-align: center;
            }

            input.year {
                width: 5em;
            }

            #top-nav {
                background-color: #c3ddef;
            }

            #object-title {
                background-color: #304350;
            }

            #object-menu {
                background-color: #dee2e5;
            }

            h1 {
                margin: .3em 0;
                color: white;
            }

            #logo {
                font-size: 2rem;
                display: flex;
            }

            #nav-search {
                position: absolute;
                background: white;
            }

            li.menu a {
                width: 100%;
            }

            #sidenav {
                background-color: #efe;
            }
        </style>

        <!-- JavaScript Libs -->
        <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>

        {% endblock %}
        {% block head_ext %}
        {% endblock %}
    </head>

    <body hx-ext='json-enc' hx-vals='{
                "user": "{%if user%}{{user.pk}}{%endif%}",
                "model": "{%if obj%}{{obj.model_name().lower()}}{%endif%}",
                "pk": "{%if obj%}{{obj.pk}}{%endif%}"
            }'>
        <div id="nav" style='box-shadow: 0px 1px 5px; margin-bottom:2px;'>
            {% block topnav %}
            {{nav.site_header(user)}}
            {% endblock %}
        </div>

        {% if obj %}

        <!-- display the current world -->
        <div class="title-bar align-center">
            <div class="align-middle">
                <a class="align-middle" style="display: flex; font-size: 1.5rem;"
                   href="/{{obj.world.path}}">{{icon_components.world(size="2rem")}} &nbsp;
                    {{obj.world.name}}</a>
            </div>
        </div>

        <!-- display the object title  -->
        <section id="object-title">
            {{title.object_title(user, obj)}}
        </section>


        <!-- display the object menu  -->
        <section id="object-menu">
            {{nav.object_menu(user, obj)}}
        </section>

        {% endif %}

        {% if page_url %}
        <div class="container" id="page-content"
             hx-get='/api{{page_url}}'
             hx-trigger='load'
             hx-indicator='#request-indicator'
             hx-push-url='{{page_url}}'>
        </div>
        {% endif %}

        <div class="image htmx-indicator has-text-muted has-bg-screen" id="request-indicator">
            <img src="/static/images/grid.svg" alt="loading">
        </div>
        <footer style="height: 4rem;">
            <div class="grid-x">
                <div class="cell auto">
                    {% block footer %}{% endblock %}
                </div>
                <div class="cell shrink">
                    <button class="button large" id="back-to-top"
                            onclick="window.scrollTo({top: 0,behavior: 'smooth'});">
                        {{icon_components.top(size="1.5rem")}}
                    </button>
                </div>
            </div>
        </footer>
    </body>


    <script>
        $(function () {
            $(document).foundation();
            //chopMentions();
        });
        // also re-run foundation after htmx loads
        document.addEventListener('htmx:afterSettle', function (evt) {
            $(document).foundation();
            chopMentions();
            //createCK('rich-text');
        });
    </script>

    <script src="https://cdn.ckeditor.com/ckeditor5/46.0.0/ckeditor5.umd.js"></script>
    <script>
        const {
            ClassicEditor,
            Essentials,
            Bold,
            Italic,
            Font,
            Paragraph,
            Mention,
            Autosave
        } = CKEDITOR;

        function getMentions(queryText) {
            const url = '/api/nav/mentions';
            const data = {
                query: queryText,
                user: '67886696f166a76d0ce3ba82',
                model: 'world',
                pk: '6764552d82587e6d53d86794'
            };

            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('Success:', result);
                    return result;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function createCK(el, str = '') {
            ClassicEditor
                .create(document.querySelector('#' + el), {
                    licenseKey: 'eyJhbGciOiJFUzI1NiJ9.eyJleHAiOjE3ODYyMzM1OTksImp0aSI6IjZmNGQyMWFjLWM0OGYtNDcwMi1iM2JiLTVlYjVlZTZiN2MxMiIsInVzYWdlRW5kcG9pbnQiOiJodHRwczovL3Byb3h5LWV2ZW50LmNrZWRpdG9yLmNvbSIsImRpc3RyaWJ1dGlvbkNoYW5uZWwiOlsiY2xvdWQiLCJkcnVwYWwiXSwiZmVhdHVyZXMiOlsiRFJVUCIsIkUyUCIsIkUyVyJdLCJ2YyI6ImMwNzQzZjhmIn0.r8JxebXnjUerSrIGjFJlHwJ5c3HHLxSwqYE8AZNGXPhcWlvRadM1SHnymMysWebK3DI6b6gIUEHQLpYTzZjS3g',
                    plugins: [Autosave, Essentials, Bold, Italic, Font, Paragraph, Mention, MentionCustomization],
                    toolbar: [
                        'undo', 'redo', '|', 'bold', 'italic', '|',
                        'fontSize', 'fontFamily', 'fontColor'
                    ],
                    mention: {
                        feeds: [
                            {
                                marker: '@',
                                feed: getMentions,
                                minimumCharacters: 3
                            }
                        ],
                    }, autosave: {
                        waitingTime: 5000, // in ms
                        save(editor) {
                            console.log('savvvving');
                            //const textarea = document.getElementById(el);
                            //textarea.value = editor.getData();
                            //htmx.process(textarea);
                            return saveData(editor.getData(), el);
                        }
                    },
                })
                .then()
                .catch();
        }
        function saveData(data, el) {
            return new Promise(resolve => {
                setTimeout(() => {
                    //console.log(el);
                    const textarea = document.getElementById(el);
                    textarea.value = data;
                    myform = textarea.closest('form');
                    htmx.trigger(myform, 'change');

                    console.log('Saved', data);
                    //console.log( textarea.closest('form') );
                    //htmx.process(textarea.closest('form'));
                    /*
                    */

                    resolve();
                }, 5);
            });
        }

        function MentionCustomization(editor) {
            // The upcast converter will convert view <a class="mention" href="" data-user-id="">
            // elements to the model 'mention' text attribute.
            editor.conversion.for('upcast').elementToAttribute({
                view: {
                    name: 'a',
                    key: 'data-mention',
                    classes: 'mention',
                    attributes: {
                        href: true,
                        'data-obj-id': true
                    }
                },
                model: {
                    key: 'mention',
                    value: viewItem => {
                        // The mention feature expects that the mention attribute value
                        // in the model is a plain object with a set of additional attributes.
                        // In order to create a proper object use the toMentionAttribute() helper method:
                        const mentionAttribute = editor.plugins.get('Mention').toMentionAttribute(viewItem, {
                            // Add any other properties that you need.
                            link: viewItem.getAttribute('href'),
                            pk: viewItem.getAttribute('data-obj-id')
                        });

                        return mentionAttribute;
                    }
                },
                converterPriority: 'high'
            });

            // Downcast the model 'mention' text attribute to a view <a> element.
            editor.conversion.for('downcast').attributeToElement({
                model: 'mention',
                view: (modelAttributeValue, { writer }) => {
                    // Do not convert empty attributes (lack of value means no mention).
                    if (!modelAttributeValue) {
                        return;
                    }

                    return writer.createAttributeElement('a', {
                        class: 'mention',
                        'data-mention': modelAttributeValue.id,
                        'data-obj-id': modelAttributeValue.pk,
                        'href': '/' + modelAttributeValue.type + '/' + modelAttributeValue.pk
                    }, {
                        // Make mention attribute to be wrapped by other attribute elements.
                        priority: 20,
                        // Prevent merging mentions together.
                        id: modelAttributeValue.uid
                    });
                },
                converterPriority: 'high'
            });
        }

    </script>

    <script>
        function chopMentions() {
            // chops the "@" from the mentions link
            $('.mention').each(function () {
                let originalText = $(this).text().trim();
                if (originalText.length > 0) {
                    let newText = originalText.replace("@", "");
                    $(this).text(newText);
                }
            });
        }
    </script>

</html>