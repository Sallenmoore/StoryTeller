{% import "shared/_form.html" as form_components %}
{% import "shared/_display.html" as display_components %}
{% import "shared/_icons.html" as icon_components %}
{% import "shared/_tasks.html" as task_components %}
{% import "shared/_abilities.html" as abilities_components %}

{% macro campaigns(user, obj, campaign_list, campaign=None, episode=None) -%}
<title>{{obj.name | title}} - Manage Campaign</title>
<h2 class='has-text-dark' id='manage-campaigns'>
    Manage Campaigns
</h2>
<div id="world-campaign-details" class="raise-it">
    <div class="row">
        <div class="column">
            <select class="has-bg-muted" name="campaignpk" id="campaignpk"
                    hx-post="/api/campaign/"
                    hx-target="#page-content" hx-trigger='change'
                    onchange='history.pushState({}, "", `/world/{{obj.pk}}/campaigns/manage/${this.value}`);'>
                <option value="">=== Select Campaign ===</option>
                {% for cmp in campaign_list %}
                <option class="has-text-dark" value="{{cmp.pk}}" {% if campaign.pk==cmp.pk %}
                        selected {% endif %}>
                    {{cmp.name}} : {{ cmp.start_date }} - {{cmp.end_date}}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="column is-shrink is-end">
            <button class="button is-primary is-small" hx-post="/api/campaign/new"
                    hx-target="#world-campaign-details" hx-select="#world-campaign-details"
                    hx-swap="outerHTML">
                <iconify-icon icon="mdi:plus" width="1rem" height="1rem"></iconify-icon>
                New Campaign
            </button>
        </div>
    </div>
    {% if campaign %}
    <div class="tabs has-border">
        <ul class="campaign_tablist tabs__list has-centered ">
            <li class="{% if not episode %} is-active {% endif %} has-text-dark"
                hx-post='/api/campaign/{{campaign.pk}}/details'
                hx-target='#details-container'
                onclick="activeTab(this)">
                <a>
                    Campaign Details
                </a>
            </li>
            <li class="{% if episode %} is-active {% endif %} has-text-dark"
                hx-post='/api/campaign/{{campaign.pk}}/episode/{{episode.pk}}'
                hx-target='#details-container'
                onclick="activeTab(this)">
                <a>
                    Episode Details
                </a>
            </li>
        </ul>
        <div class="row">
            <div id='details-container' class="column is-full">
                {% if episode %}
                {{episode_details(user, obj, campaign, episode)}}
                {% else %}
                {{campaign_details(user, obj, campaign)}}
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
<script>
    function activeTab(elem) {
        for (x of elem.closest("ul").children) {
            x.classList.remove("is-active");
        }
        elem.closest("li").classList.add("is-active");
    }
</script>
{%- endmacro %}

{% macro campaign_details(user, obj, campaign) -%}
<div class="section is-small">
    <div class="panel has-bg-screen">
        <div class="row has-space-around">
            <div class="column is-shrink">
                {% if campaign.start_date %}
                <h5>Began: {{campaign.start_date}}</h5>
                {% endif %}
            </div>
            <div class="column is-shrink">
                {% if campaign.end_date %}
                <h5>Ended: {{campaign.end_date}}</h5>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="panel has-bg-muted has-text-dark" style='position:relative;'>
        {{campaign.summary | safe}}
        <div style='position: absolute; bottom:0px; right:0px;'>
            <div class="row">
                <div class="column">
                    <button class='button is-small' class="button is-primary"
                            hx-post="/task/generate/campaign/{{campaign.pk}}/summary"
                            hx-target='closest .column'>
                        Update Summary
                    </button>
                </div>
            </div>
        </div>
    </div>
    <form hx-post="/api/campaign/{{campaign.pk}}/update" hx-swap='none'
          hx-trigger='input delay:0.5s'>
        <div class="row has-space-between" id="current-campaign-name">
            <div class="column is-full has-text-secondarybg">
                <div class="row">
                    <div class="column is-shrink is-vertically-centered">
                        <h4>Name</h4>
                    </div>
                    <div class="column is-vertically-centered">
                        <input class="has-bg-light" type="text" name="name"
                               value="{{campaign.name}}">
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div class="row" id="current-campaign-description">
            <div class="column is-full has-text-secondarybg">
                <h3 class='has-text-center'>Description</h>
                    {{form_components.texteditor(user, campaign, 'description')}}
            </div>
        </div>
    </form>
    <hr class='has-bg-primary'>
    <div class="row" id='campaign-players'>
        <div class="column is-4">
            <h5>Add Faction</h5>
            <div class="panel has-bg-muted">
                <div class="is-multiple-select">
                    <select
                            name='party'
                            style='max-height: 20rem;'
                            hx-post="/api/campaign/{{campaign.pk}}/add/party"
                            hx-target="#campaign-players" hx-select="#campaign-players"
                            hx-swap="outerHTML" hx-indicator='#request-indicator'>
                        {% for faction in obj.factions%}
                        {% if faction.is_player_faction %}
                        <option value='{{faction.pk}}' {% if faction==campaign.party %} selected {%
                                endif %}
                                style='height:3rem; text-align: end; {% if faction.image %} background:
                            left / contain no-repeat url({{faction.image.url(size=50)}});{% endif %}
                            font: 1.25rem "Rosarivo", cursive;'>
                            {{faction.name}}
                        </option>
                        {%endif%}
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="column is-shrink">
            {% if campaign.party %}
            {{display_components.object_display(campaign.party, dim=250, type=False)}}
            {% endif %}
        </div>
        <div class="column">
            <div class="panel">
                <h3 class='has-text-center'> Players </h3>
                <div class="row has-space-around">
                    {% for p in campaign.players %}
                    <div class="column is-2 has-text-center">
                        {{display_components.object_display(p, dim=250, type=False)}}
                        <a
                           hx-post="/api/campaign/{{campaign.pk}}/removeplayer/{{p.pk}}"
                           hx-target="#campaign-players" hx-select="#campaign-players"
                           hx-swap="outerHTML" hx-indicator=' #request-indicator'
                           hx-confirm="Are you sure you want to remove this player from the campaign?">
                            <iconify-icon icon="mdi:remove" width="1rem"></iconify-icon>
                        </a>
                    </div>
                    {% endfor%}
                </div>
            </div>
        </div>
    </div>
    <div class="section is-small">
        <div class="panel">
            <h2 class='has-text-center'> Associations </h2>
            {% for title in ['Locations', 'POIs', 'Characters', 'Creatures', 'Items', 'Factions'] %}
            {% set obj_key = title | lower %}
            {% if campaign[obj_key] %}
            <hr class='has-bg-muted'>
            <h3 class='has-text-center'> {{title}} </h3>
            <div class="row has-space-around" id="episode-encounters">
                {% for a in campaign[obj_key] %}
                <div class="column is-2 episode-association-entry">
                    <div class="row">
                        <div class="column is-full">
                            {{display_components.object_display(a)}}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    <hr class='has-bg-muted'>
    <div class="row">
        <div class="column is-shrink is-center">
            <a hx-post="/api/campaign/{{campaign.pk}}/delete"
               hx-target="#page-content"
               hx-confirm='Are you sure you want to delete this campaign?'>
                <iconify-icon icon="mdi:trash-outline" width="1.5rem"></iconify-icon>
            </a>
        </div>
    </div>
</div>
{%- endmacro %}

{% macro episode_details(user, obj, campaign, episode=None) -%}
<div class="section is-small">
    <h3 class='has-text-primary'>Episode Select</h3>
    <div class="row">
        <div class="column">
            <select id="episode-select" class="has-bg-muted" name="episodepk"
                    hx-post="/api/campaign/{{campaign.pk}}/episode/manage"
                    hx-target="#episode-details"
                    hx-select="#episode-details"
                    hx-trigger='change' hx-indicator='#request-indicator'>
                <option value="">==Select Episode==</option>
                {% for ep in campaign.episodes %}
                <option value="{{ep.pk}}" {%if episode and
                        ep==episode %} selected {% endif %}>
                    {{ep.name}}:
                    {{ep.start_date}}
                    -
                    {{ ep.end_date }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="column is-shrink is-end">
            <button class="button is-primary is-small"
                    hx-post="/api/campaign/{{campaign.pk}}/episode/new"
                    hx-target="#world-campaign-details"
                    hx-select="#world-campaign-details"
                    hx-swap="outerHTML">
                <iconify-icon icon="mdi:plus" width="1rem"
                              height="1rem"></iconify-icon>
                New
                Episode
            </button>
        </div>
    </div>
    <div class="row fade-it-in" id='campaign-episode-container'>
        <div id='episode-details' class="column">
            {% if episode %}
            <div class="row has-space-around">
                <div class="column">
                    <div class="panel has-bg-muted has-text-dark generated-text-lightbg"
                         style='position:relative;'>
                        {{episode.summary | safe}}
                        <button class='button is-small' class="button is-primary"
                                style='position: absolute; bottom:0px; right:0px;'
                                hx-post="/task/generate/campaign/episode/{{episode.pk}}/summary"
                                hx-target='closest .column'>
                            Update Summary
                        </button>
                    </div>
                </div>
            </div>
            <hr>
            <form hx-post="/api/campaign/{{episode.campaign.pk}}/episode/{{episode.pk}}/manage"
                  hx-swap='none'
                  hx-trigger='input delay:1s, change'>
                <div class="row">
                    <div class="column is-6">
                        <h4 class='has-text-center has-text-dark'>Name</h4>
                        <input class="has-bg-light has-text-center" type="text" name="name"
                               value="{{episode.name}}">
                    </div>
                    <div class="column is-6">
                        <h4 class='has-text-center has-text-dark'>Episode Number</h4>
                        <input class="has-bg-light has-text-center" type="number" name="episode_num"
                               value="{{episode.episode_num}}">
                    </div>
                </div>
                <div class="row">
                    <div class="column inputlabel">
                        <h5 class='has-text-primary has-text-center'>Start Date</h5>
                        <input class='has-bg-light has-text-center' type="text"
                               name="start_date"
                               value="{{episode.start_date}}">
                    </div>
                    <div class="column inputlabel">
                        <h5 class='has-text-primary has-text-center'>End Date</h5>
                        <input class='has-bg-light has-text-center' type="text" name="end_date"
                               value="{{episode.end_date}}">
                    </div>
                </div>
            </form>
            <div class="tabs has-border">
                <ul class="episode_tablist tabs__list has-centered ">
                    <li class="has-text-dark is-active">
                        <a hx-post='/api/campaign/episode/{{episode.pk}}/gmplanner'
                           hx-target='#episode-manage-container'
                           onclick="activeTab(this)">
                            <h5 class='has-text-center has-text-dark'>GM Planner</h5>
                        </a>
                    </li>
                    <li class='has-text-dark'>
                        <a hx-post='/api/campaign/episode/{{episode.pk}}/generator'
                           hx-target='#episode-manage-container'
                           onclick="activeTab(this)">
                            <h5 class='has-text-center has-text-dark'>Campaign Generator</h5>
                        </a>
                    </li>
                    <li class='has-text-dark'>
                        <a hx-post='/api/campaign/episode/{{episode.pk}}/report'
                           hx-target='#episode-manage-container'
                           onclick="activeTab(this)">
                            <h5 class='has-text-center has-text-dark'>Episode Report</h5>
                        </a>
                    </li>
                    <li class="has-text-dark">
                        <a hx-post='/api/campaign/episode/{{episode.pk}}/party'
                           hx-target='#episode-manage-container'
                           onclick="activeTab(this)">
                            <h5 class='has-text-center has-text-dark'>Party Members</h5>
                        </a>
                    </li>
                    <li class="has-text-dark">
                        <a hx-post='/api/campaign/episode/{{episode.pk}}/associations'
                           hx-target='#episode-manage-container'
                           onclick="activeTab(this)">
                            <h5 class='has-text-center has-text-dark'>Associations</h5>
                        </a>
                    </li>
                    <li class="has-text-dark">
                        <a hx-post='/api/campaign/episode/{{episode.pk}}/extras'
                           hx-target='#episode-manage-container'
                           onclick="activeTab(this)">
                            <h5 class='has-text-center has-text-dark'>Extras</h5>
                        </a>
                    </li>
                </ul>
                <div class="row">
                    <div id="episode-manage-container" class="column episode_tabs fade-it-in">
                        {{episode_gmplanner(user, obj, episode)}}
                    </div>
                </div>
            </div>
            <div class="row ">
                <div class="column is-end is-shrink">
                    <button class="button is-light has-text-dark"
                            hx-post="/api/campaign/episode/{{episode.pk}}/delete"
                            hx-target="#details-container"
                            hx-select="#details-container"
                            hx-swap="outerHTML"
                            hx-confirm='Are you sure you want to delete this Episode?'>
                        <iconify-icon icon="mdi:trash-outline" width="1rem"></iconify-icon>
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{%- endmacro %}

{% macro episode_party_details(user, world, party) -%}
<hr>
{% if party%}
<div class="tabs has-bg-primary has-text-muted is-vertically-centered">
    <ul class="tabs__list has-centered has-text-muted">
        {% for player in party.players %}
        <li style='padding: 1rem;'>
            <a href="#player-card-container-{{player.pk}}"
               class='is-small-heading has-text-center has-text-muted'>
                {{player.name}}
            </a>
        </li>
        {% if not loop.last %}
        <li>{{icon_components.d20dice(size="1rem")}}</li>
        {% endif %}
        {% endfor %}
    </ul>
</div>
<div class="row has-space-around">
    {% for player in party.players %}
    <div class="column has-no-padding has-no-margin is-full">
        {{episode_player_card(user, party, player)}}
    </div>
    {% endfor %}
</div>
{% endif %}
{%- endmacro %}


{% macro episode_player_card(user, party, player) %}
<div id="player-card-container-{{player.pk}}" class='panel has-bg-screen'>
    <h3 class='has-text-center has-text-black'>
        {{player.name}}
    </h3>
    <div id="object-card-{{player.pk}}" class='row initiative-card'>
        <div class="column is-shrink has-text-center">
            {{display_components.object_display(player, dim="250", name=False, type=False)}}
            <div class="row">
                <div class="column is-full player-card-abilities">
                    <div class="panel has-bg-muted">
                        <div class="row has-space-around has-text-center has-text-dark"
                             style='cursor: pointer;'>
                            <div class="column is-4 is-mobile-3" onclick='setbonus(this);'>
                                <h4 class="has-text-dark">STR</h4>
                                <p>{{player.strength}} ({{(player.strength|int-10)//2}})</p>
                            </div>
                            <div class="column is-4 is-mobile-3" onclick='setbonus(this);'>
                                <h5 class="has-text-dark">DEX</h5>
                                <p>{{player.dexterity}} ({{(player.dexterity|int-10)//2}})
                                </p>
                            </div>
                            <div class="column is-4 is-mobile-3" onclick='setbonus(this);'>
                                <h5 class="has-text-dark">INT</h5>
                                <p>{{player.intelligence}}
                                    ({{(player.intelligence|int-10)//2}})</p>
                            </div>
                            <div class="column is-4 is-mobile-3" onclick='setbonus(this);'>
                                <h5 class="has-text-dark">WIS</h5>
                                <p>{{player.wisdom}} ({{(player.wisdom|int-10)//2}})</p>
                            </div>
                            <div class="column is-4 is-mobile-3" onclick='setbonus(this);'>
                                <h5 class="has-text-dark">CHA</h5>
                                <p>{{player.charisma}} ({{(player.charisma|int-10)//2}})</p>
                            </div>
                            <div class="column is-4 is-mobile-3" onclick='setbonus(this);'>
                                <h5 class="has-text-dark">CON</h5>
                                <p>{{player.constitution}}
                                    ({{(player.constitution|int-10)//2}})</p>
                            </div>
                        </div>
                    </div>
                    <div class="row has-space-around">
                        <div class="column is-shrink">
                            <h4 class='has-text-dark has-text-center'>Current HP</h4>
                            <div class="row has-space-around">
                                <div class="column is-shrink  inputlabel">
                                    <input class="has-text-center has-text-white"
                                           style='font-size:1.25rem; width:5rem;'
                                           name='current_hitpoints'
                                           value="{{player.current_hitpoints}}"
                                           hx-post='/api/autogm/{{player.pk}}/current_hitpoints'
                                           hx-swap='none' />
                                </div>
                                <div class="column is-shrink">
                                    <h5 class='has-text-dark'>/{{player.hitpoints}}</h5>
                                </div>
                            </div>
                        </div>
                        <div class="column is-shrink">
                            <h4 class='has-text-dark has-text-center'>AC</h4>
                            <h5 class='has-text-dark has-text-center'>{{player.ac}}</h5>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <div class="column">
            <div class="tabs has-bg-muted">
                <ul class="tabs__list has-centered has-space-around has-text-primary">
                    <li
                        onclick='panelselect("#card-history-details-panel-{{player.pk}}");'>
                        <a>History</a>
                    </li>
                    <li
                        onclick='panelselect("#card-skills-details-panel-{{player.pk}}");'>
                        <a>Skills</a>
                    </li>
                    <li
                        onclick='panelselect("#card-abilities-details-panel-{{player.pk}}");'>
                        <a>Abilities</a>
                    </li>
                    <li
                        onclick='panelselect("#card-inventory-details-panel-{{player.pk}}");'>
                        <a>Inventory</a>
                    </li>
                </ul>
                <script>
                    function panelselect(target) {
                        for (var panel of document.querySelectorAll(".card-details-panel")) {
                            panel.classList.add("is-hidden");
                        }
                        document.querySelector(target).classList.remove("is-hidden");
                    }
                </script>
            </div>
            <div class="row">
                <div id="card-skills-details-panel-{{player.pk}}"
                     class="column card-details-panel is-full generated-text-lightbg">
                    <div class="row has-space-around">
                        {% for skill, val in player.skills.items() %}
                        <div class="column is-shrink is-mobile-3">
                            <div class="panel has-bg-muted is-full">
                                <h5 class='has-text-center '>{{skill}}</h5>
                                <p class='has-text-center'>{{val}}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div id="card-abilities-details-panel-{{player.pk}}"
                     class="column card-details-panel is-hidden is-full generated-text-lightbg">
                    {{abilities_components.abilities(user, player)}}
                </div>
                <div id="card-history-details-panel-{{player.pk}}"
                     class="column card-details-panel is-hidden is-full generated-text-lightbg has-text-justified">
                    <h2 class='has-text-dark'>History</h2>
                    <div class="panel has-bg-light-grey">
                        {{ player.history | safe }}
                    </div>
                </div>
                {% if player.items %}
                <div id='card-inventory-details-panel-{{player.pk}}'
                     class="column card-details-panel is-full is-hidden ">
                    <div class="panel has-bg-dark-grey">
                        <div class="row has-space-around">
                            {% for item in player.items %}
                            <div class="column is-1">
                                {{display_components.object_display(item, dim=250, type=False, name=False, modal=True)}}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{%- endmacro %}


{% macro episode_report(user, obj, episode, afilter=None) -%}
<div class="row has-centered">
    <div class="column is-shrink">
        <button class='button is-primary is-small'
                hx-post='/api/campaign/episode/{{episode.pk}}/report/build'
                hx-target="#episode-report-container"
                hx-select="#episode-report-container"
                hx-swap='outerHTML'>
            Build Report
        </button>
    </div>
    <div class="column is-full">
        <hr>
        <form hx-post="/api/campaign/{{episode.campaign.pk}}/episode/{{episode.pk}}/manage"
              hx-swap='none'
              hx-trigger='input delay:1s, change'>
            <div id="episode-report-container" class="fade-it-in">
                {{form_components.texteditor(user, episode, 'episode_report')}}
            </div>
        </form>
    </div>
</div>
{%- endmacro %}

{% macro episode_associations(user, obj, episode, afilter=None) -%}
<div id="episode-associations" class="row">
    <div class="column fade-it-in">
        <hr>
        <h5 class='has-text-primary'>Add New...</h5>
        <div class="row has-space-around">
            {% for model in obj.all_models_str() %}
            <div class="column is-shrink">
                <button class='button is-small'
                        hx-post='/api/campaign/episode/{{episode.pk}}/associations/add/{{model | lower}}'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-vals='{"episodepk":"{{episode.pk}}"}'
                        hx-swap='outerHTML'>
                    {{obj.get_title(model)}}
                </button>
            </div>
            {% endfor %}
        </div>
        <h5 class='has-text-primary'>...or Add Existing</h5>
        <div class="row">
            <div class="column is-shrink">
                <button class='button is-primary is-small'
                        hx-post='/api/campaign/episode/{{episode.pk}}/associations/add/campaignassociations'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-vals='{"episodepk":"{{episode.pk}}"}'
                        hx-swap='outerHTML'>
                    All Campaign Associations
                </button>
            </div>
            <div class="column is-shrink">
                <button class='button is-primary is-small'
                        hx-post='/api/campaign/episode/{{episode.pk}}/associations/add/episodeassociations'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-vals='{"episodepk":"{{episode.pk}}"}'
                        hx-swap='outerHTML'>
                    Previous Episode Associations
                </button>
            </div>
            <div class="column is-shrink">
                <button class='button is-primary is-small'
                        hx-post='/api/campaign/episode/{{episode.pk}}/associations/add/players'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-vals='{"episodepk":"{{episode.pk}}"}'
                        hx-swap='outerHTML'>
                    players
                </button>
            </div>
            <div class="column">
                <div class="has-dropdown" style="width: 100%;">
                    <input class="has-bg-light" autocomplete="off" type="search" name="query"
                           style="border-bottom: solid #000;"
                           hx-post="/api/campaign/episode/{{episode.pk}}/associations/add/search"
                           hx-target="#episode-new-associations-list"
                           hx-trigger="input changed delay:500ms consume"
                           hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
                    <ul class="dropdown has-bg-light" id="episode-new-associations-list">
                    </ul>
                </div>
            </div>
        </div>

        <hr>
        <div class="panel has-bg-screen">
            <section class='section is-small'>
                <div class="row">
                    <div class="column is-shrink">
                        <h5>Filter by</h5>
                    </div>
                    <div class="column is-half is-centered">
                        <div class="select">
                            <select class='has-bg-muted' name="filter"
                                    hx-get="/api/campaign/episode/{{episode.pk}}/associations"
                                    hx-trigger="change" hx-indicator='#request-indicator'
                                    hx-target="#episode-associations">
                                <option value="">All</option>
                                {% for model in obj._models %}
                                <option value="{{model}}" {% if afilter==model %} selected
                                        {%
                                        endif
                                        %}>
                                    {{obj.get_title(model)}}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </section>
            {% if episode.encounters %}
            {{ episode_association_display(user, obj, episode, episode.encounters, obj.get_title("Encounter")) }}
            {% endif %}
            {% if episode.locations %}
            {{ episode_association_display(user, obj, episode, episode.locations, obj.get_title("Location")) }}
            {% endif %}
            {% if episode.districts %}
            {{ episode_association_display(user, obj, episode, episode.districts, obj.get_title("District")) }}
            {% endif %}
            {% if episode.characters %}
            {{ episode_association_display(user, obj, episode, episode.characters, obj.get_title("Character")) }}
            {% endif %}
            {% if episode.creatures %}
            {{ episode_association_display(user, obj, episode, episode.creatures, obj.get_title("Creature")) }}
            {% endif %}
            {% if episode.items %}
            {{ episode_association_display(user, obj, episode, episode.items, obj.get_title("Item")) }}
            {% endif %}
            {% if episode.vehicles %}
            {{ episode_association_display(user, obj, episode, episode.vehicles, obj.get_title("Vehicle")) }}
            {% endif %}
            {% if episode.factions %}
            {{ episode_association_display(user, obj, episode, episode.factions, obj.get_title("Faction")) }}
            {% endif %}
            {% if episode.cities %}
            {{ episode_association_display(user, obj, episode, episode.cities, obj.get_title("City")) }}
            {% endif %}
            {% if episode.regions %}
            {{ episode_association_display(user, obj, episode, episode.regions, obj.get_title("Region")) }}
            {% endif %}

        </div>
    </div>
</div>
{%- endmacro %}

{% macro episode_association_display(user, obj, episode, children, title) -%}
<h3 class='has-text-center'> {{title}} </h3>
<hr class='has-bg-muted'>
<div class="row">
    {% for a in children %}
    <div class="column is-2 is-mobile-6 episode-association-entry fade-it-in">
        <div class="row">
            <div class="column is-full">
                {{display_components.object_display(a, type=False, dim=250)}}
            </div>
            <div class="column is-full">
                <div class="row has-centered">
                    <div class="column is-shrink is-vertically-centered">
                        <a hx-post="/api/campaign/episode/{{episode.pk}}/association/{{a.path}}/delete"
                           hx-target="closest .episode-association-entry" hx-swap="delete"
                           hx-confirm="Are you sure you want to remove this association from the episode?">
                            <iconify-icon icon="mdi:remove" width="1rem"></iconify-icon>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{%- endmacro %}

{% macro association_dropdown(user, obj, episode, objs=[]) -%}
{% for o in objs %}
<li class="dropdown__link has-bg-muted">
    <a hx-post="/api/campaign/episode/{{episode.pk}}/associations/add/{{o.path}}"
       hx-target='#episode-associations'
       hx-select='#episode-associations' hx-swap='outerHTML'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
        <div class="row">
            <div class="column is-shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="column">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}


{% macro episode_gmplanner(user, obj, episode) -%}
<div class="row">
    <div class="column is-full">
        <div class="row has-centered">
            <div class="column is-shrink">
                <h3 class='has-text-center has-text-dark'>Episode Notes</h3>
            </div>
            <div class="column is-shrink">
                <a class="button is-small"
                   hx-post="/api/campaign/{{episode.campaign.pk}}/episode/{{episode.pk}}/gmplanner/addscene"
                   hx-target="#scenenotes-forms"
                   hx-select="#scenenotes-forms"
                   hx-swap='outerHTML'>
                    Add Scene
                </a>
            </div>
        </div>
        <span id="scenenotes-forms">
            {{ episode_scenenotes(user, obj, episode)}}
        </span>
    </div>
</div>
{%- endmacro %}

{% macro episode_scenenotes(user, obj, episode) %}
{% for scenenote in episode.scenenotes %}
<div class="panel" style='margin-bottom: 2rem;'>
    <div class="row">
        <div class="column is-full" onclick='this.nextElementSibling.classList.toggle("is-hidden")'>
            <div class="row">
                <div class="column">
                    <h4>{{scenenote.name}}</h4>
                </div>
                <div class="column is-shrink is-end">
                    <a
                       hx-post="/api/campaign/{{episode.campaign.pk}}/episode/{{episode.pk}}/scenenote/{{scenenote.pk}}/delete"
                       hx-target="closest .panel"
                       hx-swap="delete"
                       hx-confirm="Are you sure you want to delete this scene note?">
                        {{icon_components.delete(size="1rem")}}
                    </a>
                </div>
            </div>
        </div>
        <div class="column is-full is-hidden lower-it">
            <hr class='has-bg-muted'>
            <form hx-post="/api/campaign/{{episode.campaign.pk}}/episode/{{episode.pk}}/scenenote/{{scenenote.pk}}/update"
                  hx-swap='none'
                  hx-trigger='input delay:1s, change, end'>
                <div class="row">
                    <div class="column is-8">
                        <input class="has-bg-muted" type="text"
                               name="name"
                               value="{{scenenote.name}}">
                    </div>
                    <div class="column is-shrink is-vertically-centered">
                        <label>Scene Num: </label>
                    </div>
                    <div class="column">
                        <input class="has-bg-muted" type="number"
                               name="num"
                               value="{{scenenote.num}}">
                    </div>
                    <div class="column is-full">
                        <h5 class='has-text-center'>Scene Description</h5>
                        {{form_components.texteditor(user, scenenote, 'description', content=scenenote.description)}}
                    </div>
                    <div class="column is-full">
                        <h5 class='has-text-center'>General Notes</h5>
                        {{form_components.texteditor(user, scenenote, 'notes', content=scenenote.notes)}}
                    </div>
                </div>
            </form>
            <div class="row">
                <div class="column">
                    <hr class='has-bg-light'>
                    <h4 class='has-text-center'>Setting</h4>
                    <div class="row has-space-around">
                        <div class="column is-full">
                            <form hx-post="/api/campaign/{{episode.campaign.pk}}/episode/{{episode.pk}}/scenenote/{{scenenote.pk}}/setting/add"
                                  hx-target="#scenenotes-forms"
                                  hx-select="#scenenotes-forms"
                                  hx-swap='outerHTML'
                                  hx-trigger='input delay:1s, change'>
                                <div class="is-select has-bg-light">
                                    <select name='setting'>
                                        <option value=''>
                                            --Select Setting--
                                        </option>
                                        {% for setting in episode.places %}
                                        {% if setting not in scenenote.setting %}
                                        <option
                                                value='{{setting.model_name()}}--{{setting.pk}}'>
                                            {{setting.name}}
                                        </option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </form>
                        </div>
                        {% for a in scenenote.setting %}
                        <div class="screenote-setting column is-4">
                            {{display_components.object_display(a)}}
                            <div class="row has-centered">
                                <div class="column is-3"
                                     hx-post="/api/campaign/{{episode.campaign.pk}}/episode/{{episode.pk}}/scenenote/{{scenenote.pk}}/setting/remove"
                                     hx-target="closest .screenote-setting"
                                     hx-swap="delete"
                                     hx-vals='{"settingpk":"{{a.pk}}", "settingmodel":"{{a.model_name()}}"}'>
                                    <iconify-icon icon="mdi:remove" width="1rem">
                                    </iconify-icon>
                                </div>
                            </div>
                        </div>
                        {%endfor%}
                    </div>
                </div>
                <div class="column">
                    <hr class='has-bg-light'>
                    <h4 class=' has-text-center'>Encounters</h4>
                    <div class="row has-space-around">
                        <div class="column is-full">
                            <form hx-post="/api/campaign/{{episode.campaign.pk}}/episode/{{episode.pk}}/scenenote/{{scenenote.pk}}/encounter/add"
                                  hx-target="#scenenotes-forms"
                                  hx-select="#scenenotes-forms"
                                  hx-swap='outerHTML'
                                  hx-trigger='input delay:1s, change'>
                                <div class="is-select has-bg-light">
                                    <select name='encounter'>
                                        <option value=''>
                                            --Select Encounter--
                                        </option>
                                        {% for enc in episode.encounters %}
                                        {% if enc not in scenenote.encounters %}
                                        <option value='{{enc.pk}}'>
                                            {{enc.name}}
                                        </option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </form>
                        </div>
                        {% for a in scenenote.encounters %}
                        <div class="screenote-encounter column is-4">
                            {{display_components.object_display(a)}}
                            <div class="row has-centered">
                                <div class="column is-3"
                                     hx-post="/api/campaign/{{episode.campaign.pk}}/episode/{{episode.pk}}/scenenote/{{scenenote.pk}}/encounter/remove"
                                     hx-target="closest .screenote-encounter"
                                     hx-swap="delete"
                                     hx-vals='{"encounterpk":"{{a.pk}}"}'>
                                    <iconify-icon icon="mdi:remove" width="1rem">
                                    </iconify-icon>
                                </div>
                            </div>
                        </div>
                        {%endfor%}
                    </div>
                </div>
                <div class="column">
                    <hr class='has-bg-light'>
                    <h4 class='has-text-center'>Characters/Creatures</h4>
                    <div class="row has-space-around">
                        <div class="column is-full">
                            <form hx-post="/api/campaign/{{episode.campaign.pk}}/episode/{{episode.pk}}/scenenote/{{scenenote.pk}}/actor/add"
                                  hx-target="#scenenotes-forms"
                                  hx-select="#scenenotes-forms"
                                  hx-swap='outerHTML'
                                  hx-trigger='input delay:1s, change'>
                                <div class="is-select has-bg-light">
                                    <select name='actor'>
                                        <option value=''>
                                            --Select Character/Creature--
                                        </option>
                                        {% for enc in episode.actors %}
                                        {% if enc not in scenenote.actors %}
                                        <option value='{{enc.path}}'>
                                            {{enc.name}}
                                        </option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </form>
                        </div>
                        {% for a in scenenote.actors %}
                        <div class="screenote-encounter column is-4">
                            {{display_components.object_display(a)}}
                            <div class="row has-centered">
                                <div class="column is-3"
                                     hx-post="/api/campaign/{{episode.campaign.pk}}/episode/{{episode.pk}}/scenenote/{{scenenote.pk}}/actor/remove"
                                     hx-target="closest .screenote-encounter"
                                     hx-swap="delete"
                                     hx-vals='{"actor":"{{a.path}}"}'>
                                    <iconify-icon icon="mdi:remove" width="1rem">
                                    </iconify-icon>
                                </div>
                            </div>
                        </div>
                        {%endfor%}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{%- endmacro %}

{% macro episode_extras(user, obj, episode) %}
<div class="panel">
    <div id="episode-gn-generate" class="row">
        <div class="column is-full lower-it">
            <button type="submit" class="button has-bg-screen"
                    hx-post="/task/generate/campaign/episode/{{episode.pk}}/gn"
                    hx-target="#episode-gn-generate">
                Generate GN from Scenes
            </button>
        </div>
        <div class="column is-full lower-it">
            <h4>GN Panels</h4>
            <div class="row has-space-around">
                {% for i in episode.scenenotes %}
                <div id="gnimage-{{i.pk}}" class="column is-6" style='position:relative;'>

                    <div class="image">
                        {% if i.image %}
                        <img src='{{i.image.url()}}'>
                        {% endif %}
                    </div>

                    <button class="button is-small has-bg-screen"
                            style="position:absolute; top:5px; right:5px;"
                            hx-post="/api/campaign/episode/{{episode.pk}}/image/{{i.pk}}/regenerate"
                            hx-target="#gnimage-{{i.pk}}"
                            hx-select="#gnimage-{{i.pk}}"
                            hx-swap="outerHTML">
                        {{icon_components.regenerate()}}
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{%- endmacro %}

{% macro episode_generator(user, world, campaign) %}
<title>{{world.name | title}} - Auto GM</title>
<div class="row">
    <div id="autogm-scenario-container" class="column is-full">
        <form>
            <div class="row">
                <div class="column is-4">
                    {% if not campaign.party%}
                    <h5 class='has-text-primary'>Campaign must have a party</h5>
                    {%endif %}
                    <p class='has-text-primary'>Complete the campaign description to guide the
                        scenario</p>

                </div>
                <div class="column is-shrink is-end is-vertically-centered">
                    <button class='button'
                            hx-post='/task/generate/campaign/{{campaign.pk}}/outline'
                            {% if not campaign.party%} disabled {%endif %}>Generate
                        Campaign</button>
                </div>
            </div>
        </form>
        <div class="row">
            <div class="column is-full">
                {{ autogm_campaign_display(user, world, campaign) }}
            </div>
        </div>
    </div>
</div>
{%- endmacro %}


{% macro autogm_campaign_display(user, world, campaign) -%}
<div class="row">
    {%for scene in campaign.outline %}
    <div class="column is-full">
        <div class="panel">
            <div class="row has-space-between">
                <div class="column is-shrink">
                    <h3>{{scene.name}} - Act {{scene.act}} Session {{scene.scene}}</h3>
                </div>
                <div class="column is-shrink">
                    <small>{{scene.type}}</small>
                </div>
            </div>
            <form hx-post='/api/campaign/{{campaign.pk}}/outline/scene/{{scene.pk}}/update'
                  hx-trigger='input delay:1s, change'
                  hx-swap='none'>
                <div class="row">
                    <div class="column is-full">
                        <h5>Description</h5>
                        {{form_components.texteditor(user, scene, "description") }}
                    </div>
                    <div class="column is-full">
                        <h5>Scenario</h5>
                        {{form_components.texteditor(user, scene, "notes") }}
                    </div>
                </div>
            </form>
            <div class="row has-space-around">
                {% for o in scene.setting%}
                <div class="column is-2">
                    {{display_components.object_display(o)}}
                </div>
                {% endfor %}
                {% for o in scene.actors%}
                <div class="column is-2">
                    {{display_components.object_display(o)}}
                </div>
                {% endfor %}
                {% for o in scene.loot%}
                <div class="column  is-2">
                    {{display_components.object_display(o)}}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{%- endmacro %}