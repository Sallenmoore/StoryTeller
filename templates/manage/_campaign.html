{% import "shared/_form.html" as form_components %}
{% import "shared/_display.html" as display_components %}
{% import "shared/_icons.html" as icon_components %}
{% import "shared/_tasks.html" as task_components %}

{% macro manage(user, campaign) -%}
<title>{{campaign.name | title}} - Manage Campaign</title>
<div class="section small">
    <div class="callout">
        <div class="grid-x align-spaced">
            <div class="cell shrink">
                {% if campaign.start_date %}
                <h5>Began: {{campaign.start_date}}</h5>
                {% endif %}
            </div>
            <div class="cell shrink">
                {% if campaign.end_date %}
                <h5>Ended: {{campaign.end_date}}</h5>
                {% endif %}
            </div>
            <div class="cell shrink">
                <button class='button small' class="button"
                        hx-post="/task/generate/campaign/{{campaign.pk}}/summary"
                        hx-target='closest .cell'>
                    Update Summary
                </button>
            </div>
        </div>
    </div>
    <form hx-post="/campaign/{{campaign.pk}}/update" hx-swap='none'
          hx-trigger='input delay:0.5s'>
        <div class="grid-x grid-margin-x align-center-middle" id="current-campaign-name">
            <div class="cell shrink align-center-middle">
                <h4>Name</h4>
            </div>
            <div class="cell auto align-center-middle">
                <input type="text" name="name" value="{{campaign.name}}">
            </div>
            <div class="cell shrink align-center-middle">
                <h4>One-Shot</h4>
            </div>
            <div class="cell shrink align-center-middle">
                <select name="one_shot">
                    <option value="False" {% if not campaign.one_shot %} selected
                            {% endif %}>
                        No
                    </option>
                    <option value="True" {% if campaign.one_shot %} selected
                            {% endif %}>
                        Yes
                    </option>
                </select>
            </div>
            <hr>
        </div>
        <div class="callout">
            <div class="grid-x" id="current-campaign-description">
                <div class="cell">
                    <h3 class='text-center'>Description</h>
                        {{form_components.richtexteditor(user, campaign, 'description')}}
                </div>
            </div>
        </div>
    </form>
    <div class="callout">
        <h2>Party</h2>
        <div class="grid-x" id='campaign-players'>
            <div class="cell medium-3">
                <h4>Add Party</h4>
                <div class=" callout ">
                    <select name='party'
                            style='max-height: 20rem;'
                            hx-post=" /campaign/{{campaign.pk}}/add/party"
                            hx-target="#campaign-players" hx-select="#campaign-players"
                            hx-swap="outerHTML" hx-indicator='#request-indicator'>
                        <option value=''>
                            ---
                        </option>
                        {% for faction in campaign.world.parties%}
                        <option value='{{faction.pk}}' {% if faction==campaign.party %} selected
                                {%
                                endif %}
                                style='height:3rem; text-align: end; font: 1.25rem "Rosarivo", cursive;'>
                            {{faction.name}}
                        </option>
                        {% endfor %}
                    </select>
                    {% if campaign.party %}
                    <hr>
                    <h4 class='text-center'> Current Party </h4>
                    <div class="grid-x align-center">
                        <div class="cell medium-6">
                            {{display_components.object_display(campaign.party, dim=250, type=False)}}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="cell medium-9">
                <div class="callout">
                    <h5 class='text-center'>Players</h5>
                    <div class="grid-x align-spaced">
                        {% for p in campaign.players %}
                        <div class="cell medium-2 text-center">
                            {{display_components.object_display(p, dim=250, type=False)}}
                            <a
                               hx-post="/campaign/{{campaign.pk}}/removeplayer/{{p.pk}}"
                               hx-target="#campaign-players" hx-select="#campaign-players"
                               hx-swap="outerHTML" hx-indicator=' #request-indicator'
                               hx-confirm="Are you sure you want to remove this player from the campaign?">
                                {{icon_components.remove(size="1.5rem")}}
                            </a>
                        </div>
                        {% endfor%}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="section small">
        <div class="callout">
            <h2 class='text-center'> Associations </h2>
            {% for title in ['Locations', 'Characters', 'Creatures', 'Items', 'Factions'] %}
            {% set obj_key = title | lower %}
            {% if campaign[obj_key] %}
            <hr>
            <h3 class='text-center'> {{title}} </h3>
            <div class="grid-x grid-margin-x grid-margin-y align-spaced"
                 id="episode-encounters">
                {% for a in campaign[obj_key] %}
                <div class="cell medium-2 episode-association-entry">
                    {{display_components.object_display(a)}}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    <hr>
    <div class="grid-x">
        <div class="cell shrink is-center">
            <a hx-post="/campaign/{{campaign.pk}}/delete"
               hx-target="#page-content"
               hx-confirm='Are you sure you want to delete this campaign?'>
                {{icon_components.trash(size="1.5rem")}}
            </a>
        </div>
    </div>
</div>
{%- endmacro %}