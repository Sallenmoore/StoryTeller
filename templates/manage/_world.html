{% import "shared/_form.html" as form_components %}
{% import "shared/_display.html" as display_components %}
{% import "shared/_icons.html" as icon_components %}
{% import "shared/_history.html" as history_components %}
{% import "shared/_details.html" as details_components %}
{% import "shared/_timeline.html" as timeline_components %}
{% import "shared/_journal.html" as journal_components %}
{% import "shared/_stories.html" as stories_components %}
{% import "shared/_campaigns.html" as campaigns_components %}
{% import "shared/_associations.html" as associations_components %}
{% import "shared/_map.html" as map_components %}
{% import "shared/_jobs.html" as jobs_components %}
{% import "shared/_manage.html" as manage_components %}
{% import "models/_ability.html" as ability_model %}

{% macro manage(user, obj) -%}
{{manage_components.manage(user, obj)}}
{{manage_components.backstory(user, obj)}}
<div class="callout">
    <h3 class='text-center'>World Visual Styles</h3>
    <div class="grid-x grid-margin-x">
        <div class="cell medium-6">
            <label for="image_style">Image Style
                <input list="image_styles" type="text" name="image_style"
                       value="{{obj.image_style}}"
                       hx-post="/manage/update"
                       hx-trigger="change"
                       hx-swap="none"
                       placeholder="Image Style (e.g., illustrated, realistic, cartoon)">
                <datalist id="image_styles">
                    <option value="illustrated"></option>
                    <option value="realistic"></option>
                    <option value="cartoon"></option>
                    <option value="watercolor"></option>
                    <option value="oil painting"></option>
                    <option value="pixel art"></option>
                    <option value="sketch"></option>
                </datalist>
            </label>
        </div>
        <div class="cell medium-6">
            <label for="map_style">Map Style
                <input list="map_styles" type="text" name="map_style" value="{{obj.map_style}}"
                       hx-post="/manage/update"
                       hx-trigger="change"
                       hx-swap="none"
                       placeholder="Map Style (e.g., isometric, top-down, hand-drawn)">
                <datalist id="map_styles">
                    <option value="isometric"></option>
                    <option value="top-down"></option>
                    <option value="hand-drawn"></option>
                    <option value="satellite"></option>
                    <option value="detailed"></option>
                    <option value="minimalist"></option>
                </datalist>
            </label>
        </div>
    </div>
</div>
{{manage_components.image(user, obj)}}
<h3 class='text-center'>World Calendar Settings</h3>
<div class="grid-x grid-padding-x">
    <div class="cell">
        <form hx-post="/{{obj.path}}/calendar/update"
              hx-swap="none"
              hx-trigger="input delay:1s, change, submit" 7>
            <div class="grid-x">
                <div class="cell medium-4">
                    <div class="callout small">
                        <label>Epoch Name</label>
                        <input type="text" name="age"
                               value="{{obj.calendar.age}}">
                        <label>Number of Days / Year</label>
                        <input type="number"
                               name="num_days_per_year"
                               value="{{obj.calendar.days_per_year}}">
                        <hr>

                        <h4>Current Date</h4>
                        <p>{{obj.current_date}}</p>
                    </div>
                </div>
                <div class="cell auto">
                    <div id="calendar-label-lists-container" class="grid-x align-justify">
                        <div class="cell medium-5" id="month-names">
                            <label>Number of Months / Year</label>
                            <input type="number"
                                   id="month-names" name="month_names"
                                   value="{{obj.calendar.months | length}}"
                                   oninput='updateEntries(this);'>
                            <h4>Month Names</h4>
                            <div id="month-names-container">
                                {% for month in obj.calendar.months %}
                                <input class=" month-name-entry" type="text"
                                       name="month_names_list[]"
                                       value="{{month}}">
                                {% endfor %}
                            </div>
                        </div>
                        <div class="cell medium-5">
                            <label>Number of Days / Week</label>
                            <input type="number"
                                   id="day-names" name="day_names"
                                   oninput='updateEntries(this);'
                                   value="{{obj.calendar.days | length}}">
                            <h4>Day Names</h4>
                            <div id="day-names-container">
                                {% for day in obj.calendar.days %}
                                <input class=" day-name-entry" type="text"
                                       name="day_names_list[]"
                                       value="{{day}}">
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <script>
                        function updateEntries(input) {
                            let num = input.value;
                            let container = document.getElementById(input.id + "-container");
                            let children = container.children;
                            if (children.length < num) {
                                for (let i = children.length; i < num; i++) {
                                    let newEntry = document.createElement("input");
                                    newEntry.classList.add("");
                                    newEntry.classList.add(input.id.replace("_", "-") + "-entry");
                                    newEntry.setAttribute("type", "text");
                                    newEntry.setAttribute("name", `${input.name}_list[]`);
                                    container.appendChild(newEntry);
                                }
                            } else if (children.length > num) {
                                for (let i = children.length; i > num; i--) {
                                    container.removeChild(children[i - 1]);
                                }
                            }
                        }
                    </script>
                </div>
            </div>
        </form>
        <hr>
    </div>
</div>
<div class="callout">
    <h3 class='text-center'>Manage World Abilities and Features</h3>
    {{abilities(user, obj)}}
</div>
<div class="grid-x align-spaced">
    <div class="cell medium-4">
        <form id="change_system_form" hx-post="/{{obj.path}}/system/update"
              hx-target="#change_system_form"
              hx-select="#change_system_form"
              hx-swap="outerHTML"
              hx-confirm="By changing the system, all previous system data (skills, classes, and backgrounds) will be lost. Are you sure?">
            <div class="grid-x ">
                <div class="cell">
                    <h4>Change System</h4>
                    <div class="select">
                        <select name="system">
                            {% for k, v in obj.SYSTEMS.items() %}
                            <option value="{{k}}" {% if v==obj.system.__class__ %} selected {% endif
                                    %}>
                                {{k | title}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="cell">
                    <input class="button" type="submit" value="change">
                </div>
            </div>
        </form>
    </div>
</div>
<div class="grid-x">
    <div class="cell auto">
        <h4>Add Users</h4>
        <form id="add_user_form" hx-post="/manage/{{obj.path}}/user/add"
              hx-target="closest .row"
              hx-swap="outerHTML"
              hx-confirm="By adding this user, they will be able to make changes to the world. Are you sure?">
            <div class="grid-x is-vertical">
                <div class="cell">
                    <input type="email" name="new_user" id="new_user"
                           placeholder="enter user email">
                </div>
                <div class="cell">
                    <input class="button" type="submit" value="add">
                </div>
            </div>
        </form>
        <div class="callout small">
            <div class="grid-x">
                <div class="cell">
                    <h4>Users</h4>
                    <ul class="has-no-list-style" id="userlist">
                        {% for u in obj.users %}
                        <li>{{u.name}}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{%- endmacro %}

{% macro abilities(user, obj)%}
<div class="grid-x grid-margin-x align-spaced" id='ability-item-list'>
    {% for category in ["offensive", "defensive", "social", "support", "control", "movement",
    "none"]%}
    <div class="cell">
        <h4> {{category | title}} </h4>
        <ul class="accordion abilities" data-accordion data-multi-expand="true"
            data-allow-all-closed="true">
            {%for ability in obj.abilities | selectattr('category', 'equalto',
            category)%}
            <li id="ability_{{ability.pk}}" class="accordion-item" data-accordion-item>
                {{ability_model.ability_display(ability)}}
                {% if user.is_authenticated %}
                <div class="grid-x align-spaced">
                    <div class="cell shrink text-center">
                        <a
                           hx-post='/manage/ability/{{ability.pk}}/delete'
                           hx-target='#ability_{{ability.pk}}'
                           hx-swap='delete' hx-trigger="click consume"
                           hx-confirm='Are you sure you want to permanently delete ability"{{ability.name}}"? This will remove it from all associated objects and cannot be undone.'>
                            {{icon_components.delete(size="1.5rem")}}
                        </a>
                    </div>
                </div>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
    {%endfor %}
</div>
{%- endmacro %}