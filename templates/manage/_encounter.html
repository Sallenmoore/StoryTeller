{% import "shared/_form.html" as form_components %}
{% import "shared/_display.html" as display_components %}
{% import "shared/_icons.html" as icon_components %}
{% import "shared/_manage.html" as manage_components %}

{% macro manage(user, obj) -%}
<div class="grid-x">
    <div class="cell auto">
        <h2 class='text-center'>Details Editor</h2>
    </div>
    <div class="cell shrink float-right">
        <a href="/{{obj.path}}/details">
            {{icon_components.close(size="3rem")}}
        </a>
    </div>
</div>
<div class="grid-x align-spaced">
    <div class="cell shrink align-center-middle">
        <button class="button  has-text-white"
                hx-post="/task/generate/{{obj.path}}"
                hx-target="closest .cell"
                hx-confirm='Details can be generated from scratch, but works best if you add any required details to the {{obj.title}} first, such as name, brief history, or other  details'>
            {{icon_components.ai(size="1rem")}}
            Generate Details
        </button>
    </div>
    <div class="cell shrink align-center-middle">
        <button type="button" class="button small"
                hx-post='/api/manage/encounter/toevent'
                hx-target='#page-content'
                hx-confirm='Are you sure you want to convert this encounter to an event?'
                hx-trigger="click consume">
            {{icon_components.plus(size="1rem")}}
            Convert to Event
        </button>
    </div>
    <div class="cell shrink align-center-middle">
        <button class="button "
                hx-post="/api/manage/delete/{{obj.path}}"
                hx-target="#page-content"
                hx-confirm='Are you sure? This cannot be undone'>
            {{icon_components.delete(size="1rem")}}
            Delete
        </button>
    </div>
</div>
<hr>
<div class="grid-x align-spaced">
    <div class="cell medium-8">
        <form hx-post="/api/manage/update" hx-swap="none" hx-trigger="input delay:1s, change">
            <div class="grid-x grid-margin-x">
                <div class="cell auto">
                    <h5 class='text-center'>Name</h5>
                    <input id='model-name' class="text-center" type="text" name="name"
                           value="{{obj.name}}"
                           onload='document.title = this.value;document.getElementById("object-title").innerHTML = this.value;'
                           oninput='document.title = this.value;document.getElementById("object-title").innerHTML = this.value;'>
                </div>
                <div class="cell auto">
                    <h5 class='text-center'>Theme</h5>
                    <input class=" text-center" type="text" name="theme"
                           value="{{obj.theme}}" maxlength="64">
                </div>
            </div>
        </form>
    </div>
    <div class="cell shrink">
        <div class="grid-x">
            <div class="cell shrink align-center-middle">
                <h4>Story</h4>
            </div>
            <div class="cell align-center-middle">
                <div class="select">
                    <select class="has-bg-white" name='storypk'
                            hx-post='/api/manage/encounter/story'
                            hx-swap='none'
                            hx-trigger="change">
                        <option value="" {% if not obj.story %} selected {% endif
                                %}>-- No Story --</option>
                        {%for story in obj.world.stories %}
                        <option value="{{story.pk}}" {% if obj.story and story.pk==obj.story.pk
                                %} selected {% endif %}>
                            {{story.name}}
                        </option>
                        {%endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>
<form hx-post="/api/manage/update"
      hx-swap="none" hx-trigger="input delay:1s, change">
    <div class="grid-x">
        <div class="cell">
            <div class="grid-x grid-margin-x">
                <div class="cell auto">
                    <h5 class='text-center'>Encounter Type</h5>
                    <div class="is-select">
                        <select class="text-center"
                                name="encounter_type">
                            {% for k,v in obj._encounter_types.items() %}
                            <option value='{{k}}' {% if k==obj.encounter_type %} selected {% endif
                                    %}>{{k}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="cell auto">
                    <h5 class='text-center'>Difficulty</h5>
                    <div class="is-select">
                        <select class=" text-center"
                                name="difficulty">
                            {% for diff in obj.difficulty_list %}
                            <option value='{{diff}}' {% if diff==obj.difficulty %} selected {% endif
                                    %}>{{diff | title}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="cell medium-4">
                    <h5 class='text-center '>Enemy Type</h5>
                    <input type="text"
                           value="{{obj.enemy_type}}" name="enemy_type" style='width:100%;'>
                </div>
            </div>
        </div>
        <div class="cell" id="model-trigger">
            <h4 class="text-center">Trigger Conditions</h4>
            {{form_components.richtexteditor(user, obj, "trigger_conditions", label=False)}}
        </div>
        <div class="cell" id="model-mechanics">
            <h4 class="text-center">Mechanics</h4>
            {{form_components.richtexteditor(user, obj, "mechanics", label=False)}}
        </div>
        <div class="cell" id="model-notes">
            <h4 class="text-center">Notes</h4>
            {{form_components.richtexteditor(user, obj, "notes", label=False)}}
        </div>
        <div class="cell" id="model-outcomes">
            <h4 class="text-center">Potential Post Scenes</h4>
            <div class="grid-x is-vertical">
                <div class="cell shrink">
                    <button type="button" class="button small"
                            hx-post='/api/manage/add/listitem/post_scenes'
                            hx-target='#post_scenes-item-list'
                            hx-select='#post_scenes-item-list'
                            hx-swap='outerHTML' hx-trigger="click consume">
                        {{icon_components.plus(size="1rem")}}
                        New Post Scene
                    </button>
                </div>
            </div>
            {{form_components.listarea(user, obj, "post_scenes")}}
        </div>
        <div class="cell" id="model-complications">
            <h4 class="text-center">Complications</h4>
            {{form_components.richtexteditor(user, obj, "complications", label=False)}}
        </div>
    </div>
</form>
{{manage_components.backstory(user, obj)}}
{{manage_components.image(user, obj)}}
{%- endmacro %}