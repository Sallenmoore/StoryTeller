{% import "shared/_form.html" as form_components %}
{% import "shared/_display.html" as display_components %}
{% import "shared/_icons.html" as icon_components %}


{% macro manage(user, story) -%}
<form hx-post="/api/story/{{story.pk}}/update" hx-swap='none' hx-push-url='false'
      hx-trigger='input delay:0.5s'>
    <div class="row has-space-between">
        <div class="column is-full has-text-secondarybg">
            <div class="row has-space-around">
                <div class="column is-shrink is-vertically-centered">
                    <h4>Name</h4>
                </div>
                <div class="column is-half is-vertically-centered">
                    <input class="has-bg-light" type="text" name="name"
                           value="{{story.name}}">
                </div>
                <div class="column is-vertically-centered is-shrink">
                    <div class="is-select">
                        <select class="has-bg-light" name='scope'>
                            <option value="local" {%if story.scope=="local" %}selected{%endif%}>
                                Local</option>
                            <option value='regional' {%if story.scope=="regional"
                                    %}selected{%endif%}>Regional</option>
                            <option value='global' {%if story.scope=="global" %}selected{%endif%}>
                                Global</option>
                        </select>
                    </div>
                </div>
                <div class="column is-shrink is-vertically-centered">
                    <button class="button"
                            hx-post='/task/generate/story/{{story.pk}}'
                            hx-swap='outerHTML'
                            hx-trigger="click consume"
                            hx-confirm="Are you sure you want to re-generate the story? This will overwrite existing content.">
                        Generate
                    </button>
                </div>
            </div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="column is-full has-text-secondary">
            <h3 class='has-text-center'>Situation</h3>
            {{form_components.texteditor(user, story, 'situation')}}
        </div>
        <div class="column is-full has-text-secondary">
            <h3 class='has-text-center'>Backstory</h3>
            {{form_components.texteditor(user, story, 'backstory')}}
        </div>
        <div class="column is-full has-text-secondary">
            <h3 class='has-text-center'>Current Status</h3>
            {{form_components.texteditor(user, story, 'current_status')}}
        </div>
        <div class="column is-4 has-text-secondary">
            <h3 class='has-text-center'>Tasks</h3>
            <div class="row is-vertical">
                <div class="column is-shrink">
                    <button type="button" class="button is-small"
                            hx-post='/api/story/{{story.pk}}/add/listitem/tasks'
                            hx-target='#tasks-item-list'
                            hx-select='#tasks-item-list'
                            hx-swap='outerHTML' hx-trigger="click consume">
                        {{icon_components.plus(size="1rem")}}
                        New Task
                    </button>
                </div>
            </div>
            {{form_components.listarea(user, story, 'tasks')}}
        </div>
        <div class="column is-4 has-text-secondary">
            <h3 class='has-text-center'>Rumors</h3>
            <div class="row is-vertical">
                <div class="column is-shrink">
                    <button type="button" class="button is-small"
                            hx-post='/api/story/{{story.pk}}/add/listitem/rumors'
                            hx-target='#rumors-item-list'
                            hx-select='#rumors-item-list'
                            hx-swap='outerHTML' hx-trigger="click consume">
                        {{icon_components.plus(size="1rem")}}
                        New Rumor
                    </button>
                </div>
            </div>
            {{form_components.listarea(user, story, 'rumors')}}
        </div>
        <div class="column is-4 has-text-secondary">
            <h3 class='has-text-center'>Information</h3>
            <div class="row is-vertical">
                <div class="column is-shrink">
                    <button type="button" class="button is-small"
                            hx-post='/api/story/{{story.pk}}/add/listitem/information'
                            hx-target='#information-item-list'
                            hx-select='#information-item-list'
                            hx-swap='outerHTML' hx-trigger="click consume">
                        {{icon_components.plus(size="1rem")}}
                        New information
                    </button>
                </div>
            </div>
            {{form_components.listarea(user, story, 'information')}}
        </div>
    </div>
</form>
<hr class='has-bg-primary'>
<div class="row">
    <div id="story-bbeg" class="column is-2 has-text-secondary">
        <h3 class='has-text-center'>BBEG</h3>
        <div class="row">
            <div class="column is-full">
                <div class="has-dropdown" style="width: 100%;">
                    <input class="has-bg-light" autocomplete="off" type="search" name="query"
                           style="border-bottom: solid #000;"
                           hx-post="/api/story/{{story.pk}}/bbeg/add/search"
                           hx-target="#story-new-bbeg-list"
                           hx-trigger="input changed delay:500ms consume"
                           hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
                    <ul class="dropdown has-bg-light" id="story-new-bbeg-list">
                    </ul>
                </div>
            </div>
        </div>
        {% if story.bbeg %}
        {{display_components.object_display(story.bbeg)}}
        {% endif %}
    </div>
    <div id="story-encounters" class="column is-9 has-text-secondary">
        <h3 class='has-text-center'>Planned Encounters</h3>
        <div class="row has-space-around">
            {% for encounter in story.encounters %}
            <div class="column is-2">{{display_components.object_display(encounter)}}</div>
            {% endfor %}
        </div>
    </div>
</div>
<hr class='has-bg-muted'>
<div id="story-events" class="section is-small">
    <div class="panel">
        <h2 class='has-text-center'> Events </h2>
        <div class="row">
            <div class="column search is-half is-vertically-centered">
                <div class="has-dropdown" style="width: 100%;">
                    <input class="has-bg-light" autocomplete=off type="search" name="query"
                           placeholder="Search to Add Events..."
                           style="border-bottom: solid #000;" hx-target="#event-search"
                           hx-post="/api/{{story.path}}/event/add/search"
                           hx-push-url='false'
                           hx-trigger="input delay:750ms, search"
                           hx-on:input="this.value.length < 1 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
                    <ul class="dropdown autocomplete-list has-bg-light" id="event-search">
                    </ul>
                </div>
            </div>
            <div class="column is-shrink is-end">
                <button class='button has-bg-muted'
                        hx-post='/api/{{story.path}}/event/add'
                        hx-target="#story-events-list"
                        hx-select="#story-events-list"
                        hx-swap='outerHTML'>
                    Add New Event
                </button>
            </div>
        </div>
        <div id="story-events-list" class="row has-space-around">
            {% for e in story.events %}
            <div class="column is-3">
                <a href="/{{e.path}}">
                    <div class="panel has-bg-muted">
                        <div class="row">
                            <div class="column is-full">
                                <h5 class="has-text-center">{{e.name}}</h5>
                            </div>
                            <div class="column is-full">
                                <h6 class="has-text-center">{{e.start_date}} - {{e.end_date}}</h6>
                            </div>
                            <div class="column">
                                {{e.impact | safe}}
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<hr class='has-bg-muted'>
<div class="row">
    <div class="column is-shrink is-vertically-centered">
        <h4 class='has-text-center'>Merge Story</h4>
        <div class="is-select" style="width: 100%;">
            <select class="has-bg-light" name="mergepk"
                    hx-post="/api/story/{{story.pk}}/merge"
                    hx-target="#page-content"
                    hx-push-url='false'
                    hx-trigger="change"
                    hx-confirm="Are you sure you want to merge another story into this one? This will overwrite existing content and delete the other story.">
                <option value="" selected disabled> === Select Story to Merge Into This One ===
                </option>
                {% for s in story.world.stories %}
                {% if s.pk != story.pk %}
                <option value="{{s.pk}}">{{s.name}}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="column is-shrink is-end">
        <h4 class='has-text-center'>Delete Story</h4>
        <a hx-post="/api/story/{{story.pk}}/delete"
           hx-target="#page-content"
           hx-confirm='Are you sure you want to delete this story?'>
            {{icon_components.trash(size="1.5rem")}}
        </a>
    </div>
</div>
{%- endmacro %}

{% macro bbeg_dropdown(user, obj, story, objs=[]) -%}
{% for o in objs %}
<li class="dropdown__link has-bg-muted">
    <a hx-post="/api/story/{{story.pk}}/bbeg/add/{{o.pk}}"
       hx-target='#story-bbeg'
       hx-select='#story-bbeg' hx-swap='outerHTML'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
        <div class="row">
            <div class="column is-shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="column">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}

{% macro associations_dropdown(user, story, objs=[]) -%}
{% for o in objs %}
<li class="dropdown__link has-bg-muted">
    <a hx-post="/api/story/{{story.pk}}/associations/add/{{o.path}}"
       hx-target='#story-associations'
       hx-select='#story-associations' hx-swap='outerHTML'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
        <div class="row">
            <div class="column is-shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="column">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}

{% macro events_dropdown(user, story, events=[]) -%}
{% for o in events %}
<li class="dropdown__link has-bg-muted">
    <a hx-post="/api/story/{{story.pk}}/event/add/{{o.pk}}"
       hx-target='#story-events-list'
       hx-select='#story-events-list' hx-swap='outerHTML'
       hx-push-url='false'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
        <div class="row">
            <div class="column is-shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="column">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}