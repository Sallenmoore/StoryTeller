{% import "shared/_form.html" as form_components %}
{% import "shared/_display.html" as display_components %}
{% import "shared/_icons.html" as icon_components %}


{% macro manage(user, story) -%}
<form hx-post="/api/story/{{story.pk}}/update" hx-swap='none' hx-push-url='false'
      hx-trigger='input delay:0.5s'>
    <div class="grid-x align-justify">
        <div class="cell bg">
            <div class="grid-x align-spaced">
                <div class="cell shrink align-center-middle">
                    <h4>Name</h4>
                </div>
                <div class="cell medium-6 align-center-middle">
                    <input type="text" name="name"
                           value="{{story.name}}">
                </div>
                <div class="cell align-center-middle shrink">
                    <div class="is-select">
                        <select name='scope'>
                            <option value="local" {%if story.scope=="local" %}selected{%endif%}>
                                Local</option>
                            <option value='regional' {%if story.scope=="regional"
                                    %}selected{%endif%}>Regional</option>
                            <option value='global' {%if story.scope=="global" %}selected{%endif%}>
                                Global</option>
                        </select>
                    </div>
                </div>
                <div class="cell shrink align-center-middle">
                    <button class="button"
                            hx-post='/task/generate/story/{{story.pk}}'
                            hx-swap='outerHTML'
                            hx-trigger="click consume"
                            hx-confirm="Are you sure you want to re-generate the story? This will overwrite existing content.">
                        Generate
                    </button>
                    <hr>
                    <button class="button"
                            hx-post='/task/generate/story/{{story.pk}}/summary'
                            hx-swap='outerHTML'
                            hx-trigger="click consume"
                            hx-confirm="Are you sure you want to re-generate the history? This will overwrite the existing history.">
                        Summarize
                    </button>
                </div>
            </div>
        </div>
    </div>
    <hr>
    <div class="grid-x">
        <div class="cell ">
            <h3 class='text-center'>Situation</h3>
            {{form_components.texteditor(user, story, 'situation')}}
        </div>
        <div class="cell ">
            <h3 class='text-center'>Backstory</h3>
            {{form_components.texteditor(user, story, 'backstory')}}
        </div>
        <div class="cell ">
            <h3 class='text-center'>Current Status</h3>
            {{form_components.texteditor(user, story, 'current_status')}}
        </div>
        <div class="cell medium-4 ">
            <h3 class='text-center'>Tasks</h3>
            <div class="grid-x is-vertical">
                <div class="cell shrink">
                    <button type="button" class="button small"
                            hx-post='/api/story/{{story.pk}}/add/listitem/tasks'
                            hx-target='#tasks-item-list'
                            hx-select='#tasks-item-list'
                            hx-swap='outerHTML' hx-trigger="click consume">
                        {{icon_components.plus(size="1rem")}}
                        New Task
                    </button>
                </div>
            </div>
            {{form_components.listarea(user, story, 'tasks')}}
        </div>
        <div class="cell medium-4 ">
            <h3 class='text-center'>Rumors</h3>
            <div class="grid-x is-vertical">
                <div class="cell shrink">
                    <button type="button" class="button small"
                            hx-post='/api/story/{{story.pk}}/add/listitem/rumors'
                            hx-target='#rumors-item-list'
                            hx-select='#rumors-item-list'
                            hx-swap='outerHTML' hx-trigger="click consume">
                        {{icon_components.plus(size="1rem")}}
                        New Rumor
                    </button>
                </div>
            </div>
            {{form_components.listarea(user, story, 'rumors')}}
        </div>
        <div class="cell medium-4 ">
            <h3 class='text-center'>Information</h3>
            <div class="grid-x is-vertical">
                <div class="cell shrink">
                    <button type="button" class="button small"
                            hx-post='/api/story/{{story.pk}}/add/listitem/information'
                            hx-target='#information-item-list'
                            hx-select='#information-item-list'
                            hx-swap='outerHTML' hx-trigger="click consume">
                        {{icon_components.plus(size="1rem")}}
                        New information
                    </button>
                </div>
            </div>
            {{form_components.listarea(user, story, 'information')}}
        </div>
    </div>
</form>
<hr>
<div class="grid-x">
    <div id="story-bbeg" class="cell medium-2 ">
        <h3 class='text-center'>BBEG</h3>
        <div class="grid-x">
            <div class="cell">
                <input autocomplete="off" type="search" name="query"
                       style="border-bottom: solid #000;"
                       hx-post="/api/story/{{story.pk}}/bbeg/add/search"
                       hx-target="#story-new-bbeg-list"
                       hx-trigger="input changed delay:500ms consume"
                       hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
                <ul class="dropdown menu" data-dropdown-menu id="story-new-bbeg-list">
                </ul>
            </div>
        </div>
        {% if story.bbeg %}
        {{display_components.object_display(story.bbeg)}}
        {% endif %}
    </div>
    <div id="story-encounters" class="cell is-9 ">
        <h3 class='text-center'>Planned Encounters</h3>
        <div class="grid-x align-spaced">
            {% for encounter in story.encounters %}
            <div class="cell medium-2">{{display_components.object_display(encounter)}}</div>
            {% endfor %}
        </div>
    </div>
</div>
<hr>
<div id="story-events" class="section small">
    <div class="callout">
        <h2 class='text-center'> Events </h2>
        <div class="grid-x">
            <div class="cell search medium-6 align-center-middle">
                <input autocomplete=off type="search" name="query"
                       placeholder="Search to Add Events..."
                       style="border-bottom: solid #000;" hx-target="#event-search"
                       hx-post="/api/{{story.path}}/event/add/search"
                       hx-push-url='false'
                       hx-trigger="input delay:750ms, search"
                       hx-on:input="this.value.length < 1 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
                <ul class="dropdown menu autocomplete-list" data-dropdown-menu
                    id="event-search">
                </ul>
            </div>
            <div class="cell shrink">
                <button class='button '
                        hx-post='/api/{{story.path}}/event/add'
                        hx-target="#story-events-list"
                        hx-select="#story-events-list"
                        hx-swap='outerHTML'>
                    Add New Event
                </button>
            </div>
        </div>
        <div id="story-events-list" class="grid-x align-spaced">
            {% for e in story.events %}
            <div class="cell medium-3">
                <a href="/{{e.path}}">
                    <div class="callout ">
                        <div class="grid-x">
                            <div class="cell">
                                <h5 class="text-center">{{e.name}}</h5>
                            </div>
                            <div class="cell">
                                <h6 class="text-center">{{e.start_date}} - {{e.end_date}}</h6>
                            </div>
                            <div class="cell">
                                {{e.impact | safe}}
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<hr>
<div class="grid-x">
    <div class="cell shrink align-center-middle">
        <h4 class='text-center'>Merge Story</h4>
        <div class="is-select" style="width: 100%;">
            <select name="mergepk"
                    hx-post="/api/story/{{story.pk}}/merge"
                    hx-target="#page-content"
                    hx-push-url='false'
                    hx-trigger="change"
                    hx-confirm="Are you sure you want to merge another story into this one? This will overwrite existing content and delete the other story.">
                <option value="" selected disabled> === Select Story to Merge Into This One ===
                </option>
                {% for s in story.world.stories %}
                {% if s.pk != story.pk %}
                <option value="{{s.pk}}">{{s.name}}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="cell shrink">
        <h4 class='text-center'>Delete Story</h4>
        <a hx-post="/api/story/{{story.pk}}/delete"
           hx-target="#page-content"
           hx-confirm='Are you sure you want to delete this story?'>
            {{icon_components.trash(size="1.5rem")}}
        </a>
    </div>
</div>
{%- endmacro %}

{% macro bbeg_dropdown(user, obj, story, objs=[]) -%}
{% for o in objs %}
<li class="dropdown__link ">
    <a hx-post="/api/story/{{story.pk}}/bbeg/add/{{o.pk}}"
       hx-target='#story-bbeg'
       hx-select='#story-bbeg' hx-swap='outerHTML'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
        <div class="grid-x">
            <div class="cell shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="cell">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}

{% macro associations_dropdown(user, story, objs=[]) -%}
{% for o in objs %}
<li class="dropdown__link ">
    <a hx-post="/api/story/{{story.pk}}/associations/add/{{o.path}}"
       hx-target='#story-associations'
       hx-select='#story-associations' hx-swap='outerHTML'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
        <div class="grid-x">
            <div class="cell shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="cell">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}

{% macro events_dropdown(user, story, events=[]) -%}
{% for o in events %}
<li class="dropdown__link ">
    <a hx-post="/api/story/{{story.pk}}/event/add/{{o.pk}}"
       hx-target='#story-events-list'
       hx-select='#story-events-list' hx-swap='outerHTML'
       hx-push-url='false'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
        <div class="grid-x">
            <div class="cell shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="cell">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}