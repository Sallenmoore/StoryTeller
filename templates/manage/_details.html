{% import "shared/_form.html" as form_components %}
{% import "shared/_icons.html" as icon_components %}

{% macro details(user, obj) -%}
<div class="row">
    <div class="column is-center">
        <h2 class='has-text-dark'>Details Editor</h2>
    </div>
    <div class="column is-shrink is-float-right">
        <a class='has-text-dark' href="/{{obj.path}}/details">
            {{icon_components.close(size="3rem")}}
        </a>
    </div>
</div>

<div id="object-info" class="grid-x grid-padding-x">
    <div class="cell small-12"><h1>{{obj.name or obj.title}}</h1></div>

    <div class="cell small-12">
        <button class="button" hx-post="/task/generate/{{obj.path}}"
                hx-target="closest .column"
                hx-confirm='Details can be generated from scratch, but works best if you add any required details to the {{obj.title}} first, such as name, brief history, or other  details'>
            {{icon_components.ai(size="1em")}} AI - Generate Details
        </button>
        <button class="button" hx-post="/task/generate/history/{{obj.path}}"
                hx-target="closest .column">
            {{icon_components.update(size="1em")}} AI - Generate History
        </button>
    </div>

    <div class="story cell small-12 medium-7">
        <form hx-post="/api/manage/update" hx-swap="none" hx-trigger="input delay:1s, change">
        <label>Name
            <input id='model-name' type="text" name="name"
            value="{{obj.name}}"
            onload='document.title = this.value;document.getElementById("object-title").innerHTML = this.value;'
            oninput='document.title = this.value;document.getElementById("object-title").innerHTML = this.value;'>
        </label>

        <label>Theme / Traits
            <input type="text" name="traits" value="{{obj.traits}}" maxlength="64">
        </label>

        <div class="grid-x">
            <div class="cell medium-5">
                <label>Start Date</label>
                <div class="input-group">
                    <input name="start_date.day" type="number" placeholder='day' value="{{obj.start_date.day}}">
                    <select name="start_date.month">
                        {% for m in obj.get_world().calendar.months %}
                        <option class="has-text-center" value='{{m}}' 
                        {% if loop.index0==obj.start_date.month %} selected {% endif %}>
                            {{m}}
                        </option>
                        {% endfor %}
                    </select>
                 <input name="start_date.year" class="year" type="number" placeholder='year' value="{{obj.start_date.year}}">
                </div>
            </div>
            <div class="cell medium-5 medium-offset-2">
                <label>End Date</label>
                <div class="input-group">
                    <input name="end_date.day" type="number" placeholder='day' value="{{obj.end_date.day}}">
                    <select name="end_date.month">
                        {% for m in obj.get_world().calendar.months %}
                        <option class="has-text-center" value='{{m}}' 
                        {% if loop.index0==obj.end_date.month %} selected {% endif %}>
                            {{m}}
                        </option>
                        {% endfor %}
                    </select>
                 <input name="end_date.year" class="year" type="number" placeholder='year' value="{{obj.end_date.year}}">
                </div>
            </div>
        </form>
        </div>

        <form hx-post="/api/manage/update" hx-swap="none" hx-trigger="input delay:1s, change">
            <h3>Backstory</h3>
            {{form_components.richtexteditor(user, obj, 'backstory')}}
        </form>

    </div>
    <div class="related-panel cell small-12 medium-4 large-offset-1">
        {% if obj.image %}
            <a href="#manage-image"><img src="{{obj.image.url(size='large')}}" alt="{{obj.name}}" /></a>
        {% endif %}
        {{obj.snippet(user, 'manage_details') | safe}}
    </div>

</div>


<div class="row has-space-around">
    {% if obj.model_name() in ['Character'] and obj.is_player %}
    <div class="column is-shrink is-vertically-centered">
        <div style='position:relative;'>
            <button class="button has-bg-muted has-text-primary"
                    hx-post="/api/manage/character/{{obj.pk}}/dndbeyond"
                    hx-target="#page-content" {% if not obj.dnd_beyond_id %} disabled {% endif
                    %}
                    hx-indicator="#request-indicator">
                Updates from D&DBeyond
            </button>
            {% if not obj.dnd_beyond_id %}
            <small class="has-text-center is-very-small-heading has-text-secondary has-bg-muted"
                   style='position:absolute;top:0; left: 0;'>Must be a 'player' and have
                DnDBeyond ID set</small>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
<hr>

<!-- edit object extended details -->
{{obj.snippet(user, 'manage_extended_details') | safe}}
<hr>

<!-- edit image -->
{{image(user, obj)}}
<hr>

<!-- delete object-->
<button class="button"
        hx-post="/api/manage/delete/{{obj.path}}"
        hx-confirm="Are you sure you want to delete this {{obj.title}}?"
        onclick="location.href = '/world/{{obj.get_world().pk}}'">
    {{icon_components.trash(size="1.5rem")}} Delete {{obj.name}}
</button>

{%- endmacro %}

{% macro image(user, obj) -%}
<h2 id="image-editor">Image Editor</h2>
<div id="object-info" class="grid-x grid-padding-x">
    <div class="cell medium-8" id="model-owner-image">
        {% if obj.image %}
        <div class="image">
            <img src="{{obj.image.url()}}" alt="{{obj.name}}" />
        </div>
        {% else %}
        <div hx-post="/api/manage/{{obj.path}}"
             hx-trigger='load delay:5s' hx-target="#model-owner-image"
             hx-select="#model-owner-image" hx-swap="outerHTML">
            No Image
        </div>
        {% endif %}
    </div>
    <div class="cell medium-4">
        <h3>Image Description <sup>(editable)</sup></h3>

        <p id="model-desc" class="has-text-dark" contentEditable="true"
            hx-post="/api/manage/update" hx-trigger="input delay:1s"
            hx-vals="js:{description:strip_html(htmx.find('#model-desc').innerHTML)}"
            hx-swap="none">
            {{obj.desc | striptags}}
        </p>

        <button class="button"
            hx-post="/task/generate/image/{{obj.path}}" hx-target="closest .column"
            hx-indicator="#request-indicator"
            hx-confirm="Are you sure you want to generate and overwrite the current image?">
            {{icon_components.ai(size="1rem")}} Generate New AI Image
        </button>

        <button class="button" 
            hx-post="/api/manage/image/gallery"
            hx-target="#model-owner-image" 
            hx-swap="innerHTML">
            {{icon_components.random(size="1rem")}} Select From Gallery
        </button>

        <form hx-post="/api/manage/update" hx-select='#image-manage-container'
            hx-target="#image-manage-container" hx-swap="outerHTML"
            hx-confirm="Are you sure you want to upload and overwrite the current image?">

            <button class="button" type="submit">{{icon_components.link(size="1rem")}} Upload from URL</button>
            <input type="url" name="image" placeholder="enter url..." />
        </form>
    </div>
</div>
{%- endmacro%}

{%macro imagegallery(user, obj, images) -%}
<div class="panel has-bg-primary">
    <div class="row has-space-around">
        {% for image in images%}
        <div class="column is-shrink has-text-center has-centered">
            <div class="image is-medium is-thumbnail is-margin-center" style="cursor: pointer">
                <img src="{{image.url(size=100)}}" alt="{{image.tags | join(', ')}}"
                     hx-post="/api/manage/update"
                     hx-target="#image-manage-container" hx-select="#image-manage-container"
                     hx-swap="outerHTML"
                     hx-vals='{"image":"{{image.pk}}"}'
                     hx-indicator="#request-indicator" />
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{%- endmacro %}