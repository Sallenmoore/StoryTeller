{% import "shared/_form.html" as form_components %}
{% import "shared/_icons.html" as icon_components %}
{% import "shared/_display.html" as display_components %}

{% macro manage(user, episode) -%}
<div class="row fade-it-in" id='campaign-episode-container'>
    <div id='episode-details' class="column">
        {% if episode %}
        <div class="row has-space-around">
            <div class="column">
                <div class="panel has-bg-muted has-text-dark generated-text-lightbg"
                     style='position:relative;'>
                    {{episode.summary | safe}}
                    <button class='button is-small' class="button is-primary"
                            style='position: absolute; top:0px; right:0px;'
                            hx-post="/task/generate/campaign/episode/{{episode.pk}}/summary"
                            hx-target='closest .column'>
                        Update Summary
                    </button>
                </div>
            </div>
        </div>
        <hr>
        <form hx-post="/api/episode/{{episode.pk}}/update"
              hx-swap='none'
              hx-trigger='input delay:1s, change'>
            <div class="row">
                <div class="column is-6">
                    <h4 class='has-text-center has-text-dark'>Name</h4>
                    <input class="has-bg-light has-text-center" type="text" name="name"
                           value="{{episode.name}}">
                </div>
                <div class="column is-6">
                    <h4 class='has-text-center has-text-dark'>Episode Number</h4>
                    <input class="has-bg-light has-text-center" type="number"
                           name="episode_num"
                           value="{{episode.episode_num}}">
                </div>
            </div>
            <div class="row has-centered" style='position:relative;'>
                <div class="column is-shrink is-vertically-centered">
                    <h5 class='has-text-center has-text-dark'>Start</h5>
                </div>
                <div
                     class="column is-1 has-no-padding has-no-margin is-vertically-centered">
                    <input class="has-text-center" type="number"
                           name="start_date.day"
                           placeholder='day'
                           value="{{episode.start_date.day}}">
                </div>
                <div
                     class="column is-shrink  has-no-padding has-no-margin is-vertically-centered">
                    <div class="is-select" style='position:relative;top: -2px;'>
                        <select name="start_date.month">
                            {% for m in episode.world.calendar.months %}
                            <option class="has-text-center" value='{{m}}' {% if
                                    loop.index0==episode.start_date.month %}
                                    selected {% endif %}>
                                {{m}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div
                     class="column is-2 has-no-padding has-no-margin is-vertically-centered">
                    <input class="has-text-center" type="number"
                           name="start_date.year"
                           placeholder='year'
                           value="{{episode.start_date.year}}">
                </div>
                <div class="column is-shrink  is-vertically-centered">
                    {{icon_components.dash()}}
                </div>
                <div
                     class="column is-1 has-no-padding has-no-margin is-vertically-centered">
                    <input class="has-text-center" type="number"
                           name="end_date.day"
                           placeholder='day'
                           value="{{episode.end_date.day}}">
                </div>
                <div
                     class="column is-shrink  has-no-padding has-no-margin is-vertically-centered">
                    <div class="is-select" style='position:relative;top: -2px;'>
                        <select name="end_date.month">
                            {% for m in episode.world.calendar.months %}
                            <option class="has-text-center" value='{{m}}' {% if
                                    loop.index0==episode.end_date.month %}
                                    selected {% endif %}>
                                {{m}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div
                     class="column is-2 has-no-padding has-no-margin is-vertically-centered">
                    <input class="has-text-center" type="number"
                           name="end_date.year"
                           placeholder='year'
                           value="{{episode.end_date.year}}">
                </div>
                <div class="column is-shrink  is-vertically-centered">
                    <h5 class='has-text-center has-text-dark'>End</h5>
                </div>
            </div>
        </form>
        <div class="row">
            <div id="episode-manage-container" class="column is-full fade-it-in">
                {{episode_report(user, episode)}}
            </div>
        </div>
        <div class="row ">
            <div class="column is-end is-shrink">
                <button class="button is-light has-text-dark"
                        hx-post="/api/episode/{{episode.pk}}/delete"
                        hx-target="#page-content"
                        hx-confirm='Are you sure you want to delete this Episode?'>
                    {{icon_components.trash(size="1rem")}}
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{%- endmacro %}

{% macro episode_report(user, episode) -%}
<div class="row">
    <div class="column is-8">
        <form hx-post="/api/episode/{{episode.pk}}/update"
              hx-swap='none'
              hx-trigger='input delay:1s, change'>
            <div class="row has-space-around">
                <div class="column is-shrink">
                    <div class="panel has-bg-muted">
                        <div class="row">
                            <div class="column is-shrink is-vertically-centered">
                                <h4>Associated Story</h4>
                            </div>
                            <div class="column is-vertically-centered">
                                <div class="select">
                                    <select class="has-bg-white" name='storypk'>
                                        <option value="" {% if not episode.story %} selected {%
                                                endif
                                                %}>-- No Story --</option>
                                        {%for story in episode.world.stories %}
                                        <option value="{{story.pk}}" {% if episode.story and
                                                story.pk==episode.story.pk
                                                %} selected {% endif %}>
                                            {{story.name}}
                                        </option>
                                        {%endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tabs">
                <ul class="tabs__list has-centered has-text-screen">
                    <li class='is-active'><a>Report</a></li>
                    <li><a>Loot</a></li>
                    <li><a>Hooks</a></li>
                    <li><a>Planning</a></li>
                </ul>
            </div>
            <hr>
            <script>
                const tabs = document.querySelectorAll('.tabs ul li a');
                tabs.forEach((tab) => {
                    tab.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetText = tab.textContent.trim().toLowerCase();
                        document.querySelectorAll('#episode-report-container, #episode-loot-container, #episode-planning-container, #episode-hooks-container').forEach((container) => {
                            if (container.id.includes(targetText)) {
                                container.classList.remove('is-hidden');
                                container.classList.add('is-active');
                            } else {
                                container.classList.add('is-hidden');
                                container.classList.remove('is-active');
                            }
                        });
                    });
                });
            </script>
            <div id="episode-planning-container" class="fade-it-in is-hidden">
                <h3 class='has-text-center'>Planning</h3>
                {{form_components.texteditor(user, episode, 'description')}}
            </div>
            <div id="episode-report-container" class="fade-it-in">
                <h3 class='has-text-center'>Report</h3>
                {{form_components.texteditor(user, episode, 'episode_report')}}
            </div>
            <div id="episode-loot-container" class="fade-it-in  is-hidden">
                <hr class='has-bg-muted'>
                <h3 class='has-text-center'>Loot</h3>
                {{form_components.texteditor(user, episode, 'loot')}}
            </div>
            <div id="episode-hooks-container" class="fade-it-in is-hidden">
                <hr class='has-bg-muted'>
                <h3 class='has-text-center'>Hooks</h3>
                {{form_components.texteditor(user, episode, 'hooks')}}
            </div>
        </form>
    </div>
    <div id="episode-events" class="column is-4">
        <hr class='has-bg-muted'>
        <h3 class='has-text-center'>Events</h3>
        <div class="row has-space-around">
            {% for event in episode.events %}
            <div class="column is-4">
                {{display_components.object_display(event, type=False)}}
            </div>
            {% endfor %}
        </div>
        <div class="row">
            <div class="column">
                <div class="has-dropdown" style="width: 100%;">
                    <input class="has-bg-light" autocomplete="off" type="search" name="query"
                           placeholder='Search Events to Add'
                           style="border-bottom: solid #000;"
                           hx-post="/api/{{episode.path}}/events/add/search"
                           hx-target="#episode-new-events-list"
                           hx-trigger="input changed delay:500ms consume"
                           hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')"
                           onclick="this.closest('.has-dropdown').classList.remove('is-active')">
                    <ul class="dropdown has-bg-light" id="episode-new-events-list">
                    </ul>
                </div>
            </div>
            <div class="column">
                <button class='button is-small is-fullwidth is-primary'
                        hx-post='/api/{{episode.path}}/event/generate'
                        hx-target='#page-content'>
                    Generate Event From Episode
                </button>
            </div>
        </div>
        <hr class='has-bg-muted'>
        <h3 class='has-text-center'>Manage Associations</h3>
        {{associations(user, episode)}}
    </div>
</div>
{%- endmacro %}


{% macro associations(user, episode) -%}
<div id="episode-associations" class="row">
    <div class="column fade-it-in">
        <h5 class='has-text-primary'>Add New...</h5>
        <div class="row has-space-around">
            {% for model in episode.world.all_models_str() %}
            <div class="column is-shrink">
                <button class='button is-small'
                        hx-post='/api/episode/{{episode.pk}}/associations/add/{{model | lower}}'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-vals='{"episodepk":"{{episode.pk}}"}'
                        hx-swap='outerHTML'>
                    {{episode.world.get_title(model)}}
                </button>
            </div>
            {% endfor %}
        </div>
        <h5 class='has-text-primary'>...or Add Existing</h5>
        <div class="row has-space-around">
            <div class="column is-shrink">
                <button class='button is-primary is-small'
                        hx-post='/api/episode/{{episode.pk}}/associations/add/campaignassociations'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-vals='{"episodepk":"{{episode.pk}}"}'
                        hx-swap='outerHTML'>
                    All Campaign Associations
                </button>
            </div>
            <div class="column is-shrink">
                <button class='button is-primary is-small'
                        hx-post='/api/episode/{{episode.pk}}/associations/add/episodeassociations'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-vals='{"episodepk":"{{episode.pk}}"}'
                        hx-swap='outerHTML'>
                    Previous Episode Associations
                </button>
            </div>
            <div class="column is-shrink">
                <button class='button is-primary is-small'
                        hx-post='/api/episode/{{episode.pk}}/associations/add/players'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-vals='{"episodepk":"{{episode.pk}}"}'
                        hx-swap='outerHTML'>
                    players
                </button>
            </div>
            <div class="column is-half">
                <div class="has-dropdown" style="width: 100%;">
                    <input class="has-bg-light" autocomplete="off" type="search" name="query"
                           style="border-bottom: solid #000;"
                           hx-post="/api/episode/{{episode.pk}}/associations/add/search"
                           hx-target="#episode-new-associations-list"
                           hx-trigger="input changed delay:500ms consume"
                           hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
                    <ul class="dropdown has-bg-light" id="episode-new-associations-list">
                    </ul>
                </div>
            </div>
        </div>
        <hr>
        <div class="panel has-bg-screen">
            {% if episode.encounters %}
            {{ association_display(user, episode, episode.encounters, episode.world.get_title("Encounter")) }}
            {% endif %}
            {% if episode.locations %}
            {{ association_display(user, episode, episode.locations, episode.world.get_title("Location")) }}
            {% endif %}
            {% if episode.shops %}
            {{ association_display(user, episode, episode.shops, episode.world.get_title("Shop")) }}
            {% endif %}
            {% if episode.districts %}
            {{ association_display(user, episode, episode.districts, episode.world.get_title("District")) }}
            {% endif %}
            {% if episode.characters %}
            {{ association_display(user, episode, episode.characters, episode.world.get_title("Character")) }}
            {% endif %}
            {% if episode.creatures %}
            {{ association_display(user, episode, episode.creatures, episode.world.get_title("Creature")) }}
            {% endif %}
            {% if episode.items %}
            {{ association_display(user, episode, episode.items, episode.world.get_title("Item")) }}
            {% endif %}
            {% if episode.vehicles %}
            {{ association_display(user, episode, episode.vehicles, episode.world.get_title("Vehicle")) }}
            {% endif %}
            {% if episode.factions %}
            {{ association_display(user, episode, episode.factions, episode.world.get_title("Faction")) }}
            {% endif %}
            {% if episode.cities %}
            {{ association_display(user, episode, episode.cities, episode.world.get_title("City")) }}
            {% endif %}
            {% if episode.regions %}
            {{ association_display(user, episode, episode.regions, episode.world.get_title("Region")) }}
            {% endif %}

        </div>
    </div>
</div>
{%- endmacro %}

{% macro association_display(user, episode, children, title) -%}
<h3 class='has-text-center'> {{title}} </h3>
<hr class='has-bg-muted'>
<div class="row">
    {% for a in children %}
    <div class="column is-2 is-mobile-6 episode-association-entry fade-it-in"
         style='position:relative;'>
        {{display_components.object_display(a, type=False, dim=250)}}
        <a style='position:absolute; top:0px; right:5px;'
           hx-post="/api/episode/{{episode.pk}}/association/{{a.path}}/delete"
           hx-target="closest .episode-association-entry" hx-swap="delete"
           hx-confirm="Are you sure you want to remove this association from the episode?">
            <iconify-icon class="has-bg-muted" icon="mdi:remove" width="1rem"></iconify-icon>
        </a>
    </div>
    {% endfor %}
</div>
{%- endmacro %}

{% macro association_dropdown(user, episode, objs=[]) -%}
{% for o in objs %}
<li class="dropdown__link has-bg-muted">
    <a hx-post="/api/episode/{{episode.pk}}/associations/add/{{o.path}}"
       hx-target='#episode-associations'
       hx-select='#episode-associations' hx-swap='outerHTML'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
        <div class="row">
            <div class="column is-shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="column">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}

{% macro events_dropdown(user, episode, objs=[]) -%}
{% for o in objs %}
<li class="dropdown__link has-bg-muted">
    <a hx-post="/api/episode/{{episode.pk}}/events/add/{{o.pk}}"
       hx-target='#episode-events'
       hx-select='#episode-events' hx-swap='outerHTML'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
        <div class="row">
            <div class="column is-shrink">
                <div class="image is-tiny is-thumbnail" style="cursor: pointer">
                    {% if o.image %}
                    <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" />
                    {% endif %}
                </div>
            </div>
            <div class="column">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}