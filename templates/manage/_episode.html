{% import "shared/_form.html" as form_components %}
{% import "shared/_icons.html" as icon_components %}
{% import "shared/_display.html" as display_components %}
{% import "shared/_manage.html" as manage_components %}
{% import "shared/_associations.html" as associations_components%}

{% macro manage(user, episode) -%}
<form hx-post="/api/episode/{{episode.pk}}/update" hx-swap="none"
      hx-trigger="input delay:1s, change">
    <div id="episode-manage" class="grid-x grid-padding-x">
        <div class="story cell small-12 medium-8">
            {% if episode %}

            <div class="grid-x">
                <div class="cell small-1">
                    <label>No.
                        <input type="number" name="episode_num" value="{{episode.episode_num}}">
                    </label>
                </div>
                <div class="cell small-11">
                    <label>Name
                        <input id="model-name" type="text" name="name"
                               value="{{episode.name}}"
                               onload='document.title = this.value;document.getElementById("object-title").innerHTML = this.value;'
                               oninput='document.title = this.value;document.getElementById("object-title").innerHTML = this.value;'>
                    </label>
                </div>
            </div>
            <h3>Report</h3>
            {{form_components.richtexteditor(user, episode, 'episode_report')}}
            <!-- display AI Generative buttons -->
            <div id="ai-buttons" class="grid-x grid-padding-x align-right">
                <div class="cell small-shrink large-shrink">
                    <button class="button"
                            hx-post="/task/generate/campaign/episode/{{episode.pk}}/summary"
                            hx-target="closest .cell"
                            hx-confirm='Details can be generated from scratch, but works best if you add any required details to the episode first, such as name, brief history, or other  details'>
                        {{icon_components.ai(size="1rem")}}
                        Update Summary (AI Generated)
                    </button>
                </div>
                <div class="cell small-shrink large-shrink">
                    <button class="button"
                            hx-post="/task/generate/campaign/episode/{{episode.pk}}/summary"
                            hx-target="closest .cell"
                            hx-confirm='Details can be generated from scratch, but works best if you add any required details to the episode first, such as name, brief history, or other  details'>
                        {{icon_components.ai(size="1rem")}}
                        Update Summary (AI Generated)
                    </button>
                </div>
            </div>
            <hr>
            <h3>Loot</h3>
            {{form_components.texteditor(user, episode, 'loot')}}
            <hr>
            <h3>Hooks</h3>
            {{form_components.texteditor(user, episode, 'hooks')}}

        </div>
        <div class="related-panel cell small-12 medium-4">
            <!-- replace this with link -->
            {{ display_components.dsp_object_image(episode,'400') }}

            <h2>Dates</h2>
            {{ manage_components.dates (user, episode) }}

            <h2>Associations</h2>
            {{associations(user, episode)}}

            <p>Manage</p>
            <button class="button is-light has-text-dark"
                    hx-post="/api/campaign/episode/{{episode.pk}}/delete"
                    hx-target="#details-container"
                    hx-select="#details-container"
                    hx-swap="outerHTML"
                    hx-confirm='Are you sure you want to delete this Episode?'>
                {{icon_components.trash(size="1rem")}}
            </button>
            {% endif %}
        </div>
    </div>

</form>
{%- endmacro %}

{% macro episode_report(user, episode) -%}
<div class="grid-x">
    <div class="cell medium-8">
        <div class="grid-x align-spaced">
            <div class="cell shrink">
                <div class="callout ">
                    <div class="grid-x">
                        <div class="cell shrink align-center-middle">
                            <h4>Add Associated Stories</h4>
                        </div>
                        <div class="cell align-center-middle">
                            <div class="select">
                                <select class="has-bg-white" name='storypk'
                                        hx-post="/api/{{episode.path}}/stories/add"
                                        hx-target="#episode-stories-list"
                                        hx-select="#episode-stories-list"
                                        hx-swap="outerHTML"
                                        hx-confirm="Are you sure you want to add this story to the episode?">>
                                    <option value=""></option>
                                    {%for story in episode.world.stories %}
                                    {% if story not in episode.stories %}
                                    <option value="{{story.pk}}">
                                        {{story.name}}
                                    </option>
                                    {% endif %}
                                    {%endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="cell">
                        <div id="episode-stories-list" class="grid-x">
                            {% for story in episode.stories %}
                            <div class="cell medium-2 episode-story-entry"
                                 style="position: relative;">
                                {{display_components.object_display(story, type=False)}}
                                <a style='position:absolute; top:0px; right:5px;'
                                   hx-post="/api/{{episode.path}}/stories/{{story.pk}}/delete"
                                   hx-trigger="click consume"
                                   hx-target="closest .episode-story-entry" hx-swap="delete"
                                   hx-confirm="Are you sure you want to remove this story from the episode?">
                                    <iconify-icon class="" icon="mdi:remove"
                                                  width="1rem"></iconify-icon>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <form hx-post="/api/episode/{{episode.pk}}/update"
              hx-swap='none'
              hx-trigger='input delay:1s, change'>
            <div class="tabs">
                <ul class="tabs__list has-centered ">
                    <li class='is-active'><a>Report</a></li>
                    <li><a>Loot</a></li>
                    <li><a>Hooks</a></li>
                    <li><a>Planning</a></li>
                </ul>
            </div>
            <hr>
            <script>
                const tabs = document.querySelectorAll('.tabs ul li a');
                tabs.forEach((tab) => {
                    tab.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetText = tab.textContent.trim().toLowerCase();
                        document.querySelectorAll('#episode-report-container, #episode-loot-container, #episode-planning-container, #episode-hooks-container').forEach((container) => {
                            if (container.id.includes(targetText)) {
                                container.classList.remove('is-hidden');
                                container.classList.add('is-active');
                            } else {
                                container.classList.add('is-hidden');
                                container.classList.remove('is-active');
                            }
                        });
                    });
                });
            </script>
            <div id="episode-planning-container" class=" is-hidden">
                <h3 class='text-center'>Planning</h3>
                {{form_components.texteditor(user, episode, 'description')}}
            </div>
            <div id="episode-report-container" class="">
                <div class="grid-x has-centered">
                    <div class="cell shrink">
                        <h3 class='text-center'>Report</h3>
                    </div>
                    <div class="cell shrink">
                        <button class='button small'
                                hx-post='/task/generate/campaign/episode/{{episode.pk}}/report'>
                            Punch Up Report
                        </button>
                    </div>
                </div>
                {{form_components.texteditor(user, episode, 'episode_report')}}
            </div>
            <div id="episode-loot-container" class="  is-hidden">
                <hr class=''>
                <h3 class='text-center'>Loot</h3>
                {{form_components.texteditor(user, episode, 'loot')}}
            </div>
            <div id="episode-hooks-container" class=" is-hidden">
                <hr class=''>
                <h3 class='text-center'>Hooks</h3>
                {{form_components.texteditor(user, episode, 'hooks')}}
            </div>
        </form>
    </div>
    <div id="episode-events" class="cell medium-4">
        <hr class=''>
        <h3 class='text-center'>Events</h3>
        <div class="grid-x align-spaced">
            {% for event in episode.events %}
            <div class="cell medium-4">
                {{display_components.object_display(event, type=False)}}
            </div>
            {% endfor %}
        </div>
        <div class="grid-x">
            <div class="cell">
                <input class="" autocomplete="off" type="search" name="query"
                       placeholder='Search Events to Add'
                       style="border-bottom: solid #000;"
                       hx-post="/api/{{episode.path}}/events/add/search"
                       hx-target="#episode-new-events-list"
                       hx-trigger="input changed delay:500ms consume"
                       hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')"
                       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
                <ul class="dropdown menu" data-dropdown-menu id="episode-new-events-list">
                </ul>
            </div>
            <div class="cell">
                <button class='button smallwidth'
                        hx-post='/api/{{episode.path}}/event/generate'
                        hx-target='#page-content'>
                    Generate Event From Episode
                </button>
            </div>
        </div>
        <hr class=''>
        <h3 class='text-center'>Manage Associations</h3>
        {{associations(user, episode)}}
    </div>
</div>
{%- endmacro %}


{% macro associations(user, episode) -%}
<div id="episode-associations" class="grid-x">
    <div class="cell">
        <h5 class=''>Add New...</h5>
        <div class="grid-x align-spaced">
            {% for model in episode.world.all_models_str() %}
            <div class="cell shrink">
                <button class='button small'
                        hx-post='/api/episode/{{episode.pk}}/associations/add/{{model | lower}}'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-vals='{"episodepk":"{{episode.pk}}"}'
                        hx-swap='outerHTML'>
                    {{episode.world.get_title(model)}}
                </button>
            </div>
            {% endfor %}
        </div>
        <h5 class=''>...or Add Existing</h5>
        <div class="grid-x align-spaced">
            <div class="cell shrink">
                <button class='button small'
                        hx-post='/api/episode/{{episode.pk}}/associations/add/campaignassociations'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-vals='{"episodepk":"{{episode.pk}}"}'
                        hx-swap='outerHTML'>
                    All Campaign Associations
                </button>
            </div>
            <div class="cell shrink">
                <button class='button small'
                        hx-post='/api/episode/{{episode.pk}}/associations/add/episodeassociations'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-vals='{"episodepk":"{{episode.pk}}"}'
                        hx-swap='outerHTML'>
                    Previous Episode Associations
                </button>
            </div>
            <div class="cell shrink">
                <button class='button small'
                        hx-post='/api/episode/{{episode.pk}}/associations/add/players'
                        hx-target="#episode-associations"
                        hx-select="#episode-associations"
                        hx-trigger='click consume'
                        hx-vals='{"episodepk":"{{episode.pk}}"}'
                        hx-swap='outerHTML'>
                    players
                </button>
            </div>
            <div class="cell medium-6">
                <input class="" autocomplete="off" type="search" name="query"
                       style="border-bottom: solid #000;"
                       hx-post="/api/episode/{{episode.pk}}/associations/add/search"
                       hx-target="#episode-new-associations-list"
                       hx-trigger="input changed delay:500ms consume"
                       hx-on:input="this.value.length < 3 ? this.closest('.has-dropdown').classList.remove('is-active'):this.closest('.has-dropdown').classList.add('is-active')">
                <ul class="dropdown menu" data-dropdown-menu id="episode-new-associations-list">
                </ul>
            </div>
        </div>
        <hr>
        <div class="callout">
            {% if episode.encounters %}
            {{ association_display(user, episode, episode.encounters, episode.world.get_title("Encounter")) }}
            {% endif %}
            {% if episode.locations %}
            {{ association_display(user, episode, episode.locations, episode.world.get_title("Location")) }}
            {% endif %}
            {% if episode.shops %}
            {{ association_display(user, episode, episode.shops, episode.world.get_title("Shop")) }}
            {% endif %}
            {% if episode.districts %}
            {{ association_display(user, episode, episode.districts, episode.world.get_title("District")) }}
            {% endif %}
            {% if episode.characters %}
            {{ association_display(user, episode, episode.characters, episode.world.get_title("Character")) }}
            {% endif %}
            {% if episode.creatures %}
            {{ association_display(user, episode, episode.creatures, episode.world.get_title("Creature")) }}
            {% endif %}
            {% if episode.items %}
            {{ association_display(user, episode, episode.items, episode.world.get_title("Item")) }}
            {% endif %}
            {% if episode.vehicles %}
            {{ association_display(user, episode, episode.vehicles, episode.world.get_title("Vehicle")) }}
            {% endif %}
            {% if episode.factions %}
            {{ association_display(user, episode, episode.factions, episode.world.get_title("Faction")) }}
            {% endif %}
            {% if episode.cities %}
            {{ association_display(user, episode, episode.cities, episode.world.get_title("City")) }}
            {% endif %}
            {% if episode.regions %}
            {{ association_display(user, episode, episode.regions, episode.world.get_title("Region")) }}
            {% endif %}

        </div>
    </div>
</div>
{%- endmacro %}

{% macro association_display(user, episode, children, title) -%}
<h3 class='text-center'> {{title}} </h3>
<hr class=''>
<div class="grid-x">
    {% for a in children %}
    <div class="cell medium-2 is-mobile-6 episode-association-entry"
         style='position:relative;'>
        {{display_components.object_display(a, type=False, dim=250)}}
        <a style='position:absolute; top:0px; right:5px;'
           hx-post="/api/episode/{{episode.pk}}/association/{{a.path}}/delete"
           hx-target="closest .episode-association-entry" hx-swap="delete"
           hx-confirm="Are you sure you want to remove this association from the episode?">
            <iconify-icon class="" icon="mdi:remove" width="1rem"></iconify-icon>
        </a>
    </div>
    {% endfor %}
</div>
{%- endmacro %}

{% macro association_dropdown(user, episode, objs=[]) -%}
{% for o in objs %}
<li class="dropdown__link ">
    <a hx-post="/api/episode/{{episode.pk}}/associations/add/{{o.path}}"
       hx-target='#episode-associations'
       hx-select='#episode-associations' hx-swap='outerHTML'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
        <div class="grid-x">
            <div class="cell shrink">
                {% if o.image %}
                <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" style="cursor: pointer" />
                {% endif %}
            </div>
            <div class="cell">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}

{% macro events_dropdown(user, episode, objs=[]) -%}
{% for o in objs %}
<li class="dropdown__link ">
    <a hx-post="/api/episode/{{episode.pk}}/events/add/{{o.pk}}"
       hx-target='#episode-events'
       hx-select='#episode-events' hx-swap='outerHTML'
       onclick="this.closest('.has-dropdown').classList.remove('is-active')">
        <div class="grid-x">
            <div class="cell shrink">
                {% if o.image %}
                <img src="{{o.image.url(size=50)}}" alt="{{o.name}}" style="cursor: pointer" />
                {% endif %}
            </div>
            <div class="cell">
                {{o.name}}
            </div>
        </div>
    </a>
</li>
{% endfor %}
{%- endmacro%}