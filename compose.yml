services:
  stapp:
    image: ${APP_NAME}:latest
    build:
      context: .
    working_dir: /var/app
    env_file: .env
    container_name: ${APP_NAME}
    networks:
      - default # The application's default network
      - db_net  # The network created by the database stack
    volumes:
      - ./app:/var/app/
      - ./models:/var/app/models/
      - ./static:/var/app/static/
      - ./templates:/var/app/templates/
      - ./filters:/var/app/filters/
      - ./tests:/var/app/tests/
      - ./logs:/var/app/logs/
      - ./vendor/package.json:/var/app/package.json
    command: ["/var/app/init.sh"]
    ports:
      - "${APP_PORT}:${COMM_PORT}"
    depends_on:
      - ${API_SERVICE_NAME}
  stapi:
    image: ${APP_NAME}_api:latest
    build:
      context: .
    working_dir: /var/app
    env_file: .env
    container_name: ${APP_NAME}_api
    networks:
      - default # The application's default network
      - db_net  # The network created by the database stack
    volumes:
      - ./api:/var/app/
      - ./models:/var/app/models/
      - ./static:/var/app/static/
      - ./templates:/var/app/templates/
      - ./filters:/var/app/filters/
      - ./tests:/var/app/tests/
      - ./logs:/var/app/logs/
      - ./vendor/package.json:/var/app/package.json
    command: ["gunicorn", "app:create_app()", "-c/var/gunicorn.conf.py"]
    ports:
      - "${API_PORT}:${COMM_PORT}"
  sttasks:
    image: ${APP_NAME}_tasks:latest
    build:
      context: .
    working_dir: /var/app
    env_file: .env
    container_name: ${APP_NAME}_tasks
    networks:
      - default # The application's default network
      - db_net  # The network created by the database stack
    volumes:
      - ./tasks:/var/app/
      - ./models:/var/app/models/
      - ./static:/var/app/static/
      - ./tests:/var/app/tests/
      - ./filters:/var/app/filters/
      - ./templates:/var/app/templates/
      - ./logs:/var/app/logs/
      - ./vendor/package.json:/var/app/package.json
    command: ["gunicorn", "app:create_app()", "-c/var/gunicorn.conf.py"]
networks:
  default:
    name: ${APP_NAME}_net
  db_net:
    external: true